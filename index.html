<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITAL NEXUS</title>
    <meta name="monetag" content="a41ceca9ffc67edad031c0024f85ef59">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #14b8a6; /* Teal */
            --secondary-color: #8b5cf6; /* Purple */
            --gradient-start: var(--primary-color);
            --gradient-end: var(--secondary-color);
            --card-border-color: #e5e7eb;
            --card-hover-border-color: rgba(20, 184, 166, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        input, textarea, #mail-details-content, #mail-purchase-history .font-mono, #profile-id-btn {
            -webkit-user-select: text; /* Safari */
            -ms-user-select: text; /* IE 10+ */
            user-select: text; /* Standard syntax */
            -webkit-touch-callout: default;
        }
        #header-profile-pic, #profile-pic, #header-initials-avatar, #profile-initials-avatar {
            pointer-events: none;
        }
        .card-bg {
            background-color: #ffffff;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-bg:hover {
            border-color: var(--card-hover-border-color);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .text-accent-gradient {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn, .btn-gradient, .btn-outline-accent {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
            border: none;
            cursor: pointer;
        }
        .btn:active, .btn-gradient:active, .btn-outline-accent:active { transform: scale(0.96); }
        .btn-gradient {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: #ffffff;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.2);
        }
        .btn-gradient:hover {
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.3);
            background-image: linear-gradient(to right, var(--gradient-end), var(--gradient-start));
        }
        .input-field {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #1f2937;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.3);
            outline: none;
        }
        .main-page { display: none; }
        .main-page.active { display: flex; animation: fadeIn 0.5s ease-in-out; }
        .sub-page { display: none; }
        .sub-page.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        .bottom-nav {
             border-top: 1px solid #e0e0e0;
             background-color: rgba(255, 255, 255, 0.85);
             backdrop-filter: blur(12px);
             -webkit-backdrop-filter: blur(12px);
             position: fixed;
             bottom: 0;
             left: 0;
             right: 0;
             max-width: 672px;
             margin: 0 auto;
             display: flex;
             justify-content: space-around;
             align-items: center;
             padding: 12px 16px;
             z-index: 50;
        }
        .nav-link-main { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #6b7280; font-size: 0.75rem; font-weight: 500; padding: 8px; border-radius: 12px; transition: all 0.2s ease; position: relative; cursor: pointer; background: none; border: none; }
        .nav-link-main:hover { color: #333333; }
        .nav-link-main.active { color: var(--primary-color); }
        .nav-link-main .icon { width: 24px; height: 24px; }
        .center-home-link {
            position: relative; transform: translateY(-20px) scale(1.1);
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            border-radius: 50%; width: 64px; height: 64px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(20, 184, 166, 0.4); transition: all 0.3s ease; color: #ffffff;
        }
        .center-home-link:hover { transform: translateY(-20px) scale(1.15); }
        .center-home-link .icon { width: 32px; height: 32px; color: #fff; }
        .header {
            border-bottom: 1px solid #e0e0e0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Banner & Marquee */
        .banner-wrapper { position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        .banner-inner { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1); }
        .slide { min-width: 100%; position: relative; }
        .slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .dots { position: absolute; bottom: 12px; width: 100%; text-align: center; z-index: 10; }
        .dot { display: inline-block; height: 8px; width: 8px; margin: 0 4px; background: rgba(255,255,255,0.6); border-radius: 50%; cursor: pointer; transition: all 0.3s; }
        .dot.active { background: var(--primary-color); width: 24px; }
        .marquee {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white; padding: 8px 0; white-space: nowrap; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        #loader { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1.5rem; transition: opacity 0.5s ease; background-color: #f9fafb;}
        #loader .logo-container { animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards, breath 2.5s ease-in-out infinite 1s; }
        #loader .loader-text { animation: fadeInText 1s ease-in-out 0.5s forwards; opacity: 0; font-weight: bold; font-size: 1.5rem; }
        #loader-reviews { position: absolute; bottom: 30px; font-size: 0.9rem; color: #6b7280; opacity: 0; transition: opacity 0.5s ease-in-out; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeInText { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .premium-loader-spinner {
            width: 56px; height: 56px; border-radius: 50%;
            background: conic-gradient(#0000 10%, var(--primary-color));
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 9px), #000 0);
            animation: spin 1s infinite linear;
        }
        .loading-container { display: flex; justify-content: center; align-items: center; padding: 2.5rem; }
        @keyframes spin { to { transform: rotate(1turn); } }

        .premium-title {
            background: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; padding: 0 4px;
        }
    </style>
</head>
<body class="max-w-md mx-auto">

    <div id="loader" class="fixed inset-0 z-[100]">
        <div class="text-center">
            <div class="logo-container">
                 <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--primary-color)] mx-auto">
                    <path d="M10.66 10.34a6 6 0 1 0 7.07-7.07"/>
                    <path d="M13.34 13.66a6 6 0 1 0-7.07 7.07"/>
                    <path d="M10.66 13.66a6 6 0 1 0 0-3.32"/>
                    <path d="M13.34 10.34a6 6 0 1 0 0 3.32"/>
                </svg>
            </div>
            <h1 class="text-accent-gradient loader-text mt-4">DIGITAL NEXUS</h1>
        </div>
        <div id="loader-reviews">"খুবই বিশ্বস্ত একটি সাইট।" - মোঃ রায়হান</div>
    </div>

    <!-- All other modals and the main app structure from the original file would go here -->
    <!-- For brevity, I'll only include the main structure and JS changes -->
    <div id="app-container" class="min-h-screen flex-col main-page">
        <!-- =========== HEADER =========== -->
        <header class="header flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <img id="header-profile-pic" class="w-12 h-12 rounded-full border-2 border-teal-300 object-cover hidden" src="" alt="Profile Picture">
                    <div id="header-initials-avatar" class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-teal-300"><span id="header-initials" class="text-xl font-bold text-gray-500"></span></div>
                </div>
                <div>
                    <h1 id="header-welcome-name" class="text-lg font-bold text-gray-800">স্বাগতম!</h1>
                    <p id="header-balance-display" class="font-semibold text-gray-700 text-sm">৳0.00</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="header-deposit-btn" class="btn-gradient px-4 py-2 rounded-full text-sm font-bold shadow-lg">ডিপোজিট</button>
                <button id="notification-btn" class="relative p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i data-lucide="bell" class="w-5 h-5 text-gray-700"></i>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                <button id="hamburger-menu-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                    <i data-lucide="menu" class="w-5 h-5 text-gray-700"></i>
                </button>
            </div>
        </header>
        <!-- =========== END OF HEADER =========== -->

        <main class="flex-grow pb-20">
            <div id="home-page" class="space-y-6 sub-page">
                <div class="p-4">
                    <div class="banner-wrapper">
                        <div class="banner-inner" id="slides">
                             <div class="slide active"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://placehold.co/1080x720/14b8a6/ffffff/png?text=Promotion+1" alt="Slide 1"></a></div>
                            <div class="slide"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://placehold.co/1080x720/8b5cf6/ffffff/png?text=Offer+For+You" alt="Slide 2"></a></div>
                            <div class="slide"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://placehold.co/1080x720/f43f5e/ffffff/png?text=Join+Us" alt="Slide 3"></a></div>
                        </div>
                        <div class="dots" id="dots"></div>
                    </div>
                </div>
                <div class="p-4 space-y-6">
                    <div class="card-bg p-5 rounded-xl text-center">
                        <p class="text-gray-600 text-sm mb-1">আপনার বর্তমান ব্যালেন্স</p>
                        <p id="balance-display" class="text-4xl font-bold text-[#333333] mb-4">৳0.00</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="navigateTo('mail-page')" class="w-full p-3 rounded-lg font-bold border-2 border-teal-600 text-teal-600 hover:bg-teal-50 transition-colors btn">প্রোডাক্ট কিনুন</button>
                            <button id="home-deposit-btn" class="w-full p-3 rounded-lg btn-gradient">টাকা যোগ করুন</button>
                        </div>
                    </div>
                    <div id="ads-section" class="space-y-3" style="display: none;">
                        <h2 class="text-xl font-bold px-2 premium-title">✨ Promotions</h2>
                        <div>
                            <script src='//libtl.com/sdk.js' data-zone='10056357' data-sdk='show_10056357'></script>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pay-page" class="p-4 space-y-6 sub-page">
                <h2 class="text-xl font-bold text-center text-gray-800">ফান্ডিং হাব</h2>
                <div class="card-bg p-5 rounded-xl space-y-5">
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-lg flex items-center gap-2"><i data-lucide="wallet" class="w-6 h-6 text-[var(--primary-color)]"></i><span>ডিপোজিট করুন</span></h3>
                            <button id="deposit-details-btn" class="btn-outline-accent px-3 py-1 rounded-lg text-sm">বিস্তারিত</button>
                        </div>
                         <p class="text-lg font-semibold text-gray-700 mb-4 text-center p-3 rounded-lg border border-dashed border-teal-500/50 bg-teal-500/10">নিচের নাম্বারে <span class="text-teal-600 animate-pulse">সেন্ডমানি</span> করুন</p>
                        <!-- Payment methods remain the same -->
                        <div class="grid grid-cols-2 gap-3 mb-5">
                            <div class="bg-gray-100 p-3 rounded-lg text-center"><img src="https://i.postimg.cc/Jh9s6jWw/20250922-113350.png" alt="Nagad" class="w-10 h-10 rounded-full mx-auto mb-2"><p class="font-bold text-md">নগদ</p><p class="text-gray-600 font-mono tracking-wider text-sm my-1">01864260513</p><button onclick="copyToClipboard('01864260513', this)" class="w-full text-xs p-1 mt-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors flex items-center justify-center gap-1"><i data-lucide="copy" class="w-3 h-3"></i><span>কপি</span></button></div>
                            <div class="bg-gray-100 p-3 rounded-lg text-center"><img src="https://i.postimg.cc/tCwGVkdH/20250922-113514.png" alt="bKash" class="w-10 h-10 rounded-full mx-auto mb-2"><p class="font-bold text-md">বিকাশ</p><p class="text-gray-600 font-mono tracking-wider text-sm my-1">01827750260</p><button onclick="copyToClipboard('01827750260', this)" class="w-full text-xs p-1 mt-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors flex items-center justify-center gap-1"><i data-lucide="copy" class="w-3 h-3"></i><span>কপি</span></button></div>
                            <div class="bg-gray-100 p-3 rounded-lg text-center"><img src="https://i.postimg.cc/htsw10Tj/20250922-113924.png" alt="Rocket" class="w-10 h-10 rounded-full mx-auto mb-2"><p class="font-bold text-md">রকেট</p><p class="text-gray-600 font-mono tracking-wider text-sm my-1">018277502604</p><button onclick="copyToClipboard('018277502604', this)" class="w-full text-xs p-1 mt-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors flex items-center justify-center gap-1"><i data-lucide="copy" class="w-3 h-3"></i><span>কপি</span></button></div>
                            <div class="bg-gray-100 p-3 rounded-lg text-center"><img src="https://i.postimg.cc/L6LFLfxY/20250922-113752.png" alt="Binance Pay" class="w-10 h-10 rounded-full mx-auto mb-2"><p class="font-bold text-md">Binance Pay</p><p class="text-gray-600 font-mono tracking-wider text-sm my-1">শীঘ্রই আসছে..</p><button class="w-full text-xs p-1 mt-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors flex items-center justify-center gap-1" disabled><i data-lucide="copy" class="w-3 h-3"></i><span>কপি আইডি</span></button></div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4 text-center border-t border-gray-300 pt-4">টাকা পাঠানোর পর নিচের ফর্মটি পূরণ করুন:</p>
                        <div class="space-y-4">
                             <div><label for="deposit-method" class="block text-sm font-medium text-gray-600 mb-2">পেমেন্ট মাধ্যম</label><select id="deposit-method" class="w-full p-3 rounded-lg input-field"><option value="">কোন মাধ্যমে টাকা পাঠিয়েছেন?</option><option value="Nagad">নগদ</option><option value="bKash">বিকাশ</option><option value="Rocket">রকেট</option><option value="Binance">Binance</option></select></div>
                            <div><label for="deposit-amount" class="block text-sm font-medium text-gray-600 mb-2">টাকার পরিমাণ (BDT)</label><input id="deposit-amount" type="number" placeholder="ন্যূনতম পরিমাণ ৳50" class="w-full p-3 rounded-lg input-field"></div>
                            <div><label for="sender-number" class="block text-sm font-medium text-gray-600 mb-2">আপনার পেমেন্ট নম্বর</label><input id="sender-number" type="text" placeholder="যে নম্বর থেকে টাকা পাঠিয়েছেন" class="w-full p-3 rounded-lg input-field"></div>
                            <div><label for="deposit-txid" class="block text-sm font-medium text-gray-600 mb-2">Transaction ID (TrxID)</label><input id="deposit-txid" type="text" placeholder="টাকা পাঠানোর পর পাওয়া TrxID" class="w-full p-3 rounded-lg input-field"></div>
                            <button id="deposit-btn" class="w-full p-3 rounded-lg btn-gradient">ডিপোজিট সাবমিট করুন</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6"><h3 class="text-lg font-semibold mb-3">পেমেন্ট হিস্টোরি</h3><div id="payment-history-list" class="space-y-3"></div></div>
            </div>

             <div id="mail-page" class="sub-page">
                 <div class="marquee mt-4">
                    <p class="marquee-content">
                        💌 DIGITAL NEXUS-এ আপনাকে স্বাগতম! ✨ আমাদের সকল সার্ভিস এখন লাইভ! 📩 এখানে পাবেন সেরা কোয়ালিটির ডিজিটাল প্রোডাক্ট। ⚡ যেকোনো সমস্যায় দ্রুত সমাধান। 🕐 আমরা ২৪/৭ ঘণ্টা সার্ভিস দিয়ে থাকি। 💬 প্রয়োজনে আমাদের সাপোর্ট টিমের সাথে যোগাযোগ করুন। 💎 DIGITAL NEXUS — বিশ্বাস ও গুণমানের প্রতীক!
                    </p>
                </div>
                <div class="p-4 space-y-6">
                    <p class="text-gray-600 text-center mb-4">সহজে এবং সাশ্রয়ী মূল্যে ডিজিটাল প্রোডাক্ট কিনুন</p>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="handleLoginMailClick()" class="w-full p-3 rounded-lg font-bold text-white bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg btn flex items-center justify-center gap-2">
                            <i data-lucide="log-in" class="w-5 h-5"></i><span>লগইন মেইল</span>
                        </button>
                         <button onclick="handleOtpMailClick()" class="w-full p-3 rounded-lg font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg btn flex items-center justify-center gap-2">
                            <i data-lucide="shield-check" class="w-5 h-5"></i><span>OTP মেইল</span>
                        </button>
                    </div>
                    <div id="mail-list" class="space-y-4"></div>
                     <div>
                        <div class="flex justify-between items-center mb-3 mt-6">
                            <h3 class="text-lg font-semibold">ক্রয়ের ইতিহাস (শেষ ৪ ঘণ্টা)</h3>
                            <div class="flex items-center gap-2">
                               <button id="copy-history-btn" class="btn-outline-accent p-2 rounded-lg text-sm flex items-center gap-1"><i data-lucide="copy" class="w-4 h-4"></i><span>কপি</span></button>
                               <button id="download-history-btn" class="btn-outline-accent p-2 rounded-lg text-sm flex items-center gap-1"><i data-lucide="download" class="w-4 h-4"></i><span>ডাউনলোড</span></button>
                            </div>
                        </div>
                        <div id="mail-purchase-history" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Other pages would be similarly updated -->
        </main>
        
        <nav class="bottom-nav">
            <button class="nav-link-main" data-page="updates-page"><i data-lucide="bell" class="icon"></i><span>আপডেট</span></button>
            <button class="nav-link-main" data-page="tutorial-page"><i data-lucide="video" class="icon"></i><span>টিউটোরিয়াল</span></button>
            <button class="nav-link-main center-home-link active" data-page="home-page"><i data-lucide="home" class="icon"></i></button>
            <button class="nav-link-main" data-page="mail-page"><i data-lucide="mail" class="icon"></i><span>প্রোডাক্ট</span></button>
            <button class="nav-link-main" data-page="profile-page"><i data-lucide="user" class="icon"></i><span>প্রোফাইল</span></button>
            <button id="admin-nav-link" class="nav-link-main hidden" data-page="admin-page"><i data-lucide="shield" class="icon"></i><span>অ্যাডমিন</span></button>
        </nav>
    </div>

    <!-- Modals are largely unchanged in structure, so they are omitted for brevity -->
    <!-- The JavaScript below contains all the logic updates -->

    <script type="module">
        const ADMIN_UID = "CUb4r6eg1RV6Ljkj5U2V1cSswng1";
        const MINIMUM_DEPOSIT_AMOUNT = 50; // New minimum deposit amount
        let stockFluctuationInterval = null; // To hold the interval timer

        const firebaseConfig = {
            apiKey: "AIzaSyCoCy08FL_sHHdA0f2cJg0BaF-iYAhFuk0",
            authDomain: "mail-store-4692b.firebaseapp.com",
            databaseURL: "https://mail-store-4692b-default-rtdb.firebaseio.com",
            projectId: "mail-store-4692b",
            storageBucket: "mail-store-4692b.firebasestorage.app",
            messagingSenderId: "264936867411",
            appId: "1:264936867411:web:5933919e5bafae617968a6"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, getCountFromServer, writeBatch, updateDoc, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserTg = null;
        let userData = null;
        let appConfig = {};
        let insufficientBalanceInterval = null;

        const loader = document.getElementById('loader');
        const getLoadingHTML = () => `<div class="loading-container"><div class="premium-loader-spinner"></div></div>`;

        window.onload = async () => {
            cycleReviewsOnLoader();
            try {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                currentUserTg = window.Telegram.WebApp.initDataUnsafe.user;
                if (!currentUserTg) {
                    showAlert("টেলিগ্রাম ব্যবহারকারীর তথ্য পাওয়া যায়নি। অনুগ্রহ করে টেলিগ্রাম থেকে এই অ্যাপটি খুলুন।");
                    loader.style.display = 'none';
                    return;
                }
            } catch (e) {
                console.error("Telegram WebApp script failed to initialize or user data not available.", e);
                showAlert("টেলিগ্রাম মিনি অ্যাপ শুরু করতে ত্রুটি হয়েছে। অনুগ্রহ করে টেলিগ্রাম থেকে আবার চেষ্টা করুন।");
                loader.style.display = 'none';
                return;
            }
            lucide.createIcons();
            setupEventListeners();
            setupBanner();
            await initUserSession();
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);
        };

        function cycleReviewsOnLoader() {
            const reviews = ['"খুবই বিশ্বস্ত একটি সাইট।" - মোঃ রায়হান', '"দ্রুত ডেলিভারি এবং চমৎকার সাপোর্ট।" - ফারিয়া', '"ব্যবহার করা খুবই সহজ। Recommended!" - সুমন আহমেদ'];
            let reviewIndex = 0;
            const reviewEl = document.getElementById('loader-reviews');
            setInterval(() => {
                reviewEl.style.opacity = '0';
                setTimeout(() => {
                    reviewIndex = (reviewIndex + 1) % reviews.length;
                    reviewEl.textContent = reviews[reviewIndex];
                    reviewEl.style.opacity = '1';
                }, 500);
            }, 4000);
        }

        // Initialize stock fluctuation simulation
        function initializeStockFluctuation() {
            if (stockFluctuationInterval) {
                clearInterval(stockFluctuationInterval);
            }
            stockFluctuationInterval = setInterval(() => {
                const stockElements = document.querySelectorAll('.stock-display');
                stockElements.forEach(el => {
                    let currentStock = parseInt(el.textContent);
                    if (isNaN(currentStock)) return;
                    
                    const fluctuation = Math.floor(Math.random() * 5) - 2; // -2, -1, 0, 1, 2
                    let newStock = currentStock + fluctuation;

                    // Ensure stock doesn't go below the base
                    if (newStock < 958) {
                        newStock = 958 + Math.floor(Math.random() * 3);
                    }
                    
                    el.textContent = newStock;
                });
            }, 5000); // Fluctuate every 5 seconds
        }

        async function initUserSession() {
            if (!currentUserTg) {
                showAlert("টেলিগ্রাম ব্যবহারকারীর তথ্য অনুপস্থিত।");
                return;
            }
            // ... (rest of the initUserSession function remains the same)
             const tgChatId = String(currentUserTg.id);
            const userRef = doc(db, "users", tgChatId);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    userData = userSnap.data();
                } else {
                    const userName = `${currentUserTg.first_name || ''} ${currentUserTg.last_name || ''}`.trim() || `User ${tgChatId}`;
                    userData = {
                        tgChatId: tgChatId, name: userName, username: currentUserTg.username || null, balance: 0,
                        createdAt: serverTimestamp(), isBlocked: false, lastSeenNotification: null, isPremium: false, premiumExpiresAt: null
                    };
                    await setDoc(userRef, userData);
                }
                
                if (userData.isPremium && userData.premiumExpiresAt && userData.premiumExpiresAt.toDate() < new Date()) {
                    userData.isPremium = false;
                    userData.premiumExpiresAt = null;
                    await updateDoc(userRef, { isPremium: false, premiumExpiresAt: null });
                    showAlert("আপনার প্রিমিয়াম সাবস্ক্রিপশনের মেয়াদ শেষ হয়ে গেছে।");
                }
                if (userData.isBlocked) {
                    showAlert("আপনার অ্যাকাউন্ট ব্লক করা হয়েছে।");
                    return;
                }
                await fetchAppConfig();
                conditionallyLoadGlobalAds();
                if (tgChatId === ADMIN_UID) {
                    document.getElementById('admin-nav-link').classList.remove('hidden');
                }
                loadSupportMenu();
                updateUI();
                listenForNotifications();
                showMainPage('app-container');
                navigateTo('home-page');
            } catch (error) {
                console.error("Error initializing user session:", error);
                showAlert("আপনার সেশন শুরু করতে ব্যর্থ হয়েছে। আবার চেষ্টা করুন।");
                loader.style.display = 'none';
            }
        }
        
        async function fetchAppConfig() {
            const configRef = doc(db, "config", "main");
            const configSnap = await getDoc(configRef);
            appConfig = configSnap.exists() ? configSnap.data() : { mails: [], otpMailLink: '#' };
        }

        function updateHeaderUI() {
            if (!currentUserTg) return;
            // ... (this function is visually updated by CSS changes, logic is the same)
        }

        function updateUI() {
            if (!userData) return;
            const balance = (userData.balance || 0).toFixed(2);
            document.getElementById('balance-display').textContent = `৳${balance}`;
            document.getElementById('header-balance-display').textContent = `৳${balance}`;
            updateHeaderUI();
        }

        function navigateTo(pageId) {
            // Clear stock fluctuation interval when leaving the mail page
            if (pageId !== 'mail-page' && stockFluctuationInterval) {
                clearInterval(stockFluctuationInterval);
                stockFluctuationInterval = null;
            }
            if (pageId === 'mail-page') {
                // Initialize fluctuation when navigating to the mail page
                loadMailStore().then(() => {
                    initializeStockFluctuation();
                });
            }

            // ... (rest of navigateTo function remains mostly the same)
            if (pageId !== 'mail-page' && insufficientBalanceInterval) {
                clearInterval(insufficientBalanceInterval);
                insufficientBalanceInterval = null;
            }
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link-main[data-page]').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            
            const adsSection = document.getElementById('ads-section');
            const adFreePages = ['mail-page', 'pay-page'];
            if (userData.isPremium || adFreePages.includes(pageId)) {
                adsSection.style.display = 'none';
            } else {
                adsSection.style.display = 'block';
            }
            const pageLoadFunctions = {
                'pay-page': loadPaymentHistory,
                'updates-page': () => { loadUpdates(); loadReviews(); },
                'admin-page': populateAdminMailTypes,
                'profile-page': loadProfilePage,
                'features-page': loadFeaturesPage,
                'tutorial-page': loadTutorials,
                'recharge-page': () => { loadRechargeHistory(); setupDynamicAmountHandlers('recharge'); },
                'send-page': () => { setupDynamicAmountHandlers('send'); }
            };
             if (pageLoadFunctions[pageId] && pageId !== 'mail-page') { // mail-page is handled separately now
                pageLoadFunctions[pageId]();
             }
            lucide.createIcons();
        }

        async function handleDepositRequest() {
            const method = document.getElementById('deposit-method').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            const senderNumber = document.getElementById('sender-number').value.trim();
            const transactionId = document.getElementById('deposit-txid').value.trim();

            if (!method || !amount || !senderNumber || !transactionId) {
                return showAlert("অনুগ্রহ করে সমস্ত তথ্য সঠিকভাবে পূরণ করুন।");
            }
            // New minimum deposit check
            if (amount < MINIMUM_DEPOSIT_AMOUNT) {
                return showAlert(`ন্যূনতম ডিপোজিটের পরিমাণ ৳${MINIMUM_DEPOSIT_AMOUNT}।`);
            }

            loader.style.opacity = '1';
            loader.style.display = 'flex';

            try {
                // ... (rest of the handleDepositRequest function is the same)
                 const depositQuery = query(collection(db, "deposits"), where("transactionId", "==", transactionId), where("status", "in", ["pending", "approved"]));
                const querySnapshot = await getDocs(depositQuery);
                if (!querySnapshot.empty) {
                    loader.style.display = 'none';
                    return showAlert("এই Transaction ID দিয়ে ইতিমধ্যে একটি ডিপোজিট অনুরোধ জমা দেওয়া হয়েছে।");
                }
                await addDoc(collection(db, "deposits"), {
                    userId: userData.tgChatId, userName: userData.name, method: method, amount: amount,
                    senderNumber: senderNumber, transactionId: transactionId, status: "pending", requestedAt: serverTimestamp()
                });
                showAlert("আপনার ডিপোজিট অনুরোধ সফলভাবে জমা হয়েছে।");
                document.getElementById('deposit-method').value = '';
                document.getElementById('deposit-amount').value = '';
                document.getElementById('sender-number').value = '';
                document.getElementById('deposit-txid').value = '';
                loadPaymentHistory();
            } catch (error) {
                showAlert("ডিপোজিট অনুরোধ জমা দিতে একটি সমস্যা হয়েছে।");
            } finally {
                loader.style.display = 'none';
            }
        }
        
        async function loadMailStore() {
            const mailListEl = document.getElementById('mail-list');
            const historyListEl = document.getElementById('mail-purchase-history');
            mailListEl.innerHTML = getLoadingHTML();
            historyListEl.innerHTML = getLoadingHTML();

            try {
                const stockPromises = (appConfig.mails || []).map(mail => getStockCount(mail.stockKey));
                const stockCounts = await Promise.all(stockPromises);
                let mailsWithStock = (appConfig.mails || []).map((mail, index) => ({ ...mail, stock: stockCounts[index] }));
                mailsWithStock.sort((a, b) => b.stock - a.stock);

                mailListEl.innerHTML = '';
                mailsWithStock.forEach(mail => {
                    const realStock = mail.stock;
                    const displayStock = realStock + 958; // Inflated stock
                    const costInBdt = mail.priceBdt;
                    const isOutOfStock = realStock === 0;
                    const insufficientBalance = userData.balance < costInBdt;
                    const buyButtonDisabled = isOutOfStock || insufficientBalance ? 'disabled' : '';
                    const buyButtonClasses = isOutOfStock || insufficientBalance ? 'bg-gray-400 cursor-not-allowed' : 'btn-gradient';
                    
                    mailListEl.innerHTML += `<div class="card-bg p-4 rounded-xl space-y-3">
                        <div class="flex justify-between items-center">
                           <div class="flex items-center gap-3"><img src="${mail.logoUrl}" class="w-8 h-8 rounded-lg object-cover" alt="${mail.type} logo"><h3 class="font-bold text-lg text-gray-800">${mail.type}</h3></div>
                           <button onclick="showMailDetails('${mail.type}', '${mail.details.replace(/'/g, "\\'")}')" class="text-teal-600 text-sm font-semibold">বিস্তারিত</button>
                        </div>
                        <div class="grid grid-cols-3 text-center items-center pt-2 border-t border-gray-200">
                           <div><p class="text-gray-500 text-sm">দাম</p><p class="font-bold text-lg text-teal-600">৳${costInBdt.toFixed(2)}</p></div>
                           <div><p class="text-gray-500 text-sm">স্টক</p><p class="font-bold text-lg text-green-600 stock-display">${displayStock}</p></div>
                           <button class="${buyButtonClasses} w-full py-2 rounded-lg text-md" ${buyButtonDisabled} onclick="buyMail('${mail.type}', ${costInBdt}, '${mail.stockKey}')">এখনই কিনুন</button>
                        </div>
                    </div>`;
                });
                
                // ... (rest of the loadMailStore function for purchase history remains the same)
                 const fourHoursAgo = Timestamp.fromDate(new Date(Date.now() - 4 * 60 * 60 * 1000));
                const q = query(collection(db, "mail_purchases"), where("userId", "==", userData.tgChatId), where("purchasedAt", ">=", fourHoursAgo), orderBy("purchasedAt", "desc"));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) {
                    historyListEl.innerHTML = '<p class="text-center text-gray-600">আপনি শেষ ৪ ঘণ্টায় কোনো প্রোডাক্ট কিনেননি।</p>';
                } else {
                    historyListEl.innerHTML = querySnapshot.docs.map(doc => {
                        const purchase = doc.data();
                        const date = purchase.purchasedAt.toDate().toLocaleString();
                        const fullData = [purchase.mail, purchase.password, purchase.refreshToken, purchase.clientId].filter(Boolean).join('|');
                        return `<div class="card-bg p-4 rounded-xl space-y-3">
                            <div class="flex justify-between items-start">
                                <div><h4 class="font-bold text-lg text-gray-800">${purchase.mailType}</h4><p class="text-xs text-gray-500">${date}</p></div>
                                <button onclick="copyToClipboard('${fullData}', this)" class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-md font-semibold hover:bg-gray-200">সম্পূর্ণ কপি</button>
                            </div>
                            <div class="space-y-2 pt-2 border-t">
                                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-md"><span class="font-mono text-sm text-gray-800 truncate">${purchase.mail}</span><button onclick="copyToClipboard('${purchase.mail}', this)" class="ml-2 p-1.5 rounded-md hover:bg-gray-200"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></button></div>
                                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-md"><span class="font-mono text-sm text-gray-800">${purchase.password || 'N/A'}</span><button onclick="copyToClipboard('${purchase.password || ''}', this)" class="ml-2 p-1.5 rounded-md hover:bg-gray-200"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></button></div>
                            </div>
                        </div>`;
                    }).join('');
                }
                lucide.createIcons();

            } catch(e) {
                 mailListEl.innerHTML = '<p class="text-center text-red-600">প্রোডাক্ট লোড করা যায়নি।</p>';
                 historyListEl.innerHTML = '<p class="text-center text-red-600">হিস্টোরি লোড করা যায়নি।</p>';
                 console.error(e);
            }
        }
        
        // --- IMPORTANT ---
        // All other JavaScript functions (showAlert, copyToClipboard, buyMail, setupEventListeners, etc.)
        // remain in the script tag. They are omitted here to avoid making the response excessively long,
        // but they are essential for the app to work. The logic within them does not need to be changed
        // based on your request, only the functions shown above.
        // The original file's full JS should be used, with the modified functions I provided.

        // Placeholder for the rest of the original JavaScript
        // This includes functions like:
        // setupEventListeners, showMainPage, getStockCount, loadPaymentHistory, 
        // handleVote, handleAddMails, handleDepositRequest (already shown modified), 
        // showAlert, copyToClipboard, openApiLink, setupBanner, etc.
        // It's crucial that the rest of the JS logic from the original file is present here.
        // For example, here's buyMail, which remains unchanged logically:
        window.buyMail = async function(mailType, cost, stockKey) {
            if (userData.balance < cost) {
                // The insufficient balance modal should be styled to match the new theme
                document.getElementById('insufficient-balance-modal').classList.remove('hidden');
                lucide.createIcons();
                return;
            }
            if (!confirm(`আপনি কি ৳${cost.toFixed(2)} দিয়ে একটি ${mailType} কিনতে চান?`)) return;
            loader.style.display = 'flex';
            try {
                const purchasedMailData = await runTransaction(db, async (transaction) => {
                    const q = query(collection(db, stockKey), where("isSold", "==", false), limit(1));
                    const mailQuerySnapshot = await getDocs(q);
                    if (mailQuerySnapshot.empty) throw "দুঃখিত, এই ধরনের প্রোডাক্ট বর্তমানে স্টক শেষ।";
                    const mailDoc = mailQuerySnapshot.docs[0];
                    const mailData = mailDoc.data();
                    const userRef = doc(db, "users", userData.tgChatId);
                    const userSnap = await transaction.get(userRef);
                    if (!userSnap.exists() || userSnap.data().balance < cost) throw `অপর্যাপ্ত ব্যালেন্স।`;
                    
                    transaction.update(userRef, { balance: userSnap.data().balance - cost });
                    transaction.update(mailDoc.ref, { isSold: true, soldTo: userData.tgChatId, soldAt: serverTimestamp() });
                    const purchaseLogRef = doc(collection(db, "mail_purchases"));
                    transaction.set(purchaseLogRef, {
                         userId: userData.tgChatId, mailType: mailType, mail: mailData.email,
                        password: mailData.password || null, refreshToken: mailData.refresh_token || null,
                        clientId: mailData.client_id || null, cost: cost, purchasedAt: serverTimestamp()
                    });
                    return mailData;
                });
                userData.balance -= cost;
                updateUI();
                // Success modal should also be updated visually
                document.getElementById('purchase-success-email').textContent = purchasedMailData.email;
                document.getElementById('purchase-success-password').textContent = purchasedMailData.password || 'N/A';
                document.getElementById('purchase-success-modal').classList.remove('hidden');
                lucide.createIcons();
                loadMailStore(); // Reload to update stock
            } catch (e) { showAlert(typeof e === 'string' ? e : "কিনতে সমস্যা হয়েছে। আবার চেষ্টা করুন।"); }
            finally { loader.style.display = 'none'; }
        }

        // --- All other functions from the original file should be here ---
        // (The full JS code is too long to paste again, but it should be included
        // in the final implementation, with the changes I made above integrated)

    </script>
</body>
</html>
