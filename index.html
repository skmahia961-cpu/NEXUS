<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REWARD CLAIM</title>
<meta name="monetag" content="a41ceca9ffc67edad031c0024f85ef59">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Poppins', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                colors: {
                    nexus: {
                        primary: '#6366f1',
                        accent: '#06b6d4',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    }
</script>
<style>
    :root {
        --app-bg: #0f172a; /* Slate-900 */
        --app-card: #1e293b; /* Slate-800 */
        --app-text: #f1f5f9; /* Slate-100 */
        --app-subtext: #94a3b8; /* Slate-400 */
        --app-border: #334155; /* Slate-700 */
        --primary-grad: linear-gradient(135deg, #6366f1, #8b5cf6);
    }
    body.light-theme {
        --app-bg: #f1f5f9;
        --app-card: #ffffff;
        --app-text: #1e293b;
        --app-subtext: #475569;
        --app-border: #e2e8f0;
    }
    body {
        background-color: var(--app-bg);
        background-image: linear-gradient(180deg, var(--app-bg) 0%, color-mix(in srgb, var(--app-bg) 85%, #000) 100%);
        color: var(--app-text);
        font-family: 'Poppins', sans-serif;
        -webkit-tap-highlight-color: transparent;
    }
    .no-select { -webkit-user-select: none; user-select: none; }
    .neo-card {
        background: var(--app-card);
        border: 1px solid var(--app-border);
        box-shadow: 0 4px 12px -1px rgba(0, 0, 0, 0.1), 0 2px 8px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .neo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.2);
    }
    .neo-input {
        background: color-mix(in srgb, var(--app-bg) 50%, var(--app-border));
        border: 1px solid var(--app-border);
        color: var(--app-text);
        transition: all 0.3s ease;
    }
    .neo-input::placeholder { color: #64748b; } /* Slate-500 */
    .neo-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        outline: none;
        background: var(--app-card);
    }
    .action-btn {
        background: var(--primary-grad); color: white; font-weight: 600; border: none;
        position: relative; overflow: hidden; transition: all 0.3s ease;
        box-shadow: 0 4px 15px -3px rgba(99, 102, 241, 0.3);
    }
    .action-btn:active { transform: scale(0.97); }
    .action-btn:hover { box-shadow: 0 6px 20px -3px rgba(99, 102, 241, 0.5); }
    .action-btn:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; box-shadow: none; }

    .app-view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .app-view.active-view { display: block; opacity: 1; transform: translateY(0); }

    .dock-nav {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 95%; max-width: 400px;
        background: color-mix(in srgb, var(--app-card) 80%, transparent);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-radius: 24px; border: 1px solid color-mix(in srgb, var(--app-border) 50%, transparent);
        display: flex; justify-content: space-evenly; padding: 12px; z-index: 50;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
    }
    .dock-item {
        color: var(--app-subtext); display: flex; flex-direction: column; align-items: center;
        font-size: 10px; gap: 4px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; padding: 0 8px;
    }
    .dock-item.nav-active { color: #818cf8; transform: translateY(-4px); }
    .dock-item.nav-active::after {
        content: ''; position: absolute; bottom: -8px; width: 6px; height: 6px;
        background: #818cf8; border-radius: 50%;
    }
    #splash-screen {
        position: fixed; inset: 0; background: var(--app-bg); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .loader-ring {
        width: 60px; height: 60px; border: 4px solid var(--app-border); border-top-color: #22c55e;
        border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .side-panel-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 80;
    }
    .side-panel {
        position: fixed; left: 0; top: 0; bottom: 0; width: 85%; max-width: 320px;
        background: var(--app-bg); z-index: 90; transform: translateX(-105%); color: #e2e8f0;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-right: 1px solid #334155;
    }
    .side-panel.open { transform: translateX(0); }
    .side-panel-overlay.open { opacity: 1; visibility: visible; }

    .glass-modal {
        background: color-mix(in srgb, var(--app-card) 90%, transparent);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.3);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        color: var(--app-text);
    }
    .animated-task-button {
        animation: pulse-glow 2.5s infinite ease-in-out;
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 5px #6366f1, 0 0 10px #6366f1, 0 0 15px #8b5cf6; }
        50% { box-shadow: 0 0 10px #8b5cf6, 0 0 20px #8b5cf6, 0 0 30px #6366f1; }
    }
    .attractive-glow-button {
        animation: pulse-glow-yellow 2.5s infinite ease-in-out;
        border: 1px solid #f59e0b;
    }
     @keyframes pulse-glow-yellow {
        0%, 100% { box-shadow: 0 0 8px #f59e0b, 0 0 15px #f59e0b, 0 0 20px #facc15; }
        50% { box-shadow: 0 0 12px #facc15, 0 0 25px #facc15, 0 0 35px #f59e0b; }
    }
</style>
</head>
<body class="max-w-md mx-auto min-h-screen overflow-x-hidden no-select pb-28">

<!-- SPLASH SCREEN -->
<div id="splash-screen">
    <div class="relative">
        <div class="loader-ring"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
        </div>
    </div>
    <h1 class="mt-6 text-2xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-green-500" data-lang-key="reward_claim_title">REWARD CLAIM</h1>
    <p id="loading-msg" class="text-app-subtext text-sm mt-2 animate-pulse" data-lang-key="establishing_connection">Establishing Secure Connection...</p>
</div>

<!-- SIDE PANEL -->
<div class="side-panel-overlay" id="panel-overlay"></div>
<aside class="side-panel" id="main-side-panel">
    <div class="p-6 bg-slate-900/50 border-b border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-indigo-600 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i data-lucide="shield-check" class="w-7 h-7 text-white"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg text-slate-100" data-lang-key="help_center">Help Center</h3>
                <p class="text-xs text-slate-400" data-lang-key="priority_support">24/7 Priority Support</p>
            </div>
        </div>
    </div>
    <div id="panel-content" class="p-4 space-y-2 overflow-y-auto h-[calc(100%-160px)]">
        <button onclick="closeSidePanel(); switchView('view-deposit');" class="neo-card bg-slate-800/50 border-slate-700 w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-700/60 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400"><i data-lucide="arrow-down-left" class="w-5 h-5"></i></div>
                <span class="font-medium text-slate-200" data-lang-key="deposit">Deposit</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
         <button onclick="closeSidePanel(); switchView('view-withdrawal');" class="neo-card bg-slate-800/50 border-slate-700 w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-700/60 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-400"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                <span class="font-medium text-slate-200" data-lang-key="withdrawal">Withdrawal</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="openSupport()" class="neo-card bg-slate-800/50 border-slate-700 w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-700/60 transition">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-blue-500/10 text-blue-400"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium text-slate-200" data-lang-key="support_hub">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="visitWebsite()" class="neo-card bg-slate-800/50 border-slate-700 w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-700/60 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-purple-500/10 text-purple-400"><i data-lucide="globe" class="w-5 h-5"></i></div>
                <span class="font-medium text-slate-200" data-lang-key="visit_website">Visit Website</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="openExtraIncomePage()" class="neo-card bg-slate-800/50 border-slate-700 w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-700/60 transition mt-4 border-t border-slate-700 pt-6">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-yellow-500/10 text-yellow-400"><i data-lucide="zap" class="w-5 h-5"></i></div>
                <span class="font-medium text-slate-200" data-lang-key="extra_income">Extra Income</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-800 bg-slate-900/80">
        <p class="text-center text-[10px] text-slate-600 tracking-widest">REWARD v5.0.0</p>
    </div>
</aside>


<!-- MAIN APP CONTAINER -->
<div id="nexus-app" class="min-h-screen">
<!-- TOP BAR -->
<header class="sticky top-0 z-40 bg-app-bg/80 backdrop-blur-md border-b border-app-border px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3" id="user-quick-info">
        <div class="relative">
            <img id="nav-user-img" src="" class="w-10 h-10 rounded-full border-2 border-indigo-400 hidden object-cover" alt="User">
            <div id="nav-user-initials" class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center font-bold text-slate-300">U</div>
            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-app-bg rounded-full"></div>
        </div>
        <div>
            <p id="welcome-text" class="text-xs text-app-subtext font-medium" data-lang-key="welcome_back">Welcome back,</p>
            <p id="user-balance-top" class="text-sm font-bold text-emerald-400">$0.00</p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="switchView('view-deposit')" class="action-btn px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5">
            <i data-lucide="plus" class="w-4 h-4"></i><span data-lang-key="fund">FUND</span>
        </button>
        <button id="btn-notifications" class="relative p-2 text-app-subtext hover:text-app-text transition bg-slate-800 rounded-full">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="badge-notify" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-app-bg rounded-full hidden"></span>
        </button>
        <button id="btn-menu" class="p-2 text-app-subtext hover:text-app-text transition">
            <i data-lucide="align-right" class="w-6 h-6"></i>
        </button>
    </div>
</header>

<main class="p-4">

<!-- (NEW) LANDING VIEW FOR NEW USERS -->
<div id="view-landing" class="app-view space-y-6">
    <div class="text-center pt-8">
        <div class="w-24 h-24 bg-gradient-to-tr from-indigo-500 to-cyan-400 rounded-full flex items-center justify-center mx-auto shadow-lg shadow-indigo-500/30 mb-6">
             <i data-lucide="rocket" class="w-12 h-12 text-white"></i>
        </div>
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400" data-lang-key="welcome">Welcome!</h1>
        <p class="text-app-subtext mt-2" data-lang-key="unlock_potential">Unlock Your Earning Potential</p>
    </div>

    <!-- Main Action -->
    <div class="neo-card p-6 rounded-3xl text-center relative border-2 border-indigo-500/50 shadow-lg shadow-indigo-500/10">
        <p class="text-app-subtext mb-4">Choose a plan to begin your journey and start earning rewards today.</p>
        <button onclick="switchView('view-extra-income')" class="action-btn w-full py-4 rounded-2xl text-lg font-bold flex items-center justify-center gap-2 animated-task-button">
            <i data-lucide="zap" class="w-5 h-5"></i>
            <span>Start Earning</span>
        </button>
    </div>
    
    <!-- Community Leaders Section -->
    <div class="space-y-4">
        <h3 class="text-lg font-semibold text-app-text px-2 flex items-center gap-2">
            <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400"></i> <span>Community Leaders</span>
        </h3>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="showLeaderboardModal('earners')" class="neo-card p-4 rounded-xl flex items-center justify-center gap-3 hover:border-yellow-400/50 transition">
                <i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>
                <span class="font-semibold" data-lang-key="top_earners">Top Earners</span>
            </button>
            <button onclick="showLeaderboardModal('referrers')" class="neo-card p-4 rounded-xl flex items-center justify-center gap-3 hover:border-cyan-400/50 transition">
                <i data-lucide="users" class="w-6 h-6 text-cyan-400"></i>
                <span class="font-semibold" data-lang-key="top_referrers">Top Referrers</span>
            </button>
        </div>
    </div>
</div>


<!-- DASHBOARD VIEW -->
<div id="view-dashboard" class="app-view active-view space-y-6">
    <!-- Promo Slider -->
    <div class="rounded-2xl overflow-hidden relative aspect-video shadow-lg shadow-black/20">
        <div id="promo-slider" class="h-full flex transition-transform duration-500 ease-out">
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/cKYRC9jj/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" class="w-full h-full object-cover" alt="Promo 1">
            </div>
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" class="w-full h-full object-cover" alt="Promo 2">
            </div>
        </div>
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" id="slider-dots">
            <!-- Dots here -->
        </div>
    </div>

<!-- Main Balance Card -->
<div class="neo-card p-6 rounded-3xl relative overflow-hidden">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl"></div>
    <p class="text-app-subtext font-medium mb-2 flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> <span data-lang-key="available_balance">Available Balance</span></p>
    <h2 id="main-balance-display" class="text-4xl font-bold text-app-text tracking-tight mb-6">$0.00</h2>
    <div class="grid grid-cols-2 gap-3">
        <button onclick="switchView('view-deposit')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> <span data-lang-key="deposit">DEPOSIT</span>
        </button>
         <button onclick="switchView('view-withdrawal')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500">
            <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> <span data-lang-key="withdraw">WITHDRAW</span>
        </button>
    </div>
</div>

<!-- Live Withdrawal Feed -->
<div id="live-withdrawal-feed" class="space-y-3">
    <h3 class="text-lg font-semibold text-app-text px-2 flex items-center gap-2">
        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
        <span data-lang-key="live_withdrawals">Live Withdrawals</span>
    </h3>
    <div id="withdrawal-feed-container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- TASKS VIEW -->
<div id="view-tasks" class="app-view space-y-6">
    <div class="text-center">
       <h2 class="text-2xl font-bold text-app-text" data-lang-key="daily_tasks">Daily Tasks</h2>
       <p class="text-app-subtext text-sm" data-lang-key="complete_tasks_to_earn">Complete simple tasks to earn rewards</p>
   </div>
   <div id="task-list" class="space-y-4">
       <!-- Tasks will be dynamically inserted here -->
   </div>
</div>

<!-- REFER VIEW -->
<div id="view-refer" class="app-view space-y-6">
    <div id="referral-input-section" class="neo-card p-5 rounded-2xl text-center space-y-3">
        <h3 class="font-semibold text-app-text text-lg" data-lang-key="have_referral_code">Have a Referral Code?</h3>
        <p class="text-xs text-app-subtext" data-lang-key="enter_friend_code">Enter your friend's code below. You both will receive <span id="referral-bonus-text" class="text-emerald-400 font-bold">$1.00</span> instantly!</p>
        <div class="relative">
            <input type="text" id="referral-code-input" placeholder="Enter Code Here" class="neo-input w-full p-3 rounded-xl text-center font-mono">
        </div>
        <button id="btn-verify-referral" class="action-btn w-full py-3 rounded-xl"><span data-lang-key="verify_claim">VERIFY & CLAIM</span> <span id="referral-claim-bonus-text">$1.00</span></button>
    </div>
    <div class="grid grid-cols-2 gap-4 text-center">
        <div class="neo-card p-4 rounded-xl">
            <p class="text-sm text-app-subtext" data-lang-key="total_referrals">Total Referrals</p>
            <p id="ref-stat-count" class="text-2xl font-bold text-app-text">0</p>
        </div>
        <div class="neo-card p-4 rounded-xl">
            <p class="text-sm text-app-subtext" data-lang-key="referral_earnings">Referral Earnings</p>
            <p id="ref-stat-earnings" class="text-2xl font-bold text-emerald-400">$0.00</p>
        </div>
    </div>
    <div class="neo-card p-5 rounded-2xl text-center">
        <h3 class="font-semibold text-app-subtext mb-2" data-lang-key="your_referral_link">Your Unique Referral Link</h3>
        <div class="relative">
            <input type="text" id="referral-link-display" readonly class="neo-input w-full p-3 rounded-xl text-center bg-slate-700 font-mono text-sm" value="Loading...">
            <button onclick="copyText(document.getElementById('referral-link-display').value)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-600">
                <i data-lucide="copy" class="w-4 h-4 text-app-subtext"></i>
            </button>
        </div>
    </div>
    <div id="your-referrals-section" class="space-y-3">
        <h3 class="text-lg font-semibold text-app-text px-2 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-nexus-primary"></i>
            <span data-lang-key="your_referrals">Your Referrals</span>
        </h3>
        <div id="my-referrals-list" class="space-y-3"></div>
    </div>
</div>

<!-- DEPOSIT VIEW -->
<div id="view-deposit" class="app-view space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-app-text" data-lang-key="add_funds">Add Funds</h2>
        <p class="text-app-subtext text-sm" data-lang-key="secure_top_up">Secure & Fast Balance Top-up</p>
    </div>
    <div class="neo-card p-5 rounded-2xl bg-indigo-500/10 border-indigo-500/20">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-circle" class="w-6 h-6 text-indigo-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-indigo-300 mb-1" data-lang-key="important_note">IMPORTANT NOTE</h4>
                 <p class="text-xs text-indigo-400 leading-relaxed" data-lang-key="deposit_note">
                    Please use a valid payment method. Minimum deposit is <span id="min-deposit-text" class="text-indigo-300 font-bold">$10.00</span>.
                 </p>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
         <div class="neo-card p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-slate-700/50" onclick="copyNumber('0x82f67a0590e10f679c062f8e2c235af4ea980bc9', 'USDT')">
             <img src="https://i.postimg.cc/dkyYkPk2/usdt-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="USDT">
             <span class="font-mono text-xs text-app-text">USDT (TRC20)</span>
             <span class="text-[10px] text-app-subtext mt-1" data-lang-key="tap_to_copy">Tap to Copy</span>
         </div>
         <div class="neo-card p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-slate-700/50" onclick="copyNumber('1RBJu6cHBetMCYHxDZH1x8nw41buXVxJX', 'BTC')">
             <img src="https://i.postimg.cc/gxWnGs7Z/btc-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="BTC">
             <span class="font-mono text-xs text-app-text">Bitcoin</span>
             <span class="text-[10px] text-app-subtext mt-1" data-lang-key="tap_to_copy">Tap to Copy</span>
         </div>
         <div class="neo-card p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-slate-700/50" onclick="copyNumber('900749799', 'Binance')">
             <img src="https://i.postimg.cc/21r8s6bf/binance-logo.png" class="w-8 h-8 mb-2 rounded-full bg-white p-1" alt="Binance">
             <span class="font-mono text-xs text-app-text">Binance Pay</span>
             <span class="text-[10px] text-app-subtext mt-1" data-lang-key="tap_to_copy">Tap to Copy</span>
         </div>
    </div>
    <div class="neo-card p-5 rounded-2xl space-y-4">
        <h3 class="font-semibold text-app-text" data-lang-key="submit_verification_info">Submit Verification Info</h3>
        <input type="hidden" id="dep-method" value="">
        <button id="dep-method-selector" class="neo-input w-full p-3 rounded-xl text-left text-app-subtext flex justify-between items-center">
            <span id="dep-method-text" data-lang-key="select_payment_method">Select Payment Method</span>
            <i data-lucide="chevron-down" class="w-5 h-5"></i>
        </button>
        <input type="number" id="dep-amount" placeholder="Amount (USD)" class="neo-input w-full p-3 rounded-xl">
        <input type="text" id="dep-sender" placeholder="Your Wallet Address / Binance ID" class="neo-input w-full p-3 rounded-xl">
        <button id="btn-submit-deposit" class="action-btn w-full py-4 rounded-xl text-lg" data-lang-key="verify_deposit">VERIFY DEPOSIT</button>
    </div>
    <div class="pt-4">
        <h3 class="text-sm font-bold text-app-subtext mb-3 px-2" data-lang-key="transaction_history">Transaction History</h3>
        <div id="deposit-history-log" class="space-y-2"></div>
    </div>
</div>

<!-- WITHDRAWAL VIEW -->
<div id="view-withdrawal" class="app-view space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-app-text" data-lang-key="withdraw_funds">Withdraw Funds</h2>
        <p class="text-app-subtext text-sm" data-lang-key="request_withdrawal_to_wallet">Request a withdrawal to your wallet</p>
    </div>
    <div class="neo-card p-5 rounded-2xl bg-cyan-500/10 border-cyan-500/20">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-6 h-6 text-cyan-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-cyan-300 mb-1" data-lang-key="withdrawal_info">WITHDRAWAL INFO</h4>
                 <p id="withdrawal-info-text" class="text-xs text-cyan-400 leading-relaxed" data-lang-key="withdrawal_info_details">
                    Withdrawals are processed within 24 hours. Minimum withdrawal is <span id="min-withdrawal-text" class="text-cyan-300 font-bold">$5.00</span>.
                 </p>
            </div>
        </div>
    </div>
    <div class="neo-card p-5 rounded-2xl space-y-4">
        <h3 class="font-semibold text-app-text" data-lang-key="enter_withdrawal_details">Enter Withdrawal Details</h3>
        <input type="hidden" id="wd-method" value="">
        <button id="wd-method-selector" class="neo-input w-full p-3 rounded-xl text-left text-app-subtext flex justify-between items-center">
            <span id="wd-method-text" data-lang-key="select_withdrawal_method">Select Withdrawal Method</span>
            <i data-lucide="chevron-down" class="w-5 h-5"></i>
        </button>
        <input type="text" id="wd-address" placeholder="Your Wallet Address / Binance ID" class="neo-input w-full p-3 rounded-xl">
        <input type="number" id="wd-amount" placeholder="Amount to Withdraw (USD)" class="neo-input w-full p-3 rounded-xl">
        <button id="btn-submit-withdrawal" class="action-btn w-full py-4 rounded-xl text-lg bg-gradient-to-r from-cyan-500 to-blue-500" data-lang-key="submit_withdrawal">SUBMIT WITHDRAWAL</button>
    </div>
    <div class="pt-4">
        <h3 class="text-sm font-bold text-app-subtext mb-3 px-2" data-lang-key="withdrawal_history">Withdrawal History</h3>
        <div id="withdrawal-history-log" class="space-y-2"></div>
    </div>
</div>

<!-- PROFILE VIEW -->
<div id="view-profile" class="app-view space-y-6">
    <div class="flex flex-col items-center pt-6">
         <div class="relative mb-4">
            <div class="w-28 h-28 rounded-full p-1 bg-gradient-to-tr from-indigo-400 to-cyan-400">
                 <img id="profile-user-img" src="" class="w-full h-full rounded-full bg-app-bg object-cover p-1 hidden" alt="Profile">
                 <div id="profile-user-initials" class="w-full h-full rounded-full bg-slate-700 flex items-center justify-center text-4xl font-bold text-slate-300 border-4 border-app-bg"></div>
            </div>
        </div>
        <div id="profile-name-display" class="text-2xl font-bold text-app-text text-center flex items-center gap-2">Loading...</div>
        <button id="btn-copy-uid" class="mt-2 text-xs text-app-subtext bg-slate-800 px-3 py-1 rounded-full flex items-center gap-1 hover:bg-slate-700 transition">
            UID: <span id="uid-display">...</span> <i data-lucide="copy" class="w-3 h-3"></i>
        </button>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-app-subtext uppercase" data-lang-key="total_tasks">Total Tasks</p>
            <p id="stat-tasks" class="text-md font-bold text-cyan-400">0</p>
        </div>
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-app-subtext uppercase" data-lang-key="total_income_stat">Total Income</p>
            <p id="stat-income" class="text-md font-bold text-yellow-400">$0.00</p>
        </div>
        <div class="neo-card p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-app-subtext uppercase" data-lang-key="total_referrals">Total Referrals</p>
            <p id="stat-referrals" class="text-md font-bold text-emerald-400">0</p>
        </div>
    </div>
    <div class="space-y-3">
        <button onclick="switchView('view-features')" class="neo-card w-full p-4 rounded-xl flex items-center justify-between transition hover:bg-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-orange-500/10 text-orange-400"><i data-lucide="zap" class="w-5 h-5"></i></div>
                <span class="font-medium text-app-text" data-lang-key="advanced_features">Advanced Features</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-500"></i>
        </button>
         <button onclick="switchView('view-settings')" class="neo-card w-full p-4 rounded-xl flex items-center justify-between transition hover:bg-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-gray-500/10 text-gray-400"><i data-lucide="settings" class="w-5 h-5"></i></div>
                <span class="font-medium text-app-text" data-lang-key="settings">Settings</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-500"></i>
        </button>
        <button onclick="openSupport()" class="neo-card w-full p-4 rounded-xl flex items-center justify-between transition hover:bg-slate-700/50">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-400"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium text-app-text" data-lang-key="support_hub">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-500"></i>
        </button>
    </div>
</div>

<!-- SETTINGS VIEW -->
<div id="view-settings" class="app-view space-y-6">
    <div class="flex items-center gap-3 mb-6">
        <button onclick="switchView('view-profile')" class="p-2 rounded-full bg-slate-800 text-app-subtext"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold text-app-text" data-lang-key="settings">Settings</h2>
    </div>
    <div class="neo-card p-5 rounded-2xl space-y-4">
        <div>
            <label class="text-sm font-medium text-app-subtext" data-lang-key="language">Language</label>
            <select id="language-switcher" class="neo-input w-full p-3 rounded-xl mt-2">
                <option value="en">English</option>
                <option value="bn">বাংলা</option>
                <option value="hi">हिंदी</option>
            </select>
        </div>
        <div>
            <label class="text-sm font-medium text-app-subtext" data-lang-key="currency">Currency</label>
            <select id="currency-switcher" class="neo-input w-full p-3 rounded-xl mt-2">
                <option value="USD">USD ($)</option>
                <option value="INR">INR (₹)</option>
                <option value="BDT">BDT (৳)</option>
            </select>
        </div>
        <div>
            <label class="text-sm font-medium text-app-subtext" data-lang-key="theme">Theme</label>
            <select id="theme-switcher" class="neo-input w-full p-3 rounded-xl mt-2">
                <option value="dark" data-lang-key="dark">Dark</option>
                <option value="light" data-lang-key="light">Light</option>
            </select>
        </div>
        <button onclick="openContact()" class="action-btn w-full py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="mail" class="w-5 h-5"></i><span data-lang-key="contact">CONTACT</span>
        </button>
    </div>
</div>


<!-- FEATURES VIEW (Transfer) -->
<div id="view-features" class="app-view space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchView('view-profile')" class="p-2 rounded-full bg-slate-800 text-app-subtext"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold text-app-text" data-lang-key="tools_services">Tools & Services</h2>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <button onclick="switchView('subview-send')" class="neo-card p-5 rounded-2xl flex flex-col items-center gap-3 hover:border-indigo-400 transition group">
            <div class="w-14 h-14 rounded-full bg-indigo-500/10 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all text-indigo-400">
                <i data-lucide="send" class="w-7 h-7 ml-1"></i>
            </div>
            <span class="font-semibold text-app-text" data-lang-key="p2p_transfer">P2P Transfer</span>
        </button>
        <button onclick="switchView('view-extra-income')" class="neo-card p-5 rounded-2xl flex flex-col items-center gap-3 transition group attractive-glow-button">
            <div class="w-14 h-14 rounded-full bg-yellow-500/10 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-white transition-all text-yellow-400">
                <i data-lucide="trending-up" class="w-7 h-7"></i>
            </div>
            <span class="font-semibold text-app-text" data-lang-key="extra_income">Extra Income</span>
        </button>
    </div>
    <div class="neo-card p-5 rounded-2xl mt-4 bg-slate-800/50">
         <h3 class="font-bold text-app-text mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> <span data-lang-key="recent_activities">Recent Activities</span></h3>
         <div id="activity-log" class="space-y-3 text-sm text-app-subtext text-center py-4 max-h-60 overflow-y-auto">
             No recent activities found.
         </div>
    </div>
</div>

<!-- SUBVIEW: P2P SEND -->
<div id="subview-send" class="app-view space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchView('view-features')" class="p-2 rounded-full bg-slate-800 text-app-subtext"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold text-app-text" data-lang-key="transfer_balance">Transfer Balance</h2>
    </div>
    <div class="neo-card p-6 rounded-3xl space-y-5">
        <div class="bg-yellow-500/10 text-yellow-300 p-3 rounded-xl text-sm flex gap-2 items-start">
            <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0"></i>
            <p data-lang-key="transfer_fee_note">Default transfer fee is <strong>5%</strong>. Minimum transfer is <strong>$0.50</strong>. Upgraded members get fee discounts.</p>
        </div>
        <div>
            <label class="text-xs text-app-subtext ml-2 mb-1 block" data-lang-key="recipient_uid">Recipient UID</label>
            <input type="text" id="p2p-uid" placeholder="Enter User ID" class="neo-input w-full p-4 rounded-xl font-mono">
        </div>
         <div>
            <label class="text-xs text-app-subtext ml-2 mb-1 block" data-lang-key="amount">Amount</label>
            <input type="number" id="p2p-amount" placeholder="0.00" class="neo-input w-full p-4 rounded-xl font-bold text-lg">
            <p id="p2p-fee-calc" class="text-right text-xs text-app-subtext mt-2 h-4"></p>
        </div>
        <button id="btn-exec-p2p" class="action-btn w-full py-4 rounded-xl text-lg" data-lang-key="confirm_transfer">CONFIRM TRANSFER</button>
    </div>
</div>

<!-- GET EXTRA INCOME VIEW -->
<div id="view-extra-income" class="app-view space-y-6">
    <div class="flex items-center gap-3 mb-6">
       <button onclick="switchView('view-profile')" class="p-2 rounded-full bg-slate-800 text-app-subtext"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
       <h2 class="text-xl font-bold text-app-text" data-lang-key="extra_income_tiers">Extra Income Tiers</h2>
    </div>
    <div id="income-tiers-container" class="space-y-4">
        <!-- Tiers will be dynamically loaded here -->
    </div>
</div>

<!-- NEWS VIEW -->
<div id="view-news" class="app-view space-y-4">
    <h2 class="text-2xl font-bold px-2 text-app-text" data-lang-key="latest_news">Latest News</h2>
    <div id="news-feed" class="space-y-4">
        <!-- News will be loaded here from Firebase -->
    </div>
</div>

</main>

<!-- DOCK NAVIGATION -->
<nav class="dock-nav">
    <button class="dock-item nav-active" data-target="view-dashboard">
        <i data-lucide="home" class="w-6 h-6"></i>
        <span data-lang-key="home">Home</span>
    </button>
    <button class="dock-item" data-target="view-tasks">
        <i data-lucide="clipboard-check" class="w-6 h-6"></i>
        <span data-lang-key="tasks">Tasks</span>
    </button>
     <button class="dock-item" data-target="view-refer">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span data-lang-key="refer">Refer</span>
    </button>
    <button class="dock-item" data-target="view-news">
        <i data-lucide="rss" class="w-6 h-6"></i>
        <span data-lang-key="news">News</span>
    </button>
    <button class="dock-item" data-target="view-profile">
        <i data-lucide="user-circle" class="w-6 h-6"></i>
        <span data-lang-key="account">Account</span>
    </button>
</nav>
</div>

<!-- GENERIC MODAL -->
<div id="nexus-modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="glass-modal w-full max-w-sm p-6 rounded-3xl relative transform scale-95 transition-all duration-300" id="modal-content">
        <div id="modal-body"></div>
        <button id="modal-close" class="absolute top-4 right-4 p-1 rounded-full bg-slate-700 text-slate-400 hover:text-white">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, onSnapshot, updateDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- CONFIGURATION ---
    let MIN_DEPOSIT_AMT = 10;
    let MIN_WITHDRAWAL_AMT = 5;
    let MIN_REFERRALS_FOR_WITHDRAWAL = 2;
    let REFERRAL_BONUS = 1;
    let TASK_REWARD = 0.5;
    const P2P_FEE_PERCENT = 0.05; // 5%
    const MIN_P2P_AMT = 0.5;
    const ADMIN_ID = "CUb4r6eg1RV6Ljkj5U2V1cSswng1";
    const USD_TO_BDT_RATE = 126;

    let membershipTiers = {
        free: { name: 'Free', price: 0,  level: 0, duration: 3, taskLimit: 1, benefits: { feeReduction: 0, benefit_text_1: "Daily Task Limit: 1" } },
        try: { name: 'Try', price: 10,  level: 1, duration: 30, taskLimit: 2, benefits: { feeReduction: 0.01, benefit_text_1: "Daily Task Limit: 2" } },
        pro: { name: 'Pro', price: 30, level: 3, duration: 30, taskLimit: 6, benefits: { feeReduction: 0.03, benefit_text_1: "Daily Task Limit: 6" } },
        super: { name: 'Super', price: 50, level: 5, duration: 30, taskLimit: 10, benefits: { feeReduction: 0.05, benefit_text_1: "Daily Task Limit: 10" } }
    };

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBvbP66g1BYLQEj2XOJRA21meZN4ioJKpc",
      authDomain: "reward-claim-2cc72.firebaseapp.com",
      databaseURL: "https://reward-claim-2cc72-default-rtdb.firebaseio.com",
      projectId: "reward-claim-2cc72",
      storageBucket: "reward-claim-2cc72.firebasestorage.app",
      messagingSenderId: "158110437555",
      appId: "1:158110437555:web:e7c671b33fc0b7b24120c6"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let tgSession = null;
    let userData = null;
    let sysConfig = {};
    let activeTimers = [];
    let firebaseUser = null;

    // --- LANGUAGE & CURRENCY ---
    const translations = {
        en: {
            reward_claim_title: "REWARD CLAIM",
            establishing_connection: "Establishing Secure Connection...",
            help_center: "Help Center",
            priority_support: "24/7 Priority Support",
            deposit: "Deposit",
            withdrawal: "Withdrawal",
            support_hub: "Support Hub",
            visit_website: "Visit Website",
            extra_income: "Extra Income",
            welcome_back: "Welcome back,",
            fund: "FUND",
            welcome: "Welcome!",
            unlock_potential: "Unlock Your Earning Potential",
            total_active_members: "TOTAL ACTIVE MEMBERS",
            total_visit: "TOTAL VISIT",
            total_user: "TOTAL USER",
            total_income: "TOTAL INCOME",
            unlock_dashboard: "UNLOCK FULL DASHBOARD",
            top_earners: "Top Earners",
            top_referrers: "Top Referrers",
            available_balance: "Available Balance",
            withdraw: "WITHDRAW",
            live_withdrawals: "Live Withdrawals",
            daily_tasks: "Daily Tasks",
            complete_tasks_to_earn: "Complete simple tasks to earn rewards",
            have_referral_code: "Have a Referral Code?",
            enter_friend_code: "Enter your friend's code below. You both will receive <span id='referral-bonus-text' class='text-emerald-400 font-bold'>$1.00</span> instantly!",
            verify_claim: "VERIFY & CLAIM",
            total_referrals: "Total Referrals",
            referral_earnings: "Referral Earnings",
            your_referral_link: "Your Unique Referral Link",
            your_referrals: "Your Referrals",
            add_funds: "Add Funds",
            secure_top_up: "Secure & Fast Balance Top-up",
            important_note: "IMPORTANT NOTE",
            deposit_note: "Please use a valid payment method. Minimum deposit is <span id='min-deposit-text' class='text-indigo-300 font-bold'>$10.00</span>.",
            tap_to_copy: "Tap to Copy",
            submit_verification_info: "Submit Verification Info",
            select_payment_method: "Select Payment Method",
            verify_deposit: "VERIFY DEPOSIT",
            transaction_history: "Transaction History",
            withdraw_funds: "Withdraw Funds",
            request_withdrawal_to_wallet: "Request a withdrawal to your wallet",
            withdrawal_info: "WITHDRAWAL INFO",
            withdrawal_info_details: "Withdrawals are processed within 24 hours. Minimum withdrawal is <span id='min-withdrawal-text' class='text-cyan-300 font-bold'>$5.00</span>.",
            enter_withdrawal_details: "Enter Withdrawal Details",
            select_withdrawal_method: "Select Withdrawal Method",
            submit_withdrawal: "SUBMIT WITHDRAWAL",
            withdrawal_history: "Withdrawal History",
            total_tasks: "Total Tasks",
            total_income_stat: "Total Income",
            advanced_features: "Advanced Features",
            settings: "Settings",
            language: "Language",
            currency: "Currency",
            theme: "Theme",
            dark: "Dark",
            light: "Light",
            contact: "CONTACT",
            tools_services: "Tools & Services",
            p2p_transfer: "P2P Transfer",
            recent_activities: "Recent Activities",
            transfer_balance: "Transfer Balance",
            transfer_fee_note: "Default transfer fee is <strong>5%</strong>. Minimum transfer is <strong>$0.50</strong>. Upgraded members get fee discounts.",
            recipient_uid: "Recipient UID",
            amount: "Amount",
            confirm_transfer: "CONFIRM TRANSFER",
            extra_income_tiers: "Extra Income Tiers",
            latest_news: "Latest News",
            home: "Home",
            tasks: "Tasks",
            refer: "Refer",
            news: "News",
            account: "Account"
        },
        bn: {
            reward_claim_title: "পুরস্কার দাবি",
            establishing_connection: "নিরাপদ সংযোগ স্থাপন করা হচ্ছে...",
            help_center: "সহায়তা কেন্দ্র",
            priority_support: "২৪/৭ অগ্রাধিকার সমর্থন",
            deposit: "জমা",
            withdrawal: "উত্তোলন",
            support_hub: "সাপোর্ট হাব",
            visit_website: "ওয়েবসাইট দেখুন",
            extra_income: "অতিরিক্ত আয়",
            welcome_back: "ফিরে আসার জন্য স্বাগতম,",
            fund: "অর্থ",
            welcome: "স্বাগতম!",
            unlock_potential: "আপনার আয়ের সম্ভাবনা আনলক করুন",
            total_active_members: "মোট সক্রিয় সদস্য",
            total_visit: "মোট পরিদর্শন",
            total_user: "মোট ব্যবহারকারী",
            total_income: "মোট আয়",
            unlock_dashboard: "সম্পূর্ণ ড্যাশবোর্ড আনলক করুন",
            top_earners: "শীর্ষ উপার্জনকারী",
            top_referrers: "শীর্ষ রেফারকারী",
            available_balance: "বর্তমান ব্যালেন্স",
            withdraw: "উত্তোলন",
            live_withdrawals: "লাইভ উত্তোলন",
            daily_tasks: "দৈনিক কাজ",
            complete_tasks_to_earn: "পুরস্কার অর্জনের জন্য সহজ কাজগুলি সম্পন্ন করুন",
            have_referral_code: "আপনার কি রেফারেল কোড আছে?",
            enter_friend_code: "নিচে আপনার বন্ধুর কোড লিখুন। আপনারা উভয়েই তাৎক্ষণিকভাবে <span id='referral-bonus-text' class='text-emerald-400 font-bold'>৳১০০</span> পাবেন!",
            verify_claim: "যাচাই করুন এবং দাবি করুন",
            total_referrals: "মোট রেফারেল",
            referral_earnings: "রেফারেল থেকে আয়",
            your_referral_link: "আপনার বিশেষ রেফারেল লিঙ্ক",
            your_referrals: "আপনার রেফারেলগুলো",
            add_funds: "অর্থ যোগ করুন",
            secure_top_up: "নিরাপদ এবং দ্রুত ব্যালেন্স টপ-আপ",
            important_note: "গুরুত্বপূর্ণ নোট",
            deposit_note: "অনুগ্রহ করে একটি বৈধ অর্থপ্রদানের পদ্ধতি ব্যবহার করুন। সর্বনিম্ন জমা হল <span id='min-deposit-text' class='text-indigo-300 font-bold'>৳১০০০</span>।",
            tap_to_copy: "কপি করতে আলতো চাপুন",
            submit_verification_info: "যাচাইকরণ তথ্য জমা দিন",
            select_payment_method: "অর্থপ্রদানের পদ্ধতি নির্বাচন করুন",
            verify_deposit: "জমা যাচাই করুন",
            transaction_history: "লেনদেনের ইতিহাস",
            withdraw_funds: "অর্থ উত্তোলন করুন",
            request_withdrawal_to_wallet: "আপনার ওয়ালেটে উত্তোলনের জন্য অনুরোধ করুন",
            withdrawal_info: "উত্তোলন তথ্য",
            withdrawal_info_details: "উত্তোলন ২৪ ঘণ্টার মধ্যে প্রক্রিয়া করা হয়। সর্বনিম্ন উত্তোলন হল <span id='min-withdrawal-text' class='text-cyan-300 font-bold'>৳৫০০</span>।",
            enter_withdrawal_details: "উত্তোলনের বিবরণ লিখুন",
            select_withdrawal_method: "উত্তোলন পদ্ধতি নির্বাচন করুন",
            submit_withdrawal: "উত্তোলনের জন্য জমা দিন",
            withdrawal_history: "উত্তোলনের ইতিহাস",
            total_tasks: "মোট কাজ",
            total_income_stat: "মোট আয়",
            advanced_features: "উন্নত বৈশিষ্ট্য",
            settings: "সেটিং",
            language: "ভাষা",
            currency: "মুদ্রা",
            theme: "থিম",
            dark: "ডার্ক",
            light: "লাইট",
            contact: "যোগাযোগ",
            tools_services: "সরঞ্জাম এবং পরিষেবা",
            p2p_transfer: "P2P স্থানান্তর",
            recent_activities: "সাম্প্রতিক কার্যকলাপ",
            transfer_balance: "ব্যালেন্স স্থানান্তর করুন",
            transfer_fee_note: "ডিফল্ট স্থানান্তর ফি <strong>৫%</strong>। সর্বনিম্ন স্থানান্তর হল <strong>৳৫০</strong>। আপগ্রেড করা সদস্যরা ফি ছাড় পান।",
            recipient_uid: "প্রাপকের UID",
            amount: "পরিমাণ",
            confirm_transfer: "স্থানান্তর নিশ্চিত করুন",
            extra_income_tiers: "অতিরিক্ত আয়ের স্তর",
            latest_news: "সর্বশেষ খবর",
            home: "হোম",
            tasks: "কাজ",
            refer: "রেফার",
            news: "খবর",
            account: "অ্যাকাউন্ট"
        },
        hi: {
            reward_claim_title: "इनाम का दावा",
            establishing_connection: "सुरक्षित कनेक्शन स्थापित हो रहा है...",
            help_center: "सहायता केंद्र",
            priority_support: "24/7 प्राथमिकता समर्थन",
            deposit: "जमा",
            withdrawal: "निकासी",
            support_hub: "समर्थन हब",
            visit_website: "वेबसाइट पर जाएं",
            extra_income: "अतिरिक्त आय",
            welcome_back: "वापस स्वागत है,",
            fund: "फंड",
            welcome: "स्वागत है!",
            unlock_potential: "अपनी कमाई की क्षमता को अनलॉक करें",
            total_active_members: "कुल सक्रिय सदस्य",
            total_visit: "कुल विज़िट",
            total_user: "कुल उपयोगकर्ता",
            total_income: "कुल आय",
            unlock_dashboard: "पूर्ण डैशबोर्ड अनलॉक करें",
            top_earners: "शीर्ष अर्जक",
            top_referrers: "शीर्ष रेफरर्स",
            available_balance: "उपलब्ध शेष राशि",
            withdraw: "निकालें",
            live_withdrawals: "लाइव निकासी",
            daily_tasks: "दैनिक कार्य",
            complete_tasks_to_earn: "पुरस्कार अर्जित करने के लिए सरल कार्यों को पूरा करें",
            have_referral_code: "क्या आपके पास रेफरल कोड है?",
            enter_friend_code: "नीचे अपने मित्र का कोड दर्ज करें। आप दोनों को तुरंत <span id='referral-bonus-text' class='text-emerald-400 font-bold'>₹80</span> मिलेंगे!",
            verify_claim: "सत्यापित करें और दावा करें",
            total_referrals: "कुल रेफरल",
            referral_earnings: "रेफरल आय",
            your_referral_link: "आपका अनूठा रेफरल लिंक",
            your_referrals: "आपके रेफरल",
            add_funds: "धन जोड़ें",
            secure_top_up: "सुरक्षित और तेज़ बैलेंस टॉप-अप",
            important_note: "महत्वपूर्ण लेख",
            deposit_note: "कृपया एक वैध भुगतान विधि का उपयोग करें। न्यूनतम जमा <span id='min-deposit-text' class='text-indigo-300 font-bold'>₹800</span> है।",
            tap_to_copy: "कॉपी करने के लिए टैप करें",
            submit_verification_info: "सत्यापन जानकारी जमा करें",
            select_payment_method: "भुगतान विधि चुनें",
            verify_deposit: "जमा सत्यापित करें",
            transaction_history: "लेनदेन का इतिहास",
            withdraw_funds: "धन निकालना",
            request_withdrawal_to_wallet: "अपने वॉलेट में निकासी का अनुरोध करें",
            withdrawal_info: "निकासी की जानकारी",
            withdrawal_info_details: "निकासी 24 घंटों के भीतर संसाधित की जाती है। न्यूनतम निकासी <span id='min-withdrawal-text' class='text-cyan-300 font-bold'>₹400</span> है।",
            enter_withdrawal_details: "निकासी विवरण दर्ज करें",
            select_withdrawal_method: "निकासी विधि चुनें",
            submit_withdrawal: "निकासी जमा करें",
            withdrawal_history: "निकासी का इतिहास",
            total_tasks: "कुल कार्य",
            total_income_stat: "कुल आय",
            advanced_features: "उन्नत विशेषताएँ",
            settings: "सेटिंग्स",
            language: "भाषा",
            currency: "मुद्रा",
            theme: "थीम",
            dark: "डार्क",
            light: "लाइट",
            contact: "संपर्क",
            tools_services: "उपकरण और सेवाएं",
            p2p_transfer: "P2P स्थानांतरण",
            recent_activities: "हाल की गतिविधियाँ",
            transfer_balance: "शेष राशि स्थानांतरित करें",
            transfer_fee_note: "डिफ़ॉल्ट स्थानांतरण शुल्क <strong>5%</strong> है। न्यूनतम स्थानांतरण <strong>₹40</strong> है। उन्नत सदस्यों को शुल्क छूट मिलती है।",
            recipient_uid: "प्राप्तकर्ता यूआईडी",
            amount: "रकम",
            confirm_transfer: "स्थानांतरण की पुष्टि करें",
            extra_income_tiers: "अतिरिक्त आय स्तर",
            latest_news: "ताज़ा खबर",
            home: "होम",
            tasks: "कार्य",
            refer: "रेफर",
            news: "समाचार",
            account: "खाता"
        }
    };
    let currentLanguage = 'en';
    let currentCurrency = 'USD';

    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (translations[lang][key]) {
                el.innerHTML = translations[lang][key];
            }
        });
        updateAllCurrencyDisplays();
    }

    function setCurrency(currency) {
        currentCurrency = currency;
        localStorage.setItem('currency', currency);
        updateAllCurrencyDisplays();
    }

    function formatCurrency(amount) {
        let convertedAmount = amount;
        let symbol = '$';
        switch (currentCurrency) {
            case 'INR':
                convertedAmount = amount * (USD_TO_BDT_RATE / 1.5); // Approximate conversion
                symbol = '₹';
                break;
            case 'BDT':
                convertedAmount = amount * USD_TO_BDT_RATE;
                symbol = '৳';
                break;
        }
        return `${symbol}${convertedAmount.toFixed(2)}`;
    }

    function updateAllCurrencyDisplays() {
        if(userData) {
            const bal = userData.balance;
            document.getElementById('main-balance-display').textContent = formatCurrency(bal);
            document.getElementById('user-balance-top').textContent = formatCurrency(bal);
        }
    }

    function setTheme(theme) {
        localStorage.setItem('theme', theme);
        if (theme === 'light') {
            document.body.classList.add('light-theme');
        } else {
            document.body.classList.remove('light-theme');
        }
    }


    // --- CORE FUNCTIONS ---
    window.onload = async () => {
        // Load preferences
        const savedLang = localStorage.getItem('language') || 'en';
        const savedCurrency = localStorage.getItem('currency') || 'USD';
        const savedTheme = localStorage.getItem('theme') || 'dark';

        document.getElementById('language-switcher').value = savedLang;
        document.getElementById('currency-switcher').value = savedCurrency;
        document.getElementById('theme-switcher').value = savedTheme;
        
        setTheme(savedTheme);

        try {
            if(window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('#0f172a'); // Dark theme header
                window.Telegram.WebApp.setBackgroundColor('#0f172a'); // Dark theme background
                if (window.Telegram.WebApp.initDataUnsafe?.user) {
                    tgSession = window.Telegram.WebApp.initDataUnsafe.user;
                }
            }
        } catch (e) {
            console.error("Telegram WebApp initialization failed:", e);
        }

        if (!tgSession) {
            document.body.innerHTML = `
            <div class="flex flex-col items-center justify-center h-screen text-center p-4">
                <div class="neo-card p-8 rounded-2xl w-full max-w-sm">
                    <i data-lucide="alert-triangle" class="w-16 h-16 mb-4 mx-auto text-red-500"></i>
                    <h1 class="text-2xl font-bold text-red-400">Authentication Failed</h1>
                    <p class="text-app-subtext text-sm font-normal mt-2">Could not identify user. Please launch this app through the official Telegram bot.</p>
                </div>
            </div>`;
            lucide.createIcons();
            return;
        }

        try {
            const userCredential = await signInAnonymously(auth);
            firebaseUser = userCredential.user;
            await initializeAppLogic();
            setLanguage(savedLang);
            setCurrency(savedCurrency);
        } catch (error) {
            console.error("Firebase Anonymous Auth Failed:", error);
            document.getElementById('loading-msg').innerText = 'Connection Error. Please restart.';
        }
    };

    async function initializeAppLogic() {
        await loadConfig();
        await initSession();
        setupInteractions();
        lucide.createIcons();
        initLiveWithdrawalFeed();
        
        const depositsQuery = query(collection(db, "deposits"), where("userId", "==", userData.tgChatId), where("status", "==", "approved"), limit(1));
        const depositSnap = await getDocs(depositsQuery);
        const hasApprovedDeposit = !depositSnap.empty;

        const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
        const hasActiveTier = userData.hasActiveMembership && userData.membershipTier !== 'free' && !isMemberExpired;

        if (!hasApprovedDeposit && !hasActiveTier) {
            switchView('view-landing');
        } else {
            switchView('view-dashboard');
        }

        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('splash-screen').remove(), 500);
    }

    async function initSession() {
        const uid = String(tgSession.id);
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);

        if (snap.exists()) {
            userData = snap.data();
            if (!userData.firebaseUid || userData.firebaseUid !== firebaseUser.uid) {
                await updateDoc(userRef, { firebaseUid: firebaseUser.uid });
                userData.firebaseUid = firebaseUser.uid;
            }
        } else {
            userData = {
                tgChatId: uid,
                firebaseUid: firebaseUser.uid,
                name: `${tgSession.first_name} ${tgSession.last_name || ''}`.trim(),
                username: tgSession.username || null,
                balance: 0,
                createdAt: serverTimestamp(),
                hasActiveMembership: false,
                membershipTier: 'free',
                membershipExpiry: null,
                lastNotificationCheck: null,
                dailyCompletedTasks: [],
                referredBy: null
            };
            await setDoc(userRef, userData);
        }

        if(userData.isBlocked) {
            document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-red-500 font-bold">ACCOUNT SUSPENDED</div>';
            throw new Error("User account is blocked.");
        }

        updateDashboard();
        initRealtimeListeners();
        checkNewNotifications();
        checkFreeTrialExpiry();
    }

    async function loadConfig() {
        try {
            const configRef = doc(db, "config", "main");
            const configSnap = await getDoc(configRef);
            if (configSnap.exists()) {
                const configData = configSnap.data();
                sysConfig = configData;

                MIN_DEPOSIT_AMT = sysConfig.minDeposit || 10;
                MIN_WITHDRAWAL_AMT = sysConfig.minWithdrawal || 5;
                MIN_REFERRALS_FOR_WITHDRAWAL = sysConfig.minReferralsForWithdrawal || 2;
                REFERRAL_BONUS = sysConfig.referralBonus || 1;
                TASK_REWARD = sysConfig.taskReward || 0.5;

                document.getElementById('min-deposit-text').textContent = `$${MIN_DEPOSIT_AMT.toFixed(2)}`;
                document.getElementById('min-withdrawal-text').textContent = `$${MIN_WITHDRAWAL_AMT.toFixed(2)}`;
                const withdrawalInfoText = `Withdrawals are processed within 24 hours. Minimum withdrawal is <span class="font-bold">$${MIN_WITHDRAWAL_AMT.toFixed(2)}</span>. You need at least <span class="font-bold">${MIN_REFERRALS_FOR_WITHDRAWAL}</span> referrals to withdraw.`;
                document.getElementById('withdrawal-info-text').innerHTML = withdrawalInfoText;
                
                if(configData.membershipTiers) {
                     Object.keys(membershipTiers).forEach(key => {
                        if(configData.membershipTiers[key]) {
                            const remoteTier = configData.membershipTiers[key];
                            membershipTiers[key].price = remoteTier.price !== undefined ? remoteTier.price : membershipTiers[key].price;
                            membershipTiers[key].duration = remoteTier.duration !== undefined ? remoteTier.duration : membershipTiers[key].duration;
                            membershipTiers[key].taskLimit = remoteTier.taskLimit !== undefined ? remoteTier.taskLimit : membershipTiers[key].taskLimit;
                            if(remoteTier.benefits) {
                                membershipTiers[key].benefits = {...membershipTiers[key].benefits, ...remoteTier.benefits};
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error("Could not load remote config, using defaults.", error);
        }
    }

    function updateDashboard() {
        if(!userData) return;
        updateAllCurrencyDisplays();

        const initials = (tgSession.first_name?.[0] || 'U') + (tgSession.last_name?.[0] || '');
        document.getElementById('nav-user-initials').textContent = initials.toUpperCase();
        document.getElementById('profile-user-initials').textContent = initials.toUpperCase();

        if(tgSession.photo_url) {
            document.getElementById('nav-user-img').src = tgSession.photo_url;
            document.getElementById('nav-user-img').classList.remove('hidden');
            document.getElementById('nav-user-initials').classList.add('hidden');
            document.getElementById('profile-user-img').src = tgSession.photo_url;
            document.getElementById('profile-user-img').classList.remove('hidden');
            document.getElementById('profile-user-initials').classList.add('hidden');
        }

        const profileNameEl = document.getElementById('profile-name-display');
        const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
        
        if (userData.hasActiveMembership && userData.membershipTier !== 'free' && !isMemberExpired) {
             profileNameEl.innerHTML = `
                <span>${userData.name}</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                  <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.491 4.491 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" style="color: #3b82f6;"></path>
                </svg>`;
        } else {
            if(userData.hasActiveMembership && isMemberExpired){
                updateDoc(doc(db, "users", userData.tgChatId), { hasActiveMembership: false, membershipTier: 'free', membershipExpiry: null });
            }
            profileNameEl.innerHTML = `<span>${userData.name}</span>`;
        }
        document.getElementById('uid-display').textContent = userData.tgChatId;
    }
    
    function checkFreeTrialExpiry() {
        if (!userData || !userData.createdAt || userData.membershipTier !== 'free' || !(userData.createdAt.toDate)) return;

        const accountCreationDate = userData.createdAt.toDate();
        const trialEndDate = new Date(accountCreationDate);
        const trialDurationDays = membershipTiers.free.duration;
        trialEndDate.setDate(trialEndDate.getDate() + trialDurationDays);

        if (new Date() > trialEndDate) {
            const modalHTML = `
                <div class="text-center space-y-4">
                    <i data-lucide="clock" class="w-12 h-12 mx-auto text-yellow-400"></i>
                    <h3 class="text-xl font-bold">Free Trial Ended</h3>
                    <p class="text-app-subtext">Your ${trialDurationDays}-day free trial has expired. Please upgrade to a higher tier to continue earning rewards.</p>
                    <button onclick="switchView('view-extra-income'); closeModal();" class="action-btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">View Tiers</button>
                </div>
            `;
            showModal(modalHTML, false);
        }
    }

    window.switchView = function(viewId) {
        activeTimers.forEach(timerId => clearInterval(timerId));
        activeTimers = [];

        document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
        
        const dockNav = document.querySelector('.dock-nav');
        const header = document.querySelector('header');
        
        if (viewId === 'view-landing') {
            if (dockNav) dockNav.style.display = 'none';
            if (header) header.style.display = 'none';
        } else {
            if (dockNav) dockNav.style.display = 'flex';
            if (header) header.style.display = 'flex';
        }

        const mainViews = ['view-dashboard', 'view-tasks', 'view-refer', 'view-news', 'view-profile'];
        if (mainViews.includes(viewId)) {
            document.querySelectorAll('.dock-item').forEach(btn => {
                btn.classList.toggle('nav-active', btn.dataset.target === viewId);
            });
        }
        
        const topDepositBtn = document.querySelector('header .flex.items-center.gap-2 > button:first-child');
        if (topDepositBtn) {
           topDepositBtn.style.display = (viewId === 'view-deposit' || viewId === 'view-withdrawal' || viewId === 'view-settings') ? 'none' : 'inline-flex';
        }
        
        if(viewId === 'view-tasks') loadTasksView();
        if(viewId === 'view-deposit') loadDepositHistory();
        if(viewId === 'view-withdrawal') loadWithdrawalHistory();
        if(viewId === 'view-profile') loadProfileStats();
        if(viewId === 'view-news') loadNewsFeed();
        if(viewId === 'view-extra-income') loadIncomeTiers('income-tiers-container');
        if(viewId === 'view-features') loadActivityLog();
        if(viewId === 'view-refer') {
            loadReferralView();
            loadMyReferrals();
        }

        window.scrollTo(0,0);
    }
    
    async function loadMyReferrals() {
        const container = document.getElementById('my-referrals-list');
        if (!container) return;
        container.innerHTML = `<p class="text-center text-app-subtext p-4">Loading your referrals...</p>`;

        try {
            const q = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = `<div class="neo-card text-center p-6 rounded-2xl"><p class="text-app-subtext">You haven't referred anyone yet. Share your link to start earning!</p></div>`;
                return;
            }

            let referralsHtml = '';
            for (const docSnap of querySnapshot.docs) {
                const referredUser = docSnap.data();
                const userInitials = (referredUser.name.split(' ')[0]?.[0] || 'U') + (referredUser.name.split(' ')[1]?.[0] || '');
                
                const referredUserRef = doc(db, "users", referredUser.tgChatId);
                const referredUserSnap = await getDoc(referredUserRef);
                const fullReferredUserData = referredUserSnap.exists() ? referredUserSnap.data() : { balance: 0 };


                referralsHtml += `
                <div class="neo-card p-3 rounded-2xl flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                         <div class="w-12 h-12 rounded-full bg-slate-700 flex-shrink-0 flex items-center justify-center font-bold text-slate-300 text-lg">
                           ${userInitials}
                         </div>
                         <div>
                            <p class="font-semibold text-md text-app-text">${referredUser.name}</p>
                            <p class="text-xs text-app-subtext">User ID: ${referredUser.tgChatId}</p>
                         </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-emerald-400">${formatCurrency(fullReferredUserData.balance || 0)}</p>
                        <p class="text-xs text-app-subtext" data-lang-key="balance">Balance</p>
                    </div>
                </div>
                `;
            }

            container.innerHTML = referralsHtml;
            lucide.createIcons();

        } catch (error) {
            console.error("Error loading my referrals:", error);
            container.innerHTML = `<p class="text-center text-red-500 p-4">Could not load your referrals.</p>`;
        }
    }
    
    function loadTasksView() {
        if (userData.membershipTier === 'free' && userData.createdAt && userData.createdAt.toDate) {
            const accountCreationDate = userData.createdAt.toDate();
            const trialEndDate = new Date(accountCreationDate);
            trialEndDate.setDate(trialEndDate.getDate() + membershipTiers.free.duration);
            if (new Date() > trialEndDate) {
                checkFreeTrialExpiry();
                document.getElementById('task-list').innerHTML = '';
                return;
            }
        }
        
        const taskListContainer = document.getElementById('task-list');
        window.startTask = startTask;

        const taskReward = TASK_REWARD;
        const taskLink = sysConfig.taskLink || "https://adexora.my.id/dl/AqMmpgSA5cUt";
        
        let taskLimit = membershipTiers.free.taskLimit;
        const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
        
        if (userData.hasActiveMembership && userData.membershipTier && !isMemberExpired) {
            taskLimit = membershipTiers[userData.membershipTier]?.taskLimit || taskLimit;
        }

        const today = new Date().toISOString().split('T')[0];
        const completedToday = (userData.dailyCompletedTasks || [])
            .filter(task => task.completedAt && new Date(task.completedAt.seconds * 1000).toISOString().split('T')[0] === today)
            .map(task => task.taskId);
        
        let firstPendingTask = null;
        
        for (let i = 1; i <= taskLimit; i++) {
            const taskId = `daily_task_${i}`;
            if (!completedToday.includes(taskId)) {
                firstPendingTask = { id: taskId, title: `Task ${i}`, reward: taskReward, link: taskLink };
                break;
            }
        }

        let tasksHTML = Array.from({ length: taskLimit }, (_, i) => {
            const taskId = `daily_task_${i + 1}`;
            const isCompleted = completedToday.includes(taskId);
            const task = { id: taskId, title: `Task ${i + 1}`, reward: taskReward, link: taskLink };
            const isFirstPending = firstPendingTask && task.id === firstPendingTask.id;

            let buttonHTML;
            if (isCompleted) {
                buttonHTML = `<button class="bg-emerald-500/10 text-emerald-400 px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Completed</button>`;
            } else if (isFirstPending) {
                buttonHTML = `<button onclick='startTask(${JSON.stringify(task)}, this)' class="action-btn animated-task-button px-5 py-2 rounded-lg text-sm">UPDATE</button>`;
            } else {
                buttonHTML = `<button class="bg-slate-700 text-slate-400 px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Locked</button>`;
            }

            return `
                <div class="neo-card flex items-center justify-between p-3 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/10 p-3 rounded-full">
                             <i data-lucide="arrow-up-right-square" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-app-text">${task.title}</h3>
                            <p class="text-yellow-400 font-bold text-sm">Reward: ${formatCurrency(task.reward)}</p>
                        </div>
                    </div>
                    ${buttonHTML}
                </div>
            `;
        }).join('');
        
        taskListContainer.innerHTML = tasksHTML;
        
        if (completedToday.length >= taskLimit) {
            const newTasksCardHTML = `
                <div class="neo-card flex items-center justify-between p-3 rounded-xl mt-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/10 p-3 rounded-full">
                             <i data-lucide="clock" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-app-text">Tasks Reset In</h3>
                            <p id="new-task-countdown" class="text-cyan-400 font-bold text-sm font-mono">--:--:--</p>
                        </div>
                    </div>
                    <button onclick="switchView('view-extra-income')" class="action-btn px-5 py-2 rounded-lg text-sm">UPGRADE</button>
                </div>`;
            taskListContainer.innerHTML += newTasksCardHTML;
            startTaskCountdown();
        }

        lucide.createIcons();
    }
    
    async function initLiveWithdrawalFeed() {
        const container = document.getElementById('withdrawal-feed-container');
        if (!container) return;

        let allActivities = [];

        try {
            const fakeQ = query(collection(db, "fake_deposits"), limit(20));
            const fakeSnap = await getDocs(fakeQ);
            fakeSnap.forEach(doc => {
                allActivities.push({ ...doc.data(), isFake: true });
            });

            const realQ = query(collection(db, "withdrawals"), where("status", "==", "approved"), orderBy("requestedAt", "desc"), limit(10));
            const realSnap = await getDocs(realQ);
            realSnap.forEach(doc => {
                const data = doc.data();
                allActivities.push({ name: data.userName, amount: data.amount, isFake: false });
            });

            allActivities.sort(() => 0.5 - Math.random());

            if (allActivities.length === 0) {
                 container.innerHTML = '<p class="text-center text-app-subtext text-sm p-4">No recent activity.</p>';
                 return;
            }
            
            let currentIndex = 0;
            function showNextActivity() {
                if (allActivities.length === 0) return;
                const activity = allActivities[currentIndex];
                const name = activity.name.substring(0, 3) + '***';
                const timeAgo = Math.floor(Math.random() * 59) + 1;

                const item = document.createElement('div');
                item.className = 'neo-card p-3 rounded-xl flex items-center gap-3 animate-fade-in-down';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center">
                        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-app-text">
                            ${name} just withdrew <span class="text-cyan-400">${formatCurrency(activity.amount)}</span>
                        </p>
                        <p class="text-xs text-app-subtext">${timeAgo} seconds ago</p>
                    </div>`;
                
                container.prepend(item);
                lucide.createIcons();

                if (container.children.length > 10) {
                    container.lastChild.remove();
                }

                currentIndex = (currentIndex + 1) % allActivities.length;
            }

            showNextActivity();
            const feedInterval = setInterval(showNextActivity, Math.random() * (8000 - 4000) + 4000);
            activeTimers.push(feedInterval);

        } catch (e) {
            console.error("Failed to load activity feed:", e);
            container.innerHTML = '<p class="text-center text-red-500 text-sm">Could not load feed.</p>';
        }
    }
    
    async function loadDepositHistory() {
        const el = document.getElementById('deposit-history-log');
        const q = query(collection(db, "deposits"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { el.innerHTML = '<p class="text-app-subtext text-center text-xs py-2">No deposit history.</p>'; return; }

        el.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const statusColors = { pending: 'text-yellow-400', approved: 'text-emerald-400', rejected: 'text-red-400' };
            const date = data.requestedAt ? new Date(data.requestedAt.seconds * 1000).toLocaleDateString() : 'N/A';
            return `
            <div class="neo-card flex justify-between items-center p-3 rounded-xl">
                <div>
                    <p class="text-sm font-medium text-app-text">${data.method} - ${formatCurrency(data.amount)}</p>
                    <p class="text-[10px] text-app-subtext font-mono">${date}</p>
                </div>
                <span class="text-xs font-bold ${statusColors[data.status] || 'text-app-subtext'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }

    async function loadWithdrawalHistory() {
        const el = document.getElementById('withdrawal-history-log');
        el.innerHTML = '<p class="text-app-subtext text-center text-xs py-2">Loading history...</p>';
        const q = query(collection(db, "withdrawals"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { el.innerHTML = '<p class="text-app-subtext text-center text-xs py-2">No withdrawal history.</p>'; return; }

        el.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const statusColors = { pending: 'text-yellow-400', approved: 'text-emerald-400', rejected: 'text-red-400' };
            return `
            <div class="neo-card flex justify-between items-center p-3 rounded-xl">
                <div>
                    <p class="text-sm font-medium text-app-text">${data.method} - ${formatCurrency(data.amount)}</p>
                    <p class="text-[10px] text-app-subtext font-mono">${data.address}</p>
                </div>
                <span class="text-xs font-bold ${statusColors[data.status] || 'text-app-subtext'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }
    
    window.showModal = (html, showCloseButton = true) => {
        const modal = document.getElementById('nexus-modal');
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-close').style.display = showCloseButton ? 'block' : 'none';
        modal.style.pointerEvents = 'auto'; modal.style.opacity = '1';
        document.getElementById('modal-content').classList.remove('scale-95');
        document.getElementById('modal-content').classList.add('scale-100');
        lucide.createIcons();
    };

    window.closeModal = () => {
         const modal = document.getElementById('nexus-modal');
         modal.style.opacity = '0'; modal.style.pointerEvents = 'none';
         document.getElementById('modal-content').classList.add('scale-95');
         document.getElementById('modal-content').classList.remove('scale-100');
    };

    window.showLeaderboardModal = function(type) {
        let title, icon, listHTML;

        if (type === 'earners') {
            title = 'Top Earners';
            icon = '<i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>';
            const topEarners = [
                { name: 'John D.', amount: 2345.67, photo: 'https://i.pravatar.cc/150?img=1' },
                { name: 'Maria S.', amount: 2109.45, photo: 'https://i.pravatar.cc/150?img=2' },
                { name: 'Ahmed K.', amount: 1987.12, photo: 'https://i.pravatar.cc/150?img=3' },
                { name: 'Li W.', amount: 1850.00, photo: 'https://i.pravatar.cc/150?img=4' },
                { name: 'Sophia R.', amount: 1765.88, photo: 'https://i.pravatar.cc/150?img=5' },
            ];
            listHTML = topEarners.map((user, index) => `
                <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-6 text-center text-app-subtext">${index + 1}</span>
                        <img src="${user.photo}" class="w-10 h-10 rounded-full object-cover"/>
                        <span class="font-semibold text-app-text">${user.name}</span>
                    </div>
                    <span class="font-bold text-emerald-400">${formatCurrency(user.amount)}</span>
                </div>
            `).join('');
        } else {
            title = 'Top Referrers';
            icon = '<i data-lucide="users" class="w-6 h-6 text-cyan-400"></i>';
            const topReferrers = [
                { name: 'Mike T.', count: 152, photo: 'https://i.pravatar.cc/150?img=6' },
                { name: 'Isabella C.', count: 139, photo: 'https://i.pravatar.cc/150?img=7' },
                { name: 'Carlos G.', count: 121, photo: 'https://i.pravatar.cc/150?img=8' },
                { name: 'Fatima Z.', count: 115, photo: 'https://i.pravatar.cc/150?img=9' },
                { name: 'David L.', count: 98, photo: 'https://i.pravatar.cc/150?img=10' },
            ];
            listHTML = topReferrers.map((user, index) => `
                 <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg w-6 text-center text-app-subtext">${index + 1}</span>
                        <img src="${user.photo}" class="w-10 h-10 rounded-full object-cover"/>
                        <span class="font-semibold text-app-text">${user.name}</span>
                    </div>
                    <span class="font-bold text-cyan-400">${user.count} Referrals</span>
                </div>
            `).join('');
        }

        const modalHTML = `
            <div class="text-center space-y-4">
                <h3 class="text-xl font-bold flex items-center justify-center gap-2">${icon} ${title}</h3>
                <div class="space-y-2 max-h-80 overflow-y-auto text-left p-1">${listHTML}</div>
            </div>`;
        showModal(modalHTML);
    }

    function startTaskCountdown() {
        const timerElement = document.getElementById('new-task-countdown');
        if (!timerElement) return;

        const countdownInterval = setInterval(() => {
            const now = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow.getTime() - now.getTime();
            if (diff <= 0) {
                clearInterval(countdownInterval);
                timerElement.textContent = "00:00:00";
                loadTasksView();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
        activeTimers.push(countdownInterval);
    }
    
    function startTask(task, buttonElement) {
        buttonElement.disabled = true;
        window.open(task.link, '_blank');

        let countdown = 10;
        buttonElement.textContent = `Waiting (${countdown}s)`;
        const intervalId = setInterval(() => {
            countdown--;
            buttonElement.textContent = `Waiting (${countdown}s)`;
            if (countdown <= 0) {
                clearInterval(intervalId);
                completeTask(task);
            }
        }, 1000);
        activeTimers.push(intervalId);
    }
    
    async function completeTask(task) {
        if (!task) return;

        const today = new Date().toISOString().split('T')[0];
        const alreadyCompleted = (userData.dailyCompletedTasks || [])
            .some(t => t.taskId === task.id && t.completedAt && new Date(t.completedAt.seconds * 1000).toISOString().split('T')[0] === today);

        if (alreadyCompleted) {
            showToast(`This task has already been completed today.`, 'info');
            return;
        }

        try {
            const userRef = doc(db, "users", userData.tgChatId);
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists()) throw "User not found.";

                const currentData = userDoc.data();
                const newBalance = currentData.balance + task.reward;
                const newTaskEntry = { taskId: task.id, completedAt: Timestamp.fromDate(new Date()) };
                
                const existingTasks = Array.isArray(currentData.dailyCompletedTasks) ? currentData.dailyCompletedTasks : [];
                const updatedCompletedTasks = [...existingTasks, newTaskEntry];

                transaction.update(userRef, {
                    balance: newBalance,
                    dailyCompletedTasks: updatedCompletedTasks
                });
            });
            showToast(`Congratulations! You've earned ${formatCurrency(task.reward)}`, 'success');
            logPublicActivity(`earned ${formatCurrency(task.reward)} from a task.`);
        } catch (e) {
            console.error("Error completing task:", e);
            showToast(`Error: ${e.message || e}`, 'error');
            if (document.getElementById('view-tasks').classList.contains('active-view')) {
                loadTasksView();
            }
        }
    }

    async function submitDepositRequest(amount, sender, method, btn, callback) {
        if(!method || !amount || !sender) return showToast("Please fill all fields", "warning");
        if(amount < MIN_DEPOSIT_AMT) return showModal(`<div class="text-center text-red-400 space-y-3"><i data-lucide="alert-octagon" class="w-12 h-12 mx-auto"></i><h3 class="font-bold text-lg">Invalid Amount</h3><p class="text-app-text">Minimum deposit amount is <span class="font-bold text-app-text">${formatCurrency(MIN_DEPOSIT_AMT)}</span>.</p><button onclick="closeModal()" class="neo-card w-full py-2 rounded-xl mt-4">OK</button></div>`);

        btn.disabled = true; btn.innerText = "VERIFYING...";

        try {
            await addDoc(collection(db, "deposits"), {
                userId: userData.tgChatId,
                firebaseUid: userData.firebaseUid,
                userName: userData.name,
                method,
                amount,
                senderNumber: sender,
                status: "pending",
                requestedAt: serverTimestamp()
            });
            
            showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-400 mx-auto"></i><h3 class="text-lg font-bold text-app-text">Submitted!</h3><p class="text-app-subtext">Your deposit of ${formatCurrency(amount)} is under review. You will be notified upon approval.</p><button onclick="window.location.reload()" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
            
            if (callback) callback();

        } catch(e) { showToast(e.message, "error");
        } finally {
            btn.disabled = false; btn.innerText = "VERIFY DEPOSIT"; lucide.createIcons();
        }
    }

    async function loadReferralView() {
        const linkInput = document.getElementById('referral-link-display');
        const refCountEl = document.getElementById('ref-stat-count');
        const refEarningsEl = document.getElementById('ref-stat-earnings');
        
        document.getElementById('referral-bonus-text').textContent = formatCurrency(REFERRAL_BONUS);
        document.getElementById('referral-claim-bonus-text').textContent = formatCurrency(REFERRAL_BONUS);
        
        const referralLink = `https://t.me/Reward_Claimlbot/eaen?start=${userData.tgChatId}`;
        linkInput.value = referralLink;
        
        const inputSection = document.getElementById('referral-input-section');
        if (userData.referredBy) {
            const referrerRef = doc(db, "users", userData.referredBy);
            const referrerSnap = await getDoc(referrerRef);
            let referrerName = `UID: ${userData.referredBy}`;
            if(referrerSnap.exists()){
                referrerName = referrerSnap.data().name || `UID: ${userData.referredBy}`;
            }

            inputSection.innerHTML = `
                <h3 class="font-semibold text-app-text text-lg flex items-center justify-center gap-2"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>Referral Claimed</h3>
                <p class="text-sm text-app-subtext">You were referred by: <span class="font-semibold text-app-text">${referrerName}</span></p>
            `;
            lucide.createIcons();
        }
        
        async function getReferralStats() {
            try {
                const q = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId));
                const snap = await getDocs(q);
                
                refCountEl.textContent = snap.docs.length;
                const referralEarnings = snap.docs.length * REFERRAL_BONUS;
                refEarningsEl.textContent = formatCurrency(referralEarnings);
                
            } catch (error) {
                console.error("Error loading referral data:", error);
            }
        }
        
        getReferralStats();
    }

    async function verifyReferralCode() {
        const btn = document.getElementById('btn-verify-referral');
        const input = document.getElementById('referral-code-input');
        const code = input.value.trim();
        const rewardAmount = REFERRAL_BONUS;

        if (!code) return showToast("Please enter a referral code.", "warning");
        if (userData.referredBy) return showToast("You have already used a referral code.", "error");
        if (code === userData.tgChatId) return showToast("You cannot refer yourself.", "error");

        btn.disabled = true;
        btn.innerHTML = 'VERIFYING...';

        try {
            await runTransaction(db, async (transaction) => {
                const currentUserRef = doc(db, "users", userData.tgChatId);
                const referrerRef = doc(db, "users", code);

                const [currentUserDoc, referrerDoc] = await Promise.all([
                    transaction.get(currentUserRef),
                    transaction.get(referrerRef)
                ]);

                if (!currentUserDoc.exists()) throw new Error("Your user data could not be found.");
                if (!referrerDoc.exists()) throw new Error("The referral code is invalid or the user does not exist.");

                const currentUserData = currentUserDoc.data();
                if (currentUserData.referredBy) throw new Error("You have already claimed a referral bonus.");

                transaction.update(currentUserRef, {
                    balance: currentUserData.balance + rewardAmount,
                    referredBy: code
                });

                transaction.update(referrerRef, {
                    balance: referrerDoc.data().balance + rewardAmount
                });

                const logRef = doc(collection(db, "referral_logs"));
                transaction.set(logRef, {
                    referrerId: code,
                    referrerName: referrerDoc.data().name || 'A user',
                    refereeId: userData.tgChatId,
                    refereeName: userData.name,
                    reward: rewardAmount,
                    timestamp: serverTimestamp()
                });
            });

            showToast(`Success! You and your friend both earned ${formatCurrency(rewardAmount)}.`, 'success');
            userData.balance += rewardAmount;
            userData.referredBy = code;
            updateDashboard();
            loadReferralView();

        } catch (e) {
            showToast("Error: " + e.message, "error");
            btn.disabled = false;
            btn.innerHTML = `VERIFY & CLAIM <span id="referral-claim-bonus-text">${formatCurrency(REFERRAL_BONUS)}</span>`;
        }
    }
    
    window.shareOnTelegram = function() {
        const link = document.getElementById('referral-link-display').value;
        const text = "Join me on REWARD CLAIM and earn money! Use my link to sign up:";
        const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
        window.open(telegramUrl, '_blank');
    }

    window.shareLive = async function() {
        const link = document.getElementById('referral-link-display').value;
        const shareData = {
            title: 'Join REWARD CLAIM',
            text: 'Join me on REWARD CLAIM and earn money! Use my link to sign up:',
            url: link,
        };
        try {
            if (navigator.share) {
                await navigator.share(shareData);
            } else {
                throw new Error('Web Share API not supported');
            }
        } catch (err) {
            copyText(link);
            showToast('Share not supported, link copied instead!', 'info');
        }
    }

    async function checkNewNotifications() {
        const lastCheck = userData.lastNotificationCheck || Timestamp.fromDate(new Date(0));
        const q = query(
            collection(db, "notifications"),
            where("userId", "==", userData.tgChatId),
            where("createdAt", ">", lastCheck),
            limit(1)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
            document.getElementById('badge-notify').classList.remove('hidden');
        }
    }

    async function loadNotifications() {
        const q = query(
            collection(db, "notifications"),
            where("userId", "==", userData.tgChatId),
            orderBy("createdAt", "desc"),
            limit(10)
        );
        const snap = await getDocs(q);

        let content = `<h3 class="text-lg font-bold text-app-text mb-4">Notifications</h3><div class="space-y-3 max-h-80 overflow-y-auto">`;
        if (snap.empty) {
            content += `<p class="text-app-subtext text-center">No new notifications.</p>`;
        } else {
            content += snap.docs.map(doc => {
                const n = doc.data();
                const date = n.createdAt.toDate().toLocaleString();
                return `<div class="p-3 bg-slate-700 rounded-lg border border-app-border">
                            <p class="font-semibold text-app-text">${n.title}</p>
                            <p class="text-sm text-app-subtext">${n.message}</p>
                            <p class="text-xs text-slate-500 text-right mt-2">${date}</p>
                       </div>`;
            }).join('');
        }
        content += `</div>`;
        showModal(content);
        lucide.createIcons();

        document.getElementById('badge-notify').classList.add('hidden');
        await updateDoc(doc(db, "users", userData.tgChatId), {
            lastNotificationCheck: serverTimestamp()
        });
    }
    
    async function logPublicActivity(actionText) {
        try {
            await addDoc(collection(db, "public_activity"), {
                userId: userData.tgChatId,
                userName: userData.name,
                userPhoto: tgSession.photo_url || null,
                action: actionText,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Failed to log public activity:", e);
        }
    }

    window.openExtraIncomePage = () => { closeSidePanel(); switchView('view-extra-income'); };
    window.openSupport = () => {
        const supportLink = sysConfig.supportLink || "https://t.me/sarahmartinBTC";
        window.open(supportLink, '_blank');
    };
    window.visitWebsite = () => {
        const websiteUrl = sysConfig.websiteUrl || "#";
        window.open(websiteUrl, '_blank');
    };
    window.openContact = () => {
        const contactLink = sysConfig.contactLink || "https://t.me/yourcontact";
        window.open(contactLink, '_blank');
    };
    window.closeSidePanel = () => {
        document.getElementById('main-side-panel').classList.remove('open');
        document.getElementById('panel-overlay').classList.remove('open');
    };
    
    window.showToast = (msg, type='info') => {
         if(window.Telegram?.WebApp?.showPopup) { window.Telegram.WebApp.showAlert(msg); }
         else { alert(msg); }
    };
    window.copyText = (text) => { navigator.clipboard.writeText(text); showToast("Copied to clipboard!"); };
    window.copyNumber = (num, name) => { copyText(num); showToast(`${name} address copied!`); };
    
    function showMethodSelector(targetInputId, targetTextId, title, options) {
        let optionsHTML = options.map(opt =>
            `<button data-value="${opt.value}" class="select-option-btn neo-card w-full p-3 rounded-lg text-left hover:bg-slate-700/50 transition">${opt.text}</button>`
        ).join('');

        const modalHTML = `
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-center mb-4">${title}</h3>
                ${optionsHTML}
            </div>
        `;
        showModal(modalHTML);

        document.querySelectorAll('.select-option-btn').forEach(btn => {
            btn.onclick = () => {
                const selectedValue = btn.dataset.value;
                const selectedText = btn.textContent;
                document.getElementById(targetInputId).value = selectedValue;
                const textEl = document.getElementById(targetTextId);
                textEl.textContent = selectedText;
                textEl.parentElement.classList.remove('text-app-subtext');
                textEl.parentElement.classList.add('text-app-text');
                closeModal();
            };
        });
    }

    async function executeP2PTransfer() {
        const recipientUid = document.getElementById('p2p-uid').value.trim();
        const amount = parseFloat(document.getElementById('p2p-amount').value);
        const btn = document.getElementById('btn-exec-p2p');

        if (!recipientUid || !amount) return showToast("Please enter UID and amount.", "warning");
        if (recipientUid === userData.tgChatId) return showToast("You cannot transfer to yourself.", "error");
        if (amount < MIN_P2P_AMT) return showToast(`Minimum transfer amount is ${formatCurrency(MIN_P2P_AMT)}.`, "warning");
        
        let feePercent = P2P_FEE_PERCENT;
        const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
        if (userData.hasActiveMembership && !isMemberExpired && membershipTiers[userData.membershipTier]?.benefits.feeReduction > 0) {
            feePercent -= membershipTiers[userData.membershipTier].benefits.feeReduction;
        }
        const fee = amount * feePercent;
        const totalCost = amount + fee;

        if (userData.balance < totalCost) return showToast(`Insufficient balance. You need ${formatCurrency(totalCost)}.`, "error");

        btn.disabled = true; btn.textContent = 'PROCESSING...';
        try {
            await runTransaction(db, async (transaction) => {
                const senderRef = doc(db, "users", userData.tgChatId);
                const recipientRef = doc(db, "users", recipientUid);

                const [senderDoc, recipientDoc] = await Promise.all([
                    transaction.get(senderRef),
                    transaction.get(recipientRef)
                ]);

                if (!senderDoc.exists()) throw new Error("Your user data could not be found.");
                if (!recipientDoc.exists()) throw new Error("Recipient User ID not found.");
                
                const senderData = senderDoc.data();
                if (senderData.balance < totalCost) throw new Error("Insufficient balance for this transaction.");

                transaction.update(senderRef, { balance: senderData.balance - totalCost });
                transaction.update(recipientRef, { balance: recipientDoc.data().balance + amount });

                const logRef = doc(collection(db, "p2p_logs"));
                transaction.set(logRef, {
                    fromId: userData.tgChatId, fromName: userData.name,
                    toId: recipientUid, toName: recipientDoc.data().name || 'N/A',
                    amount: amount, fee: fee, status: "completed", createdAt: serverTimestamp()
                });
            });

            showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-400 mx-auto"></i><h3 class="text-lg font-bold text-app-text">Transfer Successful!</h3><p class="text-app-subtext">Successfully sent ${formatCurrency(amount)} to UID ${recipientUid}.</p><button onclick="closeModal(); switchView('view-features');" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
            document.getElementById('p2p-uid').value = '';
            document.getElementById('p2p-amount').value = '';
        } catch (e) {
            showToast("Transfer failed: " + e.message, "error");
        } finally {
            btn.disabled = false; btn.textContent = 'CONFIRM TRANSFER';
            lucide.createIcons();
        }
    }

    function setupInteractions() {
        // Dock Navigation
        document.querySelectorAll('.dock-item').forEach(item => {
            item.addEventListener('click', () => switchView(item.dataset.target));
        });

        // Side Panel
        document.getElementById('btn-menu').addEventListener('click', () => {
            document.getElementById('main-side-panel').classList.add('open');
            document.getElementById('panel-overlay').classList.add('open');
        });
        document.getElementById('panel-overlay').addEventListener('click', closeSidePanel);

        // Modals & Notifications
        document.getElementById('btn-notifications').addEventListener('click', loadNotifications);
        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal-backdrop').addEventListener('click', closeModal);

        // Settings
        document.getElementById('language-switcher').addEventListener('change', (e) => setLanguage(e.target.value));
        document.getElementById('currency-switcher').addEventListener('change', (e) => setCurrency(e.target.value));
        document.getElementById('theme-switcher').addEventListener('change', (e) => setTheme(e.target.value));


        // Copy UID
        document.getElementById('btn-copy-uid').addEventListener('click', () => copyText(userData.tgChatId));
        
        // P2P Transfer
        document.getElementById('btn-exec-p2p').addEventListener('click', executeP2PTransfer);
        
        // Referral Verification
        const verifyBtn = document.getElementById('btn-verify-referral');
        if (verifyBtn) {
            verifyBtn.addEventListener('click', verifyReferralCode);
        }

        // Deposit from Deposit Page
        document.getElementById('btn-submit-deposit').addEventListener('click', () => {
            const method = document.getElementById('dep-method').value;
            const amount = parseFloat(document.getElementById('dep-amount').value);
            const sender = document.getElementById('dep-sender').value.trim();
            const btn = document.getElementById('btn-submit-deposit');
            submitDepositRequest(method, amount, sender, btn, () => {
                document.getElementById('dep-method').value = '';
                document.getElementById('dep-method-text').textContent = 'Select Payment Method';
                document.getElementById('dep-method-selector').classList.add('text-app-subtext');
                document.getElementById('dep-amount').value = '';
                document.getElementById('dep-sender').value = '';
                loadDepositHistory();
            });
        });
        
        // Withdrawal
        document.getElementById('btn-submit-withdrawal').addEventListener('click', async () => {
            const method = document.getElementById('wd-method').value;
            const address = document.getElementById('wd-address').value.trim();
            const amount = parseFloat(document.getElementById('wd-amount').value);
            const btn = document.getElementById('btn-submit-withdrawal');
            
            btn.disabled = true; btn.innerText = "PROCESSING...";

            try {
                const referralsQuery = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId));
                const referralsSnap = await getDocs(referralsQuery);
                if (referralsSnap.size < MIN_REFERRALS_FOR_WITHDRAWAL) {
                    throw new Error(`You need at least ${MIN_REFERRALS_FOR_WITHDRAWAL} referrals to withdraw.`);
                }
                if (!method || !address || isNaN(amount)) throw new Error("Please fill all fields correctly.");
                if (amount < MIN_WITHDRAWAL_AMT) throw new Error(`Minimum withdrawal is ${formatCurrency(MIN_WITHDRAWAL_AMT)}.`);
                if (userData.balance < amount) throw new Error("Insufficient balance.");

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", userData.tgChatId);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().balance < amount) throw new Error("Transaction failed: Insufficient funds.");
                    
                    transaction.update(userRef, { balance: userDoc.data().balance - amount });
                    const withdrawalRef = doc(collection(db, "withdrawals"));
                    transaction.set(withdrawalRef, { userId: userData.tgChatId, userName: userData.name, method, address, amount, status: "pending", requestedAt: serverTimestamp() });
                });

                showModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-400 mx-auto"></i><h3 class="text-lg font-bold text-app-text">Withdrawal Submitted!</h3><p class="text-app-subtext">Your request for ${formatCurrency(amount)} will be processed within 24 hours.</p><button onclick="closeModal()" class="action-btn w-full py-2 rounded-xl">OK</button></div>`);
                document.getElementById('wd-method').value = ''; document.getElementById('wd-method-text').textContent = 'Select Withdrawal Method'; document.getElementById('wd-address').value = ''; document.getElementById('wd-amount').value = '';
                loadWithdrawalHistory();
            } catch(e) { showToast(e.message, "error");
            } finally { btn.disabled = false; btn.innerText = "SUBMIT WITHDRAWAL"; lucide.createIcons(); }
        });

        // Method Selectors
        document.getElementById('dep-method-selector').addEventListener('click', () => {
            const options = [ { value: 'USDT', text: 'USDT (TRC20)' }, { value: 'BTC', text: 'BTC' }, { value: 'Binance', text: 'Binance Pay' } ];
            showMethodSelector('dep-method', 'dep-method-text', 'Select Payment Method', options);
        });
        document.getElementById('wd-method-selector').addEventListener('click', () => {
            const options = [ { value: 'USDT', text: 'USDT (TRC20)' }, { value: 'BTC', text: 'BTC' }, { value: 'Binance', text: 'Binance Pay ID' } ];
            showMethodSelector('wd-method', 'wd-method-text', 'Select Withdrawal Method', options);
        });

        // P2P Fee Calculator
        document.getElementById('p2p-amount').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value) || 0;
            let feePercent = P2P_FEE_PERCENT;
            const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
             if (userData.hasActiveMembership && !isMemberExpired && membershipTiers[userData.membershipTier]?.benefits.feeReduction > 0) {
                feePercent -= membershipTiers[userData.membershipTier].benefits.feeReduction;
            }
            const fee = val * feePercent;
            document.getElementById('p2p-fee-calc').textContent = val > 0 ? `Fee (${(feePercent*100).toFixed(0)}%): ${formatCurrency(fee)}` : '';
        });

        // Promo Slider
        const slider = document.getElementById('promo-slider');
        const dotsContainer = document.getElementById('slider-dots');
        if (slider && slider.children.length > 1) {
            const slides = slider.children;
            let currentSlide = 0;
            // Create dots
            for (let i = 0; i < slides.length; i++) {
                const dot = document.createElement('span');
                dot.className = 'w-2 h-2 rounded-full bg-black/20 backdrop-blur-sm transition-all';
                dotsContainer.appendChild(dot);
            }
            const dots = dotsContainer.children;
            dots[0].classList.add('bg-white/90');
            
            setInterval(() => {
                currentSlide = (currentSlide + 1) % slides.length;
                slider.style.transform = `translateX(-${currentSlide * 100}%)`;
                Array.from(dots).forEach((dot, index) => {
                    dot.classList.toggle('bg-white/90', index === currentSlide);
                    dot.classList.toggle('bg-black/20', index !== currentSlide);
                });
            }, 5000); // Change slide every 5 seconds
        }
    }

    function initRealtimeListeners() {
         onSnapshot(doc(db, "users", userData.tgChatId), (doc) => {
            if(doc.exists()) {
                const oldData = {...userData};
                const newData = doc.data();
                userData = {...userData, ...newData};
                
                if (oldData.balance !== newData.balance || oldData.hasActiveMembership !== newData.hasActiveMembership || oldData.membershipTier !== newData.membershipTier) {
                     updateDashboard();
                }
                if (document.getElementById('view-tasks').classList.contains('active-view')) {
                    loadTasksView();
                }
                if(document.getElementById('view-refer').classList.contains('active-view')) {
                    loadMyReferrals(); // Refresh referral list on data change
                }
            }
        });
    }

    async function loadProfileStats() {
        const statTasksEl = document.getElementById('stat-tasks');
        const statIncomeEl = document.getElementById('stat-income');
        const statReferralsEl = document.getElementById('stat-referrals');
    
        statTasksEl.textContent = '...';
        statIncomeEl.textContent = '...';
        statReferralsEl.textContent = '...';
    
        const uid = userData.tgChatId;
    
        try {
            const totalTasks = (userData.dailyCompletedTasks && Array.isArray(userData.dailyCompletedTasks)) ? userData.dailyCompletedTasks.length : 0;
            statTasksEl.textContent = totalTasks;
    
            const taskReward = TASK_REWARD;
            const totalTaskEarnings = totalTasks * taskReward;
            statIncomeEl.textContent = formatCurrency(totalTaskEarnings);
    
            const referralsQuery = query(collection(db, "users"), where("referredBy", "==", uid));
            const referralsSnap = await getDocs(referralsQuery);
            statReferralsEl.textContent = referralsSnap.size;
    
        } catch (error) {
            console.error("Error loading profile stats:", error);
            statTasksEl.textContent = 'Error';
            statIncomeEl.textContent = 'Error';
            statReferralsEl.textContent = 'Error';
        }
    }

    async function loadActivityLog() {
        const el = document.getElementById('activity-log');
        el.innerHTML = '<div class="loader-ring w-6 h-6 border-2 mx-auto"></div>';
        
        let allLogs = [];

        try {
            const p2pQuery = query(collection(db, "p2p_logs"), where("fromId", "==", userData.tgChatId), orderBy("createdAt", "desc"), limit(5));
            const p2pSnap = await getDocs(p2pQuery);
            p2pSnap.forEach(d => { if(d.data().createdAt) allLogs.push({ ...d.data(), type: 'p2p' }); });
        } catch (error) { console.error("Error loading P2P logs:", error); }
        
        allLogs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        const recentLogs = allLogs.slice(0, 10);

        if (recentLogs.length === 0) {
            el.innerHTML = 'No recent activities found.';
            return;
        }

        el.innerHTML = recentLogs.map(log => {
            const date = log.createdAt.toDate().toLocaleDateString();
            if (log.type === 'p2p') {
                return `<div class="text-left p-2 rounded-lg bg-slate-700">
                            <p class="text-app-text">Sent ${formatCurrency(log.amount)} to <span class="font-mono">${log.toId}</span></p>
                            <p class="text-app-subtext text-xs">${date}</p>
                        </div>`;
            }
            return '';
        }).join('');
    }

    async function loadNewsFeed() {
        const el = document.getElementById('news-feed');
        el.innerHTML = '<div class="flex justify-center p-8"><div class="loader-ring w-8 h-8 border-2"></div></div>';
        try {
            const q = query(collection(db, "news"), orderBy("createdAt", "desc"), limit(5));
            const snap = await getDocs(q);
            if (snap.empty) {
                el.innerHTML = '<p class="text-app-subtext text-center">No news available right now.</p>';
                return;
            }
            el.innerHTML = snap.docs.map(doc => {
                const news = doc.data();
                const date = news.createdAt.toDate().toLocaleString();
                return `
                <div class="neo-card p-4 rounded-2xl">
                    ${news.imageUrl ? `<img src="${news.imageUrl}" class="w-full h-40 object-cover rounded-xl mb-3" alt="news">` : ''}
                    <h3 class="font-bold text-lg text-app-text">${news.title}</h3>
                    <p class="text-app-subtext text-sm mt-2">${news.content}</p>
                    <p class="text-xs text-slate-500 mt-3">${date}</p>
                </div>`;
            }).join('');
        } catch (error) {
            console.error("Error loading news:", error);
            el.innerHTML = '<p class="text-red-500 text-center">Could not load news feed.</p>';
        }
    }

    async function loadIncomeTiers(containerId) {
        const container = document.getElementById(containerId);
        const tierKeys = Object.keys(membershipTiers).sort((a,b) => membershipTiers[a].level - membershipTiers[b].level);
        const isMemberExpired = userData.membershipExpiry && userData.membershipExpiry.toDate() < new Date();
        const currentUserLevel = (userData.hasActiveMembership && !isMemberExpired) ? membershipTiers[userData.membershipTier]?.level || 0 : 0;
        
        let html = tierKeys.map(key => {
            const tier = membershipTiers[key];
            if (tier.level === 0) return ''; // Don't show the 'Free' tier for purchase
            
            let benefitsList = [];
            for (const bKey in tier.benefits) {
                if (bKey.startsWith('benefit_text_')) {
                    benefitsList.push(`<li><i class="inline-block w-4 h-4 mr-2 text-green-400" data-lucide="check"></i>${tier.benefits[bKey]}</li>`);
                }
            }
            if (tier.benefits.feeReduction > 0) {
                 const reducedFee = (P2P_FEE_PERCENT - tier.benefits.feeReduction) * 100;
                 benefitsList.push(`<li><i class="inline-block w-4 h-4 mr-2 text-green-400" data-lucide="check"></i>P2P Fee reduced to <strong>${reducedFee.toFixed(0)}%</strong></li>`);
            }
            
            let buttonHtml;
            const isCurrentTier = tier.level === currentUserLevel && !isMemberExpired;
            
            if (isCurrentTier) {
                buttonHtml = `<div class="text-center font-semibold text-lg text-green-400 py-3">CURRENT TIER</div>`;
                if(userData.membershipExpiry) {
                    const expiryElId = `countdown-${key}-${containerId}`;
                    buttonHtml += `<div id="${expiryElId}" class="text-center font-mono text-sm text-cyan-400 pb-3"></div>`;
                    const countdownInterval = setInterval(() => {
                        const expiryEl = document.getElementById(expiryElId);
                        if (!expiryEl) { clearInterval(countdownInterval); return; }
                        const now = new Date().getTime();
                        const expiryTime = userData.membershipExpiry.toDate().getTime();
                        const distance = expiryTime - now;

                        if (distance < 0) {
                            clearInterval(countdownInterval);
                            expiryEl.innerHTML = "EXPIRED";
                            return;
                        }

                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        
                        expiryEl.innerHTML = `Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    }, 1000);
                    activeTimers.push(countdownInterval);
                }
            } else if (tier.level < currentUserLevel && !isMemberExpired) {
                buttonHtml = `<button class="action-btn w-full py-3 rounded-xl" disabled>Activated</button>`;
            } else {
                buttonHtml = `<button onclick="purchaseTier('${key}')" class="action-btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">UPGRADE</button>`;
            }

            return `
            <div class="neo-card p-5 rounded-2xl ${isCurrentTier ? 'border-yellow-400' : 'border-app-border'}">
                <h3 class="text-2xl font-bold text-yellow-400">${tier.name}</h3>
                <p class="text-3xl font-bold my-3 text-app-text">${formatCurrency(tier.price)} <span class="text-lg text-app-subtext">/ ${tier.duration} days</span></p>
                <ul class="text-sm text-app-subtext space-y-2 my-4 text-left pl-2">
                    ${benefitsList.join('')}
                </ul>
                ${buttonHtml}
            </div>`;
        }).join('');
        container.innerHTML = html;
        lucide.createIcons();
    }
    window.purchaseTier = async function(tierKey) {
        const tier = membershipTiers[tierKey];
        if (userData.balance < tier.price) {
            return showToast(`Insufficient balance. You need ${formatCurrency(tier.price)}.`, 'error');
        }

        showModal(`
            <div class="text-center space-y-4">
                <h3 class="text-xl font-bold text-app-text">Confirm Purchase</h3>
                <p class="text-app-subtext">Are you sure you want to buy the ${tier.name} tier for ${formatCurrency(tier.price)} (${tier.duration} days)?</p>
                <button id="confirm-tier-purchase" class="action-btn w-full py-3 rounded-xl">Confirm</button>
                <button onclick="closeModal()" class="neo-card w-full py-2 rounded-xl mt-2">Cancel</button>
            </div>
        `);

        document.getElementById('confirm-tier-purchase').onclick = async function() {
            this.disabled = true; this.textContent = "PROCESSING...";
            try {
                const userRef = doc(db, "users", userData.tgChatId);
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().balance < tier.price) {
                        throw "Transaction failed: Insufficient funds.";
                    }
                    
                    const newBalance = userDoc.data().balance - tier.price;
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + tier.duration);
                    
                    transaction.update(userRef, {
                        balance: newBalance,
                        hasActiveMembership: true,
                        membershipTier: tierKey,
                        membershipExpiry: Timestamp.fromDate(expiryDate)
                    });
                });
                
                logPublicActivity(`upgraded to ${tier.name} tier!`);
                closeModal();
                showToast(`Successfully upgraded to ${tier.name}!`, 'success');
                setTimeout(() => window.location.reload(), 1500);

            } catch (error) {
                closeModal();
                showToast(error.toString(), 'error');
            }
        };
    }
</script>

</body>
</html>
