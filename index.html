<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REWARD CLAIM</title>
<meta name="monetag" content="a41ceca9ffc67edad031c0024f85ef59">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Poppins', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                colors: {
                    light: {
                        bg: '#f8fafc',      // Light gray background
                        card: '#ffffff',     // White cards
                        text: '#0f172a',     // Dark text
                        subtext: '#64748b', // Lighter text
                        border: '#e2e8f0'    // Soft borders
                    },
                    nexus: {
                        primary: '#6366f1',
                        accent: '#06b6d4',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    }
</script>
<style>
    :root { 
        --app-bg: #f8fafc; 
        --app-card: #ffffff; 
        --app-text: #0f172a;
        --app-subtext: #64748b;
        --app-border: #e2e8f0;
        --primary-grad: linear-gradient(135deg, #6366f1, #8b5cf6); 
    }
    body { 
        background-color: var(--app-bg); 
        color: var(--app-text); 
        font-family: 'Poppins', sans-serif; 
        -webkit-tap-highlight-color: transparent; 
    }
    .no-select { -webkit-user-select: none; user-select: none; }
    .neo-card {
        background: var(--app-card); 
        border: 1px solid var(--app-border);
        box-shadow: 0 4px 12px -1px rgba(0, 0, 0, 0.05), 0 2px 8px -1px rgba(0, 0, 0, 0.03);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .neo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.15);
    }
    .neo-input {
        background: #f1f5f9; 
        border: 1px solid var(--app-border); 
        color: var(--app-text); 
        transition: all 0.3s ease;
    }
    .neo-input:focus { 
        border-color: #6366f1; 
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); 
        outline: none; 
        background: #fff;
    }
    .action-btn {
        background: var(--primary-grad); color: white; font-weight: 600; border: none;
        position: relative; overflow: hidden; transition: all 0.3s ease;
        box-shadow: 0 4px 15px -3px rgba(99, 102, 241, 0.3);
    }
    .action-btn:active { transform: scale(0.97); }
    .action-btn:hover { box-shadow: 0 6px 20px -3px rgba(99, 102, 241, 0.5); }
    .action-btn:disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
    
    .app-view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .app-view.active-view { display: block; opacity: 1; transform: translateY(0); }
    
    .dock-nav {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 95%; max-width: 400px; 
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-radius: 24px; border: 1px solid rgba(0,0,0,0.05);
        display: flex; justify-content: space-evenly; padding: 12px; z-index: 50;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .dock-item {
        color: #94a3b8; display: flex; flex-direction: column; align-items: center;
        font-size: 10px; gap: 4px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; padding: 0 8px;
    }
    .dock-item.nav-active { color: #6366f1; transform: translateY(-4px); }
    .dock-item.nav-active::after {
        content: ''; position: absolute; bottom: -8px; width: 6px; height: 6px;
        background: #6366f1; border-radius: 50%;
    }
    #splash-screen {
        position: fixed; inset: 0; background: var(--app-bg); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .loader-ring {
        width: 60px; height: 60px; border: 4px solid #e2e8f0; border-top-color: #22c55e;
        border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .glass-modal {
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.2); 
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
        color: var(--app-text);
    }
</style>
</head>
<body class="max-w-md mx-auto min-h-screen overflow-x-hidden no-select pb-28">

<!-- SPLASH SCREEN -->
<div id="splash-screen">
    <div class="relative">
        <div class="loader-ring"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
        </div>
    </div>
    <h1 class="mt-6 text-2xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-green-600">REWARD CLAIM</h1>
    <p id="loading-msg" class="text-light-subtext text-sm mt-2 animate-pulse">Establishing Secure Connection...</p>
</div>

<!-- SIDE PANEL (Kept dark for contrast, can be changed) -->
<div class="side-panel-overlay" id="panel-overlay"></div>
<aside class="side-panel" id="main-side-panel">
   <!-- ... side panel content remains same ... -->
</aside>

<!-- MAIN APP CONTAINER -->
<div id="nexus-app" class="min-h-screen">
<!-- TOP BAR -->
<header class="sticky top-0 z-40 bg-light-bg/80 backdrop-blur-md border-b border-light-border px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3" id="user-quick-info">
        <div class="relative">
            <img id="nav-user-img" src="" class="w-10 h-10 rounded-full border-2 border-indigo-500/30 hidden object-cover" alt="User">
            <div id="nav-user-initials" class="w-10 h-10 rounded-full bg-slate-200 border-2 border-slate-300 flex items-center justify-center font-bold text-slate-500">U</div>
            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-light-bg rounded-full"></div>
        </div>
        <div>
            <p id="welcome-text" class="text-xs text-light-subtext font-medium">Welcome back,</p>
            <p id="user-balance-top" class="text-sm font-bold text-emerald-500">$0.00</p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="switchView('view-deposit')" class="action-btn px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5">
            <i data-lucide="plus" class="w-4 h-4"></i>FUND
        </button>
        <button id="btn-notifications" class="relative p-2 text-light-subtext hover:text-light-text transition bg-slate-100 rounded-full">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="badge-notify" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-light-bg rounded-full hidden"></span>
        </button>
        <button id="btn-menu" class="p-2 text-light-subtext hover:text-light-text transition">
            <i data-lucide="align-right" class="w-6 h-6"></i>
        </button>
    </div>
</header>

<main class="p-4">

<!-- DASHBOARD VIEW -->
<div id="view-dashboard" class="app-view active-view space-y-6">
    <!-- Promo Slider -->
    <div class="rounded-2xl overflow-hidden relative aspect-video shadow-lg shadow-slate-200">
        <div id="promo-slider" class="h-full flex transition-transform duration-500 ease-out">
             <div class="min-w-full h-full bg-slate-200 relative">
                <img src="https://i.postimg.cc/cKYRC9jj/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" class="w-full h-full object-cover" alt="Promo 1">
            </div>
             <div class="min-w-full h-full bg-slate-200 relative">
                <img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" class="w-full h-full object-cover" alt="Promo 2">
            </div>
        </div>
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" id="slider-dots">
            <span class="w-2 h-2 rounded-full bg-white/90 backdrop-blur-sm"></span><span class="w-2 h-2 rounded-full bg-black/20 backdrop-blur-sm"></span>
        </div>
    </div>

<!-- Main Balance Card -->
<div class="neo-card p-6 rounded-3xl bg-white relative overflow-hidden">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl"></div>
    <p class="text-light-subtext font-medium mb-2 flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Available Balance</p>
    <h2 id="main-balance-display" class="text-4xl font-bold text-light-text tracking-tight mb-6">$0.00</h2>
    <div class="grid grid-cols-2 gap-3">
        <button onclick="switchView('view-deposit')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> DEPOSIT
        </button>
         <button onclick="switchView('view-withdrawal')" class="action-btn py-3 rounded-xl flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500">
            <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> WITHDRAW
        </button>
    </div>
</div>

<!-- Live Withdrawal Feed -->
<div id="live-withdrawal-feed" class="space-y-3">
    <h3 class="text-lg font-semibold text-light-text px-2 flex items-center gap-2">
        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-500"></i>
        Live Withdrawals
    </h3>
    <div id="withdrawal-feed-container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- TASKS VIEW -->
<div id="view-tasks" class="app-view space-y-6">
    <div class="text-center">
       <h2 class="text-2xl font-bold text-light-text">Daily Tasks</h2>
       <p class="text-light-subtext text-sm">Complete simple tasks to earn rewards</p>
   </div>
   <div id="task-list" class="space-y-4">
       <!-- Tasks will be dynamically inserted here -->
   </div>
</div>

<!-- REFER VIEW (MODIFIED) -->
<div id="view-refer" class="app-view space-y-6">
    <!-- Enter Referral Code -->
    <div id="referral-input-section" class="neo-card p-5 rounded-2xl text-center space-y-3">
        <h3 class="font-semibold text-light-text text-lg">Have a Referral Code?</h3>
        <p class="text-xs text-light-subtext">Enter your friend's code below. You both will receive <span id="referral-bonus-text" class="text-emerald-500 font-bold">$1.00</span> instantly!</p>
        <div class="relative">
            <input type="text" id="referral-code-input" placeholder="Enter Code Here" class="neo-input w-full p-3 rounded-xl text-center font-mono">
        </div>
        <button id="btn-verify-referral" class="action-btn w-full py-3 rounded-xl">VERIFY & CLAIM <span id="referral-claim-bonus-text">$1.00</span></button>
    </div>

    <div class="grid grid-cols-2 gap-4 text-center">
        <div class="neo-card p-4 rounded-xl">
            <p class="text-sm text-light-subtext">Total Referrals</p>
            <p id="ref-stat-count" class="text-2xl font-bold text-light-text">0</p>
        </div>
        <div class="neo-card p-4 rounded-xl">
            <p class="text-sm text-light-subtext">Referral Earnings</p>
            <p id="ref-stat-earnings" class="text-2xl font-bold text-emerald-500">$0.00</p>
        </div>
    </div>

    <div class="neo-card p-5 rounded-2xl text-center">
        <h3 class="font-semibold text-light-subtext mb-2">Your Unique Referral Link</h3>
        <div class="relative">
            <input type="text" id="referral-link-display" readonly class="neo-input w-full p-3 rounded-xl text-center bg-slate-100 font-mono text-sm" value="Loading...">
            <button onclick="copyText(document.getElementById('referral-link-display').value)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-200">
                <i data-lucide="copy" class="w-4 h-4 text-light-subtext"></i>
            </button>
        </div>
    </div>
    
    <!-- YOUR REFERRALS SECTION -->
    <div id="your-referrals-section" class="space-y-3">
        <h3 class="text-lg font-semibold text-light-text px-2 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-nexus-primary"></i>
            Your Referrals
        </h3>
        <div id="my-referrals-list" class="space-y-3">
            <!-- Referral list will be injected here by JavaScript -->
        </div>
    </div>
</div>

<!-- ... Other views (Deposit, Withdrawal, Profile etc.) would also need color updates ... -->
<!-- For brevity, only the main requested changes are fully styled. The logic for other views remains. -->

</main>

<!-- DOCK NAVIGATION -->
<nav class="dock-nav">
    <!-- ... dock items ... -->
</nav>
</div>

<!-- GENERIC MODAL -->
<div id="nexus-modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="glass-modal w-full max-w-sm p-6 rounded-3xl relative transform scale-95 transition-all duration-300" id="modal-content">
        <div id="modal-body"></div>
        <button id="modal-close" class="absolute top-4 right-4 p-1 rounded-full bg-slate-100 text-slate-500 hover:text-black">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, onSnapshot, updateDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- CONFIGURATION ---
    // ... same config variables ...
    
    // FIREBASE CONFIG
    const firebaseConfig = {
      // ... same firebase config ...
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let tgSession = null;
    let userData = null;
    let sysConfig = {};
    let activeTimers = []; 
    let firebaseUser = null;

    // --- CORE FUNCTIONS (mostly same, with modifications) ---
    
    window.switchView = function(viewId) {
        // ... same view switching logic ...

        // ADDED: Call the new function when switching to refer view
        if(viewId === 'view-refer') {
            loadReferralView();
            loadMyReferrals(); // New function call
        }
        // ... rest of the function ...
    }

    // NEW FUNCTION to load user's own referrals
    async function loadMyReferrals() {
        const container = document.getElementById('my-referrals-list');
        if (!container) return;
        container.innerHTML = `<p class="text-center text-light-subtext p-4">Loading your referrals...</p>`;

        try {
            const q = query(collection(db, "users"), where("referredBy", "==", userData.tgChatId));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = `<div class="neo-card text-center p-6 rounded-2xl"><p class="text-light-subtext">You haven't referred anyone yet. Share your link to start earning!</p></div>`;
                return;
            }

            let referralsHtml = '';
            querySnapshot.forEach(doc => {
                const referredUser = doc.data();
                const userInitials = (referredUser.name.split(' ')[0]?.[0] || 'U') + (referredUser.name.split(' ')[1]?.[0] || '');

                // Note: Getting other users' Telegram photos isn't directly possible for privacy reasons.
                // We will use initials as a fallback.
                referralsHtml += `
                <div class="neo-card p-3 rounded-2xl flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                         <div class="w-12 h-12 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center font-bold text-slate-500 text-lg">
                           ${userInitials}
                         </div>
                         <div>
                            <p class="font-semibold text-md text-light-text">${referredUser.name}</p>
                            <p class="text-xs text-light-subtext">User ID: ${referredUser.tgChatId}</p>
                         </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-emerald-500">$${(referredUser.balance || 0).toFixed(2)}</p>
                        <p class="text-xs text-light-subtext">Balance</p>
                    </div>
                </div>
                `;
            });

            container.innerHTML = referralsHtml;
            lucide.createIcons();

        } catch (error) {
            console.error("Error loading my referrals:", error);
            container.innerHTML = `<p class="text-center text-red-500 p-4">Could not load your referrals.</p>`;
        }
    }


    // REMOVED/REPLACED: The old `initLiveReferralFeed` function is no longer needed.
    // Make sure to remove any calls to it.

    // ... The rest of your JavaScript remains largely the same ...
    // ... You'll need to update CSS color classes within JS-generated HTML (like modals, history lists etc.) ...

    // Example of updating JS-generated HTML for light theme
    async function loadDepositHistory() {
        const el = document.getElementById('deposit-history-log');
        const q = query(collection(db, "deposits"), where("userId", "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { el.innerHTML = '<p class="text-light-subtext text-center text-xs py-2">No deposit history.</p>'; return; }

        el.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const statusColors = { pending: 'text-yellow-500', approved: 'text-emerald-500', rejected: 'text-red-500' };
            const date = data.requestedAt ? new Date(data.requestedAt.seconds * 1000).toLocaleDateString() : 'N/A';
            return `
            <div class="flex justify-between items-center p-3 bg-light-card rounded-xl border border-light-border">
                <div>
                    <p class="text-sm font-medium text-light-text">${data.method} - $${data.amount}</p>
                    <p class="text-[10px] text-light-subtext font-mono">${date}</p>
                </div>
                <span class="text-xs font-bold ${statusColors[data.status] || 'text-light-subtext'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }

</script>

</body>
</html>
