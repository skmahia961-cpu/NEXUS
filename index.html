<!DOCTYPE html>
<html lang="en" class="m0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLAIM REWARD</title>
<meta name="monetag" content="a41ceca9ffc67edad031c0024f85ef59">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: { sans: ['Poppins', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                colors: {
                    core: {
                        bg: '#0f172a',
                        surface: '#1e293b',
                        main: '#6366f1',
                        secondary: '#06b6d4',
                        ok: '#10b981',
                        warn: '#f59e0b',
                        err: '#ef4444'
                    }
                }
            }
        }
    }
</script>
<style>
    :root { --core-bg-color: #0f172a; --core-surface-color: #1e293b; --main-gradient: linear-gradient(135deg, #6366f1, #8b5cf6); }
    body { background-color: var(--core-bg-color); color: #e2e8f0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
    .no_selection { -webkit-user-select: none; user-select: none; }
    .allow_selection { -webkit-user-select: text; user-select: text; }
    .card_ui {
        background: var(--core-surface-color); border: 1px solid #334155;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, border-color 0.2s;
    }
    .card_ui:active { transform: scale(0.98); }
    .input_field {
        background: #0f172a; border: 1px solid #334155; color: #fff; transition: all 0.3s ease;
    }
    .input_field:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; }
    .primary_btn {
        background: var(--main-gradient); color: white; font-weight: 600; border: none;
        position: relative; overflow: hidden; transition: all 0.3s ease;
    }
    .primary_btn::after {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0));
        opacity: 0; transition: opacity 0.3s;
    }
    .primary_btn:active { transform: scale(0.97); }
    .primary_btn:hover::after { opacity: 1; }
    .primary_btn:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
    .primary_btn:disabled::after { display: none; }
    .view_panel { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
    .view_panel.visible { display: block; opacity: 1; transform: translateY(0); }
    .bottom_nav {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        width: 95%; max-width: 400px; background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-evenly; padding: 12px; z-index: 50;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }
    .nav_item {
        color: #94a3b8; display: flex; flex-direction: column; align-items: center;
        font-size: 10px; gap: 4px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; padding: 0 8px;
    }
    .nav_item.current { color: #6366f1; transform: translateY(-4px); }
    .nav_item.current::after {
        content: ''; position: absolute; bottom: -8px; width: 6px; height: 6px;
        background: #6366f1; border-radius: 50%;
    }
    #loader_screen {
        position: fixed; inset: 0; background: var(--core-bg-color); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: opacity 0.5s ease;
    }
    .spinner {
        width: 60px; height: 60px; border: 4px solid #1e293b; border-top-color: #22c55e;
        border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .menu_overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
        opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 80;
    }
    .side_menu {
        position: fixed; left: 0; top: 0; bottom: 0; width: 85%; max-width: 320px;
        background: var(--core-bg-color); z-index: 90; transform: translateX(-105%);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); border-right: 1px solid #334155;
    }
    .side_menu.active { transform: translateX(0); }
    .menu_overlay.active { opacity: 1; visibility: visible; }
    .popup_modal {
        background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .mission_btn {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        z-index: 1;
    }
    .mission_btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.6s ease;
        z-index: -1;
    }
    .mission_btn:hover::before {
        transform: translate(-50%, -50%) scale(1);
    }
    .mission_btn:hover {
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        transform: translateY(-2px);
    }
    @keyframes glow_effect {
        0%, 100% { box-shadow: 0 0 5px #6366f1, 0 0 10px #6366f1, 0 0 15px #8b5cf6; }
        50% { box-shadow: 0 0 10px #8b5cf6, 0 0 20px #8b5cf6, 0 0 30px #6366f1; }
    }
    .glowing_mission_btn {
        animation: glow_effect 2.5s infinite ease-in-out;
    }
    @keyframes fade_in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate_fade { animation: fade_in 0.5s ease forwards; }
</style>
</head>
<body class="max-w-md mx-auto min-h-screen overflow-x-hidden no_selection pb-28">

<!-- SPLASH SCREEN -->
<div id="loader_screen">
    <div class="relative">
        <div class="spinner"></div>
        <div class="absolute inset-0 flex items-center justify-center">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
        </div>
    </div>
    <h1 class="mt-6 text-2xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-green-600">REWARD CLAIM</h1>
    <p id="loader_msg" class="text-slate-500 text-sm mt-2 animate-pulse">Establishing Secure Connection...</p>
</div>

<!-- SIDE PANEL -->
<div class="menu_overlay" id="panel_overlay_elem"></div>
<aside class="side_menu" id="main_side_menu">
    <div class="p-6 bg-slate-900/50 border-b border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-indigo-600 to-cyan-500 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i data-lucide="shield-check" class="w-7 h-7 text-white"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg text-slate-100">Help Center</h3>
                <p class="text-xs text-slate-400">24/7 Priority Support</p>
            </div>
        </div>
    </div>
    <div id="side_menu_content" class="p-4 space-y-2 overflow-y-auto h-[calc(100%-160px)]">
        <!-- New Menu Items -->
        <button onclick="closeSideMenu(); switchPanel('panel_deposit');" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-500"><i data-lucide="arrow-down-left" class="w-5 h-5"></i></div>
                <span class="font-medium">Deposit</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
         <button onclick="closeSideMenu(); switchPanel('panel_withdrawal');" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-500"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                <span class="font-medium">Withdrawal</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="launchSupport()" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-blue-500/10 text-blue-500"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="launchWebsite()" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-purple-500/10 text-purple-500"><i data-lucide="globe" class="w-5 h-5"></i></div>
                <span class="font-medium">Visit Website</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="launchPremiumPage()" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition mt-4 border-t border-slate-800 pt-6">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-yellow-500/10 text-yellow-500"><i data-lucide="gem" class="w-5 h-5"></i></div>
                <span class="font-medium">Get Premium</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-800 bg-slate-900">
        <p class="text-center text-[10px] text-slate-600 tracking-widest">REWARD v4.8.1 encrypted</p>
    </div>
</aside>

<!-- MAIN APP CONTAINER -->
<div id="app_container" class="min-h-screen">
<!-- TOP BAR -->
<header class="sticky top-0 z-40 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3" id="user_info_header">
        <div class="relative">
            <img id="header_user_avatar" src="" class="w-10 h-10 rounded-full border-2 border-indigo-500/30 hidden object-cover" alt="User">
            <div id="header_user_initials" class="w-10 h-10 rounded-full bg-slate-800 border-2 border-slate-700 flex items-center justify-center font-bold text-slate-400">U</div>
            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-2 border-slate-900 rounded-full"></div>
        </div>
        <div>
            <p id="greeting_text" class="text-xs text-slate-400 font-medium">Welcome back,</p>
            <p id="header_user_balance" class="text-sm font-bold text-emerald-400">$0.00</p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="switchPanel('panel_deposit')" class="primary_btn px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5 shadow-lg shadow-indigo-500/20">
            <i data-lucide="plus" class="w-4 h-4"></i>FUND
        </button>
        <button id="notification_btn" class="relative p-2 text-slate-400 hover:text-slate-200 transition bg-slate-800/50 rounded-full">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span id="notification_badge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-slate-900 rounded-full hidden"></span>
        </button>
        <button id="menu_btn" class="p-2 text-slate-400 hover:text-slate-200 transition">
            <i data-lucide="align-right" class="w-6 h-6"></i>
        </button>
    </div>
</header>

<main class="p-4">

<!-- DASHBOARD VIEW -->
<div id="panel_dashboard" class="view_panel visible space-y-6">
    <!-- Promo Slider -->
    <div class="card_ui rounded-2xl overflow-hidden relative aspect-video">
        <div id="banner_slider" class="h-full flex transition-transform duration-500 ease-out">
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/cKYRC9jj/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" class="w-full h-full object-cover opacity-80" alt="Promo 1">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
            </div>
             <div class="min-w-full h-full bg-slate-800 relative">
                <img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" class="w-full h-full object-cover opacity-80" alt="Promo 2">
            </div>
        </div>
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" id="slider_indicators">
            <span class="w-2 h-2 rounded-full bg-white"></span><span class="w-2 h-2 rounded-full bg-slate-600"></span>
        </div>
    </div>

<!-- Main Balance Card -->
<div class="card_ui p-6 rounded-3xl bg-gradient-to-br from-slate-800 to-slate-900 relative overflow-hidden">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-3xl"></div>
    <p class="text-slate-400 font-medium mb-2 flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Available Balance</p>
    <h2 id="balance_display_main" class="text-4xl font-bold text-white tracking-tight mb-6">$0.00</h2>
    <div class="grid grid-cols-2 gap-3">
        <button onclick="switchPanel('panel_deposit')" class="primary_btn py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> DEPOSIT
        </button>
         <button onclick="switchPanel('panel_withdrawal')" class="primary_btn py-3 rounded-xl flex items-center justify-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500">
            <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> WITHDRAW
        </button>
    </div>
</div>

<!-- Live Withdrawal Feed -->
<div id="live_withdrawal_stream" class="space-y-3">
    <h3 class="text-lg font-semibold text-slate-300 px-2 flex items-center gap-2">
        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
        Live Withdrawals
    </h3>
    <div id="withdrawal_stream_container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- TASKS VIEW -->
<div id="panel_tasks" class="view_panel space-y-6">
    <div class="text-center">
       <h2 class="text-2xl font-bold text-slate-100">Daily Tasks</h2>
       <p class="text-slate-500 text-sm">Complete simple tasks to earn rewards</p>
   </div>
   <div id="task_container" class="space-y-4">
       <!-- Tasks will be dynamically inserted here -->
   </div>
</div>

<!-- REFER VIEW (Improved) -->
<div id="panel_refer" class="view_panel space-y-6">
    <!-- Enter Referral Code -->
    <div id="referral_code_section" class="card_ui p-5 rounded-2xl text-center space-y-3">
        <h3 class="font-semibold text-slate-200 text-lg">Have a Referral Code?</h3>
        <p class="text-xs text-slate-400">Enter your friend's code below. You both will receive <span id="ref_bonus_amount_text" class="text-emerald-400 font-bold">$1.00</span> instantly!</p>
        <div class="relative">
            <input type="text" id="ref_code_input" placeholder="Enter Code Here" class="input_field w-full p-3 rounded-xl text-center font-mono">
        </div>
        <button id="verify_ref_btn" class="primary_btn w-full py-3 rounded-xl">VERIFY & CLAIM <span id="ref_claim_bonus_text">$1.00</span></button>
    </div>

<div class="grid grid-cols-2 gap-4 text-center">
    <div class="card_ui p-4 rounded-xl">
        <p class="text-sm text-slate-400">Total Referrals</p>
        <p id="ref_count_stat" class="text-2xl font-bold text-white">0</p>
    </div>
    <div class="card_ui p-4 rounded-xl">
        <p class="text-sm text-slate-400">Referral Earnings</p>
        <p id="ref_earnings_stat" class="text-2xl font-bold text-emerald-400">$0.00</p>
    </div>
</div>

<div class="card_ui p-5 rounded-2xl text-center">
    <h3 class="font-semibold text-slate-300 mb-2">Your Unique Referral Link</h3>
    <div class="relative">
        <input type="text" id="ref_link_field" readonly class="input_field w-full p-3 rounded-xl text-center bg-slate-900 font-mono text-sm" value="Loading...">
        <button onclick="copyToClipboard(document.getElementById('ref_link_field').value)" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-700">
            <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
        </button>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <button onclick="shareViaTelegram()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-[#2AABEE] text-white font-semibold">
        <i data-lucide="send" class="w-5 h-5"></i> Telegram
    </button>
     <button onclick="shareNatively()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-purple-600 text-white font-semibold">
        <i data-lucide="share-2" class="w-5 h-5"></i> Share Live
    </button>
</div>

<div class="card_ui p-5 rounded-xl text-left">
    <h3 class="font-semibold text-slate-200 mb-3 flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5 text-indigo-400"></i> How it Works:</h3>
    <ul class="space-y-3 text-sm text-slate-400">
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>Enter a friend's code once to get a bonus for both of you.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>Share your unique link with friends.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>You earn a commission on their every deposit, forever.</span></li>
        <li class="flex items-start gap-3"><i data-lucide="check-circle" class="w-4 h-4 text-green-500 mt-1 shrink-0"></i> <span>The more friends you invite, the more you earn passively.</span></li>
    </ul>
</div>

<!-- Live Referral Feed -->
<div id="live_referral_stream" class="space-y-3">
    <h3 class="text-lg font-semibold text-slate-300 px-2 flex items-center gap-2">
        <i data-lucide="award" class="w-5 h-5 text-emerald-400"></i>
        Live Referrals
    </h3>
    <div id="referral_stream_container" class="h-48 overflow-hidden relative space-y-3">
        <!-- Feed items will be injected here -->
    </div>
</div>
</div>

<!-- DEPOSIT VIEW -->
<div id="panel_deposit" class="view_panel space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-100">Add Funds</h2>
        <p class="text-slate-500 text-sm">Secure & Fast Balance Top-up</p>
    </div>
    <div class="card_ui p-5 rounded-2xl border-indigo-500/30 bg-indigo-500/5">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-circle" class="w-6 h-6 text-indigo-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-indigo-300 mb-1">IMPORTANT NOTE</h4>
                 <p class="text-xs text-indigo-200/70 leading-relaxed">
                    Please use a valid payment method. Minimum deposit is <span id="min_deposit_info" class="text-white font-bold">$10.00</span>.
                 </p>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
         <div class="card_ui p-3 rounded-xl flex flex-col items-center" onclick="copyAddress('0x82f67a0590e10f679c062f8e2c235af4ea980bc9', 'USDT')">
             <img src="https://i.postimg.cc/dkyYkPk2/usdt-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="USDT">
             <span class="font-mono text-xs text-slate-300">USDT (TRC20)</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
         <div class="card_ui p-3 rounded-xl flex flex-col items-center" onclick="copyAddress('1RBJu6cHBetMCYHxDZH1x8nw41buXVxJX', 'BTC')">
             <img src="https://i.postimg.cc/gxWnGs7Z/btc-logo.png" class="w-8 h-8 mb-2 rounded-full" alt="BTC">
             <span class="font-mono text-xs text-slate-300">Bitcoin</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
         <div class="card_ui p-3 rounded-xl flex flex-col items-center" onclick="copyAddress('900749799', 'Binance')">
             <img src="https://i.postimg.cc/21r8s6bf/binance-logo.png" class="w-8 h-8 mb-2 rounded-full bg-white p-1" alt="Binance">
             <span class="font-mono text-xs text-slate-300">Binance Pay</span>
             <span class="text-[10px] text-slate-500 mt-1">Tap to Copy</span>
         </div>
    </div>
    <div class="card_ui p-5 rounded-2xl space-y-4">
        <h3 class="font-semibold text-slate-200">Submit Verification Info</h3>
        <input type="hidden" id="deposit_method_input" value="">
        <button id="deposit_method_btn" class="input_field w-full p-3 rounded-xl text-left text-slate-400 flex justify-between items-center">
            <span id="deposit_method_label">Select Payment Method</span>
            <i data-lucide="chevron-down" class="w-5 h-5"></i>
        </button>
        <input type="number" id="deposit_amount_input" placeholder="Amount (USD)" class="input_field w-full p-3 rounded-xl">
        <input type="text" id="deposit_sender_input" placeholder="Your Wallet Address / Binance ID" class="input_field w-full p-3 rounded-xl">
        <button id="submit_deposit_btn" class="primary_btn w-full py-4 rounded-xl text-lg shadow-lg shadow-indigo-500/20">VERIFY DEPOSIT</button>
    </div>
    <div class="pt-4">
        <h3 class="text-sm font-bold text-slate-400 mb-3 px-2">Transaction History</h3>
        <div id="deposit_history_list" class="space-y-2"></div>
    </div>
</div>

<!-- WITHDRAWAL VIEW (New) -->
<div id="panel_withdrawal" class="view_panel space-y-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-100">Withdraw Funds</h2>
        <p class="text-slate-500 text-sm">Request a withdrawal to your wallet</p>
    </div>
    <div class="card_ui p-5 rounded-2xl border-cyan-500/30 bg-cyan-500/5">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-6 h-6 text-cyan-400 shrink-0 mt-1"></i>
            <div>
                 <h4 class="font-bold text-cyan-300 mb-1">WITHDRAWAL INFO</h4>
                 <p id="withdrawal_rules_text" class="text-xs text-cyan-200/70 leading-relaxed">
                    Withdrawals are processed within 24 hours. Minimum withdrawal is <span id="min_withdrawal_info" class="text-white font-bold">$5.00</span>.
                 </p>
            </div>
        </div>
    </div>

<div class="card_ui p-5 rounded-2xl space-y-4">
    <h3 class="font-semibold text-slate-200">Enter Withdrawal Details</h3>
    <input type="hidden" id="withdrawal_method_input" value="">
    <button id="withdrawal_method_btn" class="input_field w-full p-3 rounded-xl text-left text-slate-400 flex justify-between items-center">
        <span id="withdrawal_method_label">Select Withdrawal Method</span>
        <i data-lucide="chevron-down" class="w-5 h-5"></i>
    </button>
    <input type="text" id="withdrawal_address_input" placeholder="Your Wallet Address / Binance ID" class="input_field w-full p-3 rounded-xl">
    <input type="number" id="withdrawal_amount_input" placeholder="Amount to Withdraw (USD)" class="input_field w-full p-3 rounded-xl">
    
    <button id="submit_withdrawal_btn" class="primary_btn w-full py-4 rounded-xl text-lg bg-gradient-to-r from-cyan-500 to-blue-500 shadow-lg shadow-cyan-500/20">SUBMIT WITHDRAWAL</button>
</div>
<div class="pt-4">
    <h3 class="text-sm font-bold text-slate-400 mb-3 px-2">Withdrawal History</h3>
    <div id="withdrawal_history_list" class="space-y-2"></div>
</div>
</div>

<!-- PROFILE VIEW -->
<div id="panel_profile" class="view_panel space-y-6">
    <div class="flex flex-col items-center pt-6">
         <div class="relative mb-4">
            <div class="w-28 h-28 rounded-full p-1 bg-gradient-to-tr from-indigo-500 to-cyan-500">
                 <img id="profile_avatar_img" src="" class="w-full h-full rounded-full bg-slate-900 object-cover p-1 hidden" alt="Profile">
                 <div id="profile_initials_div" class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center text-4xl font-bold text-slate-500 border-4 border-slate-900"></div>
            </div>
        </div>
        <div id="profile_name_text" class="text-2xl font-bold text-white text-center flex items-center gap-2">Loading...</div>
        <button id="copy_uid_btn" class="mt-2 text-xs text-slate-400 bg-slate-800/50 px-3 py-1 rounded-full flex items-center gap-1 hover:bg-slate-800 transition">
            UID: <span id="uid_text">...</span> <i data-lucide="copy" class="w-3 h-3"></i>
        </button>
    </div>
    <div class="grid grid-cols-3 gap-3 text-center">
        <div class="card_ui p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Complete Tasks</p>
            <p id="task_stat" class="text-md font-bold text-cyan-400">0</p>
        </div>
        <div class="card_ui p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Income</p>
            <p id="income_stat" class="text-md font-bold text-yellow-400">$0.00</p>
        </div>
        <div class="card_ui p-3 rounded-xl bg-slate-800/50">
            <p class="text-[11px] text-slate-500 uppercase">Total Refer</p>
            <p id="referral_stat" class="text-md font-bold text-emerald-400">0</p>
        </div>
    </div>
    <div class="space-y-3">
        <button onclick="switchPanel('panel_features')" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-orange-500/10 text-orange-500"><i data-lucide="zap" class="w-5 h-5"></i></div>
                <span class="font-medium">Advanced Features</span>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-600"></i>
        </button>
        <button onclick="launchSupport()" class="card_ui w-full p-4 rounded-xl flex items-center justify-between hover:bg-slate-800 transition">
             <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-500"><i data-lucide="life-buoy" class="w-5 h-5"></i></div>
                <span class="font-medium">Support Hub</span>
            </div>
            <i data-lucide="external-link" class="w-5 h-5 text-slate-600"></i>
        </button>
    </div>
</div>

 <!-- FEATURES VIEW (Transfer) -->
<div id="panel_features" class="view_panel space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchPanel('panel_profile')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold">Tools & Services</h2>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <button onclick="switchPanel('subpanel_send')" class="card_ui p-5 rounded-2xl flex flex-col items-center gap-3 hover:border-indigo-500 transition group">
            <div class="w-14 h-14 rounded-full bg-indigo-500/10 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all text-indigo-500">
                <i data-lucide="send" class="w-7 h-7 ml-1"></i>
            </div>
            <span class="font-semibold">P2P Transfer</span>
        </button>
        <button onclick="switchPanel('panel_premium')" class="card_ui p-5 rounded-2xl flex flex-col items-center gap-3 hover:border-yellow-500 transition group">
            <div class="w-14 h-14 rounded-full bg-yellow-500/10 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-white transition-all text-yellow-500">
                <i data-lucide="gem" class="w-7 h-7"></i>
            </div>
            <span class="font-semibold">Premium</span>
        </button>
    </div>
    <div class="card_ui p-5 rounded-2xl mt-4 bg-slate-800/30">
         <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> Recent Activities</h3>
         <div id="activity_feed" class="space-y-3 text-sm text-slate-500 text-center py-4 max-h-60 overflow-y-auto">
             No recent activities found.
         </div>
    </div>
</div>

<!-- SUBVIEW: P2P SEND -->
<div id="subpanel_send" class="view_panel space-y-6">
     <div class="flex items-center gap-3 mb-6">
        <button onclick="switchPanel('panel_features')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h2 class="text-xl font-bold">Transfer Balance</h2>
    </div>
    <div class="card_ui p-6 rounded-3xl space-y-5">
        <div class="bg-yellow-500/10 text-yellow-500 p-3 rounded-xl text-sm flex gap-2 items-start">
            <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0"></i>
            <p>Default transfer fee is <strong>5%</strong>. Minimum transfer is <strong>$0.50</strong>. Premium members get fee discounts.</p>
        </div>
        <div>
            <label class="text-xs text-slate-400 ml-2 mb-1 block">Recipient UID</label>
            <input type="text" id="p2p_recipient_uid" placeholder="Enter User ID" class="input_field w-full p-4 rounded-xl font-mono">
        </div>
         <div>
            <label class="text-xs text-slate-400 ml-2 mb-1 block">Amount</label>
            <input type="number" id="p2p_transfer_amount" placeholder="0.00" class="input_field w-full p-4 rounded-xl font-bold text-lg">
            <p id="p2p_fee_info" class="text-right text-xs text-slate-500 mt-2 h-4"></p>
        </div>
        <button id="p2p_confirm_btn" class="primary_btn w-full py-4 rounded-xl text-lg">CONFIRM TRANSFER</button>
    </div>
</div>
   <!-- GET PREMIUM VIEW -->
<div id="panel_premium" class="view_panel space-y-6">
    <div class="flex items-center gap-3 mb-6">
       <button onclick="switchPanel('panel_profile')" class="p-2 rounded-full bg-slate-800 text-slate-400"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
       <h2 class="text-xl font-bold">Premium Membership</h2>
    </div>
    <div id="premium_plans_container" class="space-y-4">
        <!-- Tiers will be dynamically loaded here -->
    </div>
</div>

<!-- NEWS VIEW -->
<div id="panel_news" class="view_panel space-y-4">
    <h2 class="text-2xl font-bold px-2">Latest News</h2>
    <div id="news_stream" class="space-y-4">
        <!-- News will be loaded here from Firebase -->
    </div>
</div>
</main>

<!-- DOCK NAVIGATION -->
<nav class="bottom_nav">
    <button class="nav_item current" data-target="panel_dashboard">
        <i data-lucide="home" class="w-6 h-6"></i>
        <span>Home</span>
    </button>
    <button class="nav_item" data-target="panel_tasks">
        <i data-lucide="clipboard-check" class="w-6 h-6"></i>
        <span>Tasks</span>
    </button>
     <button class="nav_item" data-target="panel_refer">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span>Refer</span>
    </button>
    <button class="nav_item" data-target="panel_news">
        <i data-lucide="rss" class="w-6 h-6"></i>
        <span>News</span>
    </button>
    <button class="nav_item" data-target="panel_profile">
        <i data-lucide="user-circle" class="w-6 h-6"></i>
        <span>Account</span>
    </button>
</nav>
</div>

<!-- GENERIC MODAL -->
<div id="generic_modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modal_overlay"></div>
    <div class="popup_modal w-full max-w-sm p-6 rounded-3xl relative transform scale-95 transition-all duration-300" id="modal_container">
        <div id="modal_body_content"></div>
        <button id="modal_close_btn" class="absolute top-4 right-4 p-1 rounded-full bg-slate-800 text-slate-400 hover:text-white">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, onSnapshot, updateDoc, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    let configMinDeposit = 10; 
    let configMinWithdrawal = 5;
    let configMinRefsForWithdrawal = 2;
    let configRefBonus = 1;
    let configTaskReward = 0.5;
    const configP2PFee = 0.05; 
    const configMinP2P = 0.5;
    const adminUID = "CUb4r6eg1RV6Ljkj5U2V1cSswng1";
    
    let premiumPlans = {
        plan0: { name: 'Free', price: 0,  level: 0, duration: 3, taskLimit: 1, benefits: { feeReduction: 0, benefit_text_1: "Daily Task Limit: 1" } },
        plan1: { name: 'Plan 1', price: 10,  level: 1, duration: 30, taskLimit: 2, benefits: { feeReduction: 0.01, benefit_text_1: "Daily Task Limit: 2" } },
        plan2: { name: 'Plan 2', price: 20,  level: 2, duration: 30, taskLimit: 4, benefits: { feeReduction: 0.02, benefit_text_1: "Daily Task Limit: 4" } },
        plan3: { name: 'Plan 3', price: 30, level: 3, duration: 30, taskLimit: 6, benefits: { feeReduction: 0.03, benefit_text_1: "Daily Task Limit: 6" } },
        plan4: { name: 'Plan 4', price: 40, level: 4, duration: 30, taskLimit: 8, benefits: { feeReduction: 0.04, benefit_text_1: "Daily Task Limit: 8" } },
        plan5: { name: 'Plan 5', price: 50, level: 5, duration: 30, taskLimit: 10, benefits: { feeReduction: 0.05, benefit_text_1: "Daily Task Limit: 10" } }
    };

const firebaseSettings = {
  apiKey: "AIzaSyBvbP66g1BYLQEj2XOJRA21meZN4ioJKpc",
  authDomain: "reward-claim-2cc72.firebaseapp.com",
  databaseURL: "https://reward-claim-2cc72-default-rtdb.firebaseio.com",
  projectId: "reward-claim-2cc72",
  storageBucket: "reward-claim-2cc72.firebasestorage.app",
  messagingSenderId: "158110437555",
  appId: "1:158110437555:web:e7c671b33fc0b7b24120c6"
};
    const fbApp = initializeApp(firebaseSettings);
    const fbDb = getFirestore(fbApp);
    const fbAuth = getAuth(fbApp);
    let tgData = null;
    let userState = null;
    let globalConfig = {};
    let activeIntervals = []; 
    let authUser = null;

    window.onload = async () => {
        try {
            if(window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('#0f172a');
                window.Telegram.WebApp.setBackgroundColor('#0f172a');
                if (window.Telegram.WebApp.initDataUnsafe?.user) {
                    tgData = window.Telegram.WebApp.initDataUnsafe.user;
                }
            }
        } catch (e) { 
            console.error("TG WebApp init failed:", e); 
        }

        if (!tgData) {
            document.body.innerHTML = `
            <div class="flex flex-col items-center justify-center h-screen text-center p-4">
                <div class="card_ui p-8 rounded-2xl w-full max-w-sm">
                    <i data-lucide="alert-triangle" class="w-16 h-16 mb-4 mx-auto text-red-500"></i>
                    <h1 class="text-2xl font-bold text-red-400">Authentication Failed</h1>
                    <p class="text-slate-400 text-sm font-normal mt-2">Could not identify user. Please launch this app through the official Telegram bot.</p>
                </div>
            </div>`;
            lucide.createIcons();
            return;
        }

        try {
            const userCred = await signInAnonymously(fbAuth);
            authUser = userCred.user;
            await initializeCoreLogic();
        } catch (error) {
            console.error("Firebase Auth Failed:", error);
            document.getElementById('loader_msg').innerText = 'Connection Error. Please restart.';
        }
    };

    async function initializeCoreLogic() {
        await fetchRemoteConfig();
        await startUserSession();
        initializeUIHandlers();
        lucide.createIcons();
        startLiveWithdrawalFeed();

        document.getElementById('loader_screen').style.opacity = '0';
        setTimeout(() => document.getElementById('loader_screen').remove(), 500);
    }

    async function startUserSession() {
        const userId = String(tgData.id);
        const userDocRef = doc(fbDb, "users", userId);
        const docSnap = await getDoc(userDocRef);

        if (docSnap.exists()) {
            userState = docSnap.data();
            if (!userState.firebaseUid || userState.firebaseUid !== authUser.uid) {
                await updateDoc(userDocRef, { firebaseUid: authUser.uid });
                userState.firebaseUid = authUser.uid;
            }
        } else {
            userState = {
                tgChatId: userId,
                firebaseUid: authUser.uid,
                name: `${tgData.first_name} ${tgData.last_name || ''}`.trim(),
                username: tgData.username || null,
                balance: 0,
                createdAt: serverTimestamp(),
                isPremium: false,
                premiumTier: 'plan0',
                premiumExpiry: null,
                lastNotificationCheck: null,
                dailyCompletedTasks: [],
                referredBy: null
            };
            await setDoc(userDocRef, userState);
        }

        if(userState.isBlocked) {
            document.body.innerHTML = '<div class="flex items-center justify-center h-screen text-red-500 font-bold">ACCOUNT SUSPENDED</div>';
            throw new Error("User account is blocked.");
        }
        
        updateUI();
        startRealtimeUpdates();
        checkForNotifications();
        verifyTrialStatus();
    }

    async function fetchRemoteConfig() {
        try {
            const configDocRef = doc(fbDb, "config", "main");
            const configSnap = await getDoc(configDocRef);
            if (configSnap.exists()) {
                const remoteConfig = configSnap.data();
                globalConfig = remoteConfig;

                configMinDeposit = globalConfig.minDeposit || 10;
                configMinWithdrawal = globalConfig.minWithdrawal || 5;
                configMinRefsForWithdrawal = globalConfig.minReferralsForWithdrawal || 2;
                configRefBonus = globalConfig.referralBonus || 1;
                configTaskReward = globalConfig.taskReward || 0.5;

                document.getElementById('min_deposit_info').textContent = `$${configMinDeposit.toFixed(2)}`;
                document.getElementById('min_withdrawal_info').textContent = `$${configMinWithdrawal.toFixed(2)}`;
                const withdrawalInfo = `Withdrawals are processed within 24 hours. Minimum withdrawal is <span class="text-white font-bold">$${configMinWithdrawal.toFixed(2)}</span>. You need at least <span class="text-white font-bold">${configMinRefsForWithdrawal}</span> referrals to withdraw.`;
                document.getElementById('withdrawal_rules_text').innerHTML = withdrawalInfo;
                
                if(remoteConfig.premiumTiers) {
                     Object.keys(premiumPlans).forEach(key => {
                        if(remoteConfig.premiumTiers[key]) {
                            const tierData = remoteConfig.premiumTiers[key];
                            premiumPlans[key].price = tierData.price !== undefined ? tierData.price : premiumPlans[key].price;
                            premiumPlans[key].duration = tierData.duration !== undefined ? tierData.duration : premiumPlans[key].duration;
                            premiumPlans[key].taskLimit = tierData.taskLimit !== undefined ? tierData.taskLimit : premiumPlans[key].taskLimit;
                            if(tierData.benefits) {
                                premiumPlans[key].benefits = {...premiumPlans[key].benefits, ...tierData.benefits};
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.error("Could not load remote config, using defaults.", error);
        }
    }

    function updateUI() {
        if(!userState) return;
        const currentBalance = userState.balance.toFixed(2);
        document.getElementById('balance_display_main').textContent = `$${currentBalance}`;
        document.getElementById('header_user_balance').textContent = `$${currentBalance}`;

        const userInitials = (tgData.first_name?.[0] || 'U') + (tgData.last_name?.[0] || '');
        document.getElementById('header_user_initials').textContent = userInitials.toUpperCase();
        document.getElementById('profile_initials_div').textContent = userInitials.toUpperCase();

        if(tgData.photo_url) {
            document.getElementById('header_user_avatar').src = tgData.photo_url;
            document.getElementById('header_user_avatar').classList.remove('hidden');
            document.getElementById('header_user_initials').classList.add('hidden');
             document.getElementById('profile_avatar_img').src = tgData.photo_url;
            document.getElementById('profile_avatar_img').classList.remove('hidden');
            document.getElementById('profile_initials_div').classList.add('hidden');
        }

        const profileNameElem = document.getElementById('profile_name_text');
        const isPremiumExpired = userState.premiumExpiry && userState.premiumExpiry.toDate() < new Date();
        
        if (userState.isPremium && userState.premiumTier !== 'plan0' && !isPremiumExpired) {
             profileNameElem.innerHTML = `
                <span>${userState.name}</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor">
                  <path fill-rule="evenodd" d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.497 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.491 4.491 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" style="color: #3b82f6;"></path>
                </svg>`;
        } else {
            if(userState.isPremium && isPremiumExpired){
                updateDoc(doc(fbDb, "users", userState.tgChatId), { isPremium: false, premiumTier: 'plan0', premiumExpiry: null });
            }
            profileNameElem.innerHTML = `<span>${userState.name}</span>`;
        }

        document.getElementById('uid_text').textContent = userState.tgChatId;
    }
    
    function verifyTrialStatus() {
        if (!userState || !userState.createdAt || userState.premiumTier !== 'plan0' || !(userState.createdAt.toDate)) {
            return;
        }

        const creationDate = userState.createdAt.toDate();
        const trialEnd = new Date(creationDate);
        const trialDays = premiumPlans.plan0.duration;
        trialEnd.setDate(trialEnd.getDate() + trialDays);

        if (new Date() > trialEnd) {
            const popupContent = `
                <div class="text-center space-y-4">
                    <i data-lucide="clock" class="w-12 h-12 mx-auto text-yellow-400"></i>
                    <h3 class="text-xl font-bold">Free Trial Ended</h3>
                    <p class="text-slate-300">Your ${trialDays}-day free trial has expired. Please upgrade to a premium plan to continue earning rewards.</p>
                    <button onclick="switchPanel('panel_premium'); hideModal();" class="primary_btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">View Plans</button>
                </div>
            `;
            displayModal(popupContent, false); 
        }
    }

    window.switchPanel = function(panelId) {
        activeIntervals.forEach(id => clearInterval(id));
        activeIntervals = [];

        document.querySelectorAll('.view_panel').forEach(el => el.classList.remove('visible'));
        document.getElementById(panelId).classList.add('visible');

        const mainPanels = ['panel_dashboard', 'panel_tasks', 'panel_refer', 'panel_news', 'panel_profile'];
        if (mainPanels.includes(panelId)) {
            document.querySelectorAll('.nav_item').forEach(btn => {
                btn.classList.toggle('current', btn.dataset.target === panelId);
            });
        }
        
        const topFundBtn = document.querySelector('header .flex.items-center.gap-2 > button:first-child');
        if (topFundBtn) {
           topFundBtn.style.display = (panelId === 'panel_deposit' || panelId === 'panel_withdrawal') ? 'none' : 'inline-flex';
        }

        if(panelId === 'panel_tasks') renderTaskView();
        if(panelId === 'panel_deposit') renderDepositHistory();
        if(panelId === 'panel_withdrawal') renderWithdrawalHistory();
        if(panelId === 'panel_profile') renderProfileStats();
        if(panelId === 'panel_news') renderNewsFeed();
        if(panelId === 'panel_premium') renderPremiumPlans();
        if(panelId === 'panel_features') renderActivityFeed();
        if(panelId === 'panel_refer') renderReferralView();

        window.scrollTo(0,0);
    }
    
    function renderPremiumPlans() {
        const containerElem = document.getElementById('premium_plans_container');
        const planKeys = Object.keys(premiumPlans).sort((a,b) => premiumPlans[a].level - premiumPlans[b].level);
        const isExpired = userState.premiumExpiry && userState.premiumExpiry.toDate() < new Date();
        const userLevel = (userState.isPremium && !isExpired) ? premiumPlans[userState.premiumTier]?.level || 0 : 0;
        
        let contentHTML = planKeys.map(key => {
            const plan = premiumPlans[key];
            if (plan.level === 0) return '';
            
            let benefitsHTML = [];
            for (const bKey in plan.benefits) {
                if (bKey.startsWith('benefit_text_')) {
                    benefitsHTML.push(`<li><i class="inline-block w-4 h-4" data-lucide="check"></i> ${plan.benefits[bKey]}</li>`);
                }
            }
            if (plan.benefits.feeReduction > 0) {
                 const newFee = (configP2PFee - plan.benefits.feeReduction) * 100;
                 benefitsHTML.push(`<li><i class="inline-block w-4 h-4" data-lucide="check"></i> P2P Fee reduced to <strong>${newFee.toFixed(0)}%</strong></li>`);
            }
            
            let buttonContent;
            const isCurrent = plan.level === userLevel && !isExpired;
            
            if (isCurrent) {
                buttonContent = `<div class="text-center font-semibold text-lg text-green-400 py-3">CURRENT PLAN</div>`;
                if(userState.premiumExpiry) {
                    const countdownElemId = `countdown-${key}`;
                    buttonContent += `<div id="${countdownElemId}" class="text-center font-mono text-sm text-cyan-400 pb-3"></div>`;
                    const intervalId = setInterval(() => {
                        const nowMs = new Date().getTime();
                        const expiryMs = userState.premiumExpiry.toDate().getTime();
                        const diff = expiryMs - nowMs;

                        if (diff < 0) {
                            clearInterval(intervalId);
                            document.getElementById(countdownElemId).innerHTML = "EXPIRED";
                            return;
                        }

                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        document.getElementById(countdownElemId).innerHTML = `Expires in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    }, 1000);
                    activeIntervals.push(intervalId);
                }
            } else if (plan.level < userLevel && !isExpired) {
                buttonContent = `<button class="primary_btn w-full py-3 rounded-xl" disabled>Activated</button>`;
            } else {
                buttonContent = `<button onclick="buyPremiumPlan('${key}')" class="primary_btn w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500">UPGRADE</button>`;
            }

            return `
            <div class="card_ui p-5 rounded-2xl ${isCurrent ? 'border-yellow-400/50' : 'border-slate-700'}">
                <h3 class="text-2xl font-bold text-yellow-400">${plan.name}</h3>
                <p class="text-3xl font-bold my-3">$${plan.price} <span class="text-lg text-slate-400">/ ${plan.duration} days</span></p>
                <ul class="text-sm text-slate-300 space-y-2 my-4 text-left pl-2">
                    ${benefitsHTML.join('')}
                </ul>
                ${buttonContent}
            </div>`;
        }).join('');
        containerElem.innerHTML = contentHTML;
        lucide.createIcons();
    }

    window.buyPremiumPlan = async function(planKey) {
        const plan = premiumPlans[planKey];
        if (userState.balance < plan.price) {
            return showMessage(`Insufficient balance. You need $${plan.price}.`, 'error');
        }

        displayModal(`
            <div class="text-center space-y-4">
                <h3 class="text-xl font-bold">Confirm Purchase</h3>
                <p>Are you sure you want to buy the ${plan.name} plan for $${plan.price} (${plan.duration} days)?</p>
                <button id="confirm_purchase_btn" class="primary_btn w-full py-3 rounded-xl">Confirm</button>
                <button onclick="hideModal()" class="card_ui w-full py-2 rounded-xl mt-2">Cancel</button>
            </div>
        `);

        document.getElementById('confirm_purchase_btn').onclick = async function() {
            this.disabled = true; this.textContent = "PROCESSING...";
            try {
                const userDocRef = doc(fbDb, "users", userState.tgChatId);
                await runTransaction(fbDb, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists() || userDoc.data().balance < plan.price) {
                        throw "Transaction failed: Insufficient funds.";
                    }
                    
                    const newBalance = userDoc.data().balance - plan.price;
                    const newExpiryDate = new Date();
                    newExpiryDate.setDate(newExpiryDate.getDate() + plan.duration);
                    
                    transaction.update(userDocRef, {
                        balance: newBalance,
                        isPremium: true,
                        premiumTier: planKey,
                        premiumExpiry: Timestamp.fromDate(newExpiryDate)
                    });
                });
                
                logActivity(`upgraded to ${plan.name} Premium!`);
                hideModal();
                showMessage(`Successfully upgraded to ${plan.name}!`, 'success');
                
                userState.balance -= plan.price;
                userState.isPremium = true;
                userState.premiumTier = planKey;
                const expiry = new Date();
                expiry.setDate(expiry.getDate() + plan.duration);
                userState.premiumExpiry = Timestamp.fromDate(expiry);

                updateUI();
                renderPremiumPlans();

            } catch (error) {
                hideModal();
                showMessage(error.toString(), 'error');
            }
        };
    }

    function renderTaskView() {
        if (userState.premiumTier === 'plan0' && userState.createdAt && userState.createdAt.toDate) {
            const creationDate = userState.createdAt.toDate();
            const trialEnd = new Date(creationDate);
            trialEnd.setDate(trialEnd.getDate() + premiumPlans.plan0.duration);
            if (new Date() > trialEnd) {
                verifyTrialStatus();
                document.getElementById('task_container').innerHTML = '';
                return;
            }
        }
        
        const container = document.getElementById('task_container');
        window.startMission = startMission;

        const reward = configTaskReward;
        const taskURL = globalConfig.taskLink || "https://adexora.my.id/dl/AqMmpgSA5cUt";
        
        let limit = premiumPlans.plan0.taskLimit;
        const isExpired = userState.premiumExpiry && userState.premiumExpiry.toDate() < new Date();
        
        if (userState.isPremium && userState.premiumTier && !isExpired) {
            limit = premiumPlans[userState.premiumTier]?.taskLimit || limit;
        }

        const todayStr = new Date().toISOString().split('T')[0];
        const completedTodayIds = (userState.dailyCompletedTasks || [])
            .filter(task => task.completedAt && new Date(task.completedAt.seconds * 1000).toISOString().split('T')[0] === todayStr)
            .map(task => task.taskId);
        
        let nextTask = null;
        
        for (let i = 1; i <= limit; i++) {
            const id = `daily_task_${i}`;
            if (!completedTodayIds.includes(id)) {
                nextTask = { id: id, title: `Task ${i}`, reward: reward, link: taskURL };
                break;
            }
        }

        let tasksContent = Array.from({ length: limit }, (_, i) => {
            const taskId = `daily_task_${i + 1}`;
            const isDone = completedTodayIds.includes(taskId);
            const taskData = { id: taskId, title: `Task ${i + 1}`, reward: reward, link: taskURL };
            const isNext = nextTask && taskData.id === nextTask.id;

            let button;
            if (isDone) {
                button = `<button class="bg-emerald-500 text-white px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Completed</button>`;
            } else if (isNext) {
                button = `<button onclick='startMission(${JSON.stringify(taskData)}, this)' class="mission_btn glowing_mission_btn px-5 py-2 rounded-lg text-sm">UPDATE</button>`;
            } else {
                button = `<button class="bg-slate-600 text-slate-300 px-5 py-2 rounded-lg font-semibold text-sm cursor-not-allowed">Locked</button>`;
            }

            return `
                <div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/20 p-3 rounded-full">
                             <i data-lucide="arrow-up-right-square" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-slate-200">${taskData.title}</h3>
                            <p class="text-yellow-400 font-bold text-sm">Reward: $${taskData.reward.toFixed(2)}</p>
                        </div>
                    </div>
                    ${button}
                </div>
            `;
        }).join('');
        
        container.innerHTML = tasksContent;
        
        if (completedTodayIds.length >= limit) {
            const timerCard = `
                <div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700 mt-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-500/20 p-3 rounded-full">
                             <i data-lucide="arrow-up-right-square" class="w-6 h-6 text-indigo-400"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md text-slate-200">Tasks Reset In</h3>
                            <p id="task_reset_timer" class="text-cyan-400 font-bold text-sm font-mono">--:--:--</p>
                        </div>
                    </div>
                    <button onclick="switchPanel('panel_premium')" class="mission_btn px-5 py-2 rounded-lg text-sm">GET MORE</button>
                </div>`;
            container.innerHTML += timerCard;
            startResetTimer();
        }

        lucide.createIcons();
    }
    
    function startResetTimer() {
        const timerElem = document.getElementById('task_reset_timer');
        if (!timerElem) return;

        const intervalId = setInterval(() => {
            const now = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const diff = tomorrow.getTime() - now.getTime();
            if (diff <= 0) {
                clearInterval(intervalId);
                timerElem.textContent = "00:00:00";
                renderTaskView();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            timerElem.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
        activeIntervals.push(intervalId);
    }
    
    function startMission(taskData, button) {
        button.disabled = true;
        window.open(taskData.link, '_blank');

        let countdown = 10;
        button.textContent = `Waiting (${countdown}s)`;
        const intervalId = setInterval(() => {
            countdown--;
            button.textContent = `Waiting (${countdown}s)`;
            if (countdown <= 0) {
                clearInterval(intervalId);
                finalizeMission(taskData);
            }
        }, 1000);
        activeIntervals.push(intervalId);
    }
    
    async function finalizeMission(taskData) {
        if (!taskData) return;

        const todayStr = new Date().toISOString().split('T')[0];
        const isDone = (userState.dailyCompletedTasks || [])
            .some(t => t.taskId === taskData.id && t.completedAt && new Date(t.completedAt.seconds * 1000).toISOString().split('T')[0] === todayStr);

        if (isDone) {
            showMessage(`This task has already been completed today.`, 'info');
            return;
        }

        try {
            const userDocRef = doc(fbDb, "users", userState.tgChatId);
            await runTransaction(fbDb, async (transaction) => {
                const userDoc = await transaction.get(userDocRef);
                if (!userDoc.exists()) throw "User not found.";

                const data = userDoc.data();
                const newBalance = data.balance + taskData.reward;
                const newEntry = { taskId: taskData.id, completedAt: Timestamp.fromDate(new Date()) };
                
                const existingTasks = Array.isArray(data.dailyCompletedTasks) ? data.dailyCompletedTasks : [];
                const updatedTasks = [...existingTasks, newEntry];

                transaction.update(userDocRef, {
                    balance: newBalance,
                    dailyCompletedTasks: updatedTasks
                });
            });
            showMessage(`Congratulations! You've earned $${taskData.reward.toFixed(2)}`, 'success');
            logActivity(`earned $${taskData.reward.toFixed(2)} from a task.`);
        } catch (e) {
            console.error("Error completing task:", e);
            showMessage(`Error: ${e.message || e}`, 'error');
            if (document.getElementById('panel_tasks').classList.contains('visible')) {
                renderTaskView();
            }
        }
    }

    document.getElementById('submit_deposit_btn').addEventListener('click', async () => {
        const method = document.getElementById('deposit_method_input').value;
        const amount = parseFloat(document.getElementById('deposit_amount_input').value);
        const sender = document.getElementById('deposit_sender_input').value.trim();

        if(!method || !amount || !sender) return showMessage("Please fill all fields", "warning");
        if(amount < configMinDeposit) return displayModal(`<div class="text-center text-red-400 space-y-3"><i data-lucide="alert-octagon" class="w-12 h-12 mx-auto"></i><h3 class="font-bold text-lg">Invalid Amount</h3><p class="text-slate-300">Minimum deposit amount is <span class="font-bold text-white">$${configMinDeposit.toFixed(2)}</span>.</p><button onclick="hideModal()" class="card_ui w-full py-2 rounded-xl mt-4">OK</button></div>`);

        const btn = document.getElementById('submit_deposit_btn');
        btn.disabled = true; btn.innerText = "VERIFYING...";

        try {
            await addDoc(collection(fbDb, "deposits"), {
                userId: userState.tgChatId,
                firebaseUid: userState.firebaseUid,
                userName: userState.name, 
                method, 
                amount, 
                senderNumber: sender,
                status: "pending", 
                requestedAt: serverTimestamp()
            });
            
            displayModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Submitted!</h3><p class="text-slate-400">Your deposit of $${amount} is under review. It typically takes 5-30 minutes.</p><button onclick="hideModal()" class="primary_btn w-full py-2 rounded-xl">OK</button></div>`);
            
            document.getElementById('deposit_method_input').value = '';
            document.getElementById('deposit_method_label').textContent = 'Select Payment Method';
            document.getElementById('deposit_method_btn').classList.add('text-slate-400');
            document.getElementById('deposit_amount_input').value = '';
            document.getElementById('deposit_sender_input').value = '';
            renderDepositHistory();

        } catch(e) { showMessage(e.message, "error");
        } finally {
            btn.disabled = false; btn.innerText = "VERIFY DEPOSIT"; lucide.createIcons();
        }
    });

    async function renderDepositHistory() {
        const elem = document.getElementById('deposit_history_list');
        const q = query(collection(fbDb, "deposits"), where("userId", "==", userState.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { elem.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">No deposit history.</p>'; return; }

        elem.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const colors = { pending: 'text-yellow-500', approved: 'text-emerald-500', rejected: 'text-red-500' };
            const dateStr = data.requestedAt ? new Date(data.requestedAt.seconds * 1000).toLocaleDateString() : 'N/A';
            return `
            <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-xl border border-slate-800">
                <div>
                    <p class="text-sm font-medium text-slate-300">${data.method} - $${data.amount}</p>
                    <p class="text-[10px] text-slate-500 font-mono">${dateStr}</p>
                </div>
                <span class="text-xs font-bold ${colors[data.status] || 'text-slate-400'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }
    
    document.getElementById('submit_withdrawal_btn').addEventListener('click', async () => {
        const method = document.getElementById('withdrawal_method_input').value;
        const address = document.getElementById('withdrawal_address_input').value.trim();
        const amount = parseFloat(document.getElementById('withdrawal_amount_input').value);
        
        const btn = document.getElementById('submit_withdrawal_btn');
        btn.disabled = true; btn.innerText = "PROCESSING...";

        try {
            const refsQuery = query(collection(fbDb, "users"), where("referredBy", "==", userState.tgChatId));
            const refsSnap = await getDocs(refsQuery);
            if (refsSnap.size < configMinRefsForWithdrawal) {
                throw new Error(`You need at least ${configMinRefsForWithdrawal} referrals to make a withdrawal.`);
            }

            if (!method || !address || isNaN(amount)) throw new Error("Please fill all fields correctly.");
            if (amount < configMinWithdrawal) throw new Error(`Minimum withdrawal is $${configMinWithdrawal.toFixed(2)}.`);
            if (userState.balance < amount) throw new Error("Insufficient balance.");

            const userDocRef = doc(fbDb, "users", userState.tgChatId);

            await runTransaction(fbDb, async (transaction) => {
                const userDoc = await transaction.get(userDocRef);
                if (!userDoc.exists() || userDoc.data().balance < amount) {
                    throw new Error("Transaction failed: Insufficient funds.");
                }

                const newBalance = userDoc.data().balance - amount;
                transaction.update(userDocRef, { balance: newBalance });

                const withdrawalDocRef = doc(collection(fbDb, "withdrawals"));
                transaction.set(withdrawalDocRef, {
                    userId: userState.tgChatId,
                    firebaseUid: userState.firebaseUid,
                    userName: userState.name,
                    method,
                    address,
                    amount,
                    status: "pending",
                    requestedAt: serverTimestamp()
                });
            });

            displayModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Withdrawal Submitted!</h3><p class="text-slate-400">Your withdrawal request for $${amount} has been received and will be processed within 24 hours.</p><button onclick="hideModal()" class="primary_btn w-full py-2 rounded-xl">OK</button></div>`);
            
            document.getElementById('withdrawal_method_input').value = '';
            document.getElementById('withdrawal_method_label').textContent = 'Select Withdrawal Method';
            document.getElementById('withdrawal_method_btn').classList.add('text-slate-400');
            document.getElementById('withdrawal_address_input').value = '';
            document.getElementById('withdrawal_amount_input').value = '';
            renderWithdrawalHistory();

        } catch(e) {
            showMessage(e.message, "error");
        } finally {
            btn.disabled = false; btn.innerText = "SUBMIT WITHDRAWAL";
            lucide.createIcons();
        }
    });

    async function renderWithdrawalHistory() {
        const elem = document.getElementById('withdrawal_history_list');
        elem.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">Loading history...</p>';
        const q = query(collection(fbDb, "withdrawals"), where("userId", "==", userState.tgChatId), orderBy("requestedAt", "desc"), limit(10));
        const snap = await getDocs(q);

        if(snap.empty) { elem.innerHTML = '<p class="text-slate-600 text-center text-xs py-2">No withdrawal history.</p>'; return; }

        elem.innerHTML = snap.docs.map(d => {
            const data = d.data();
            const colors = { pending: 'text-yellow-500', approved: 'text-emerald-500', rejected: 'text-red-500' };
            return `
            <div class="flex justify-between items-center p-3 bg-slate-800/40 rounded-xl border border-slate-800">
                <div>
                    <p class="text-sm font-medium text-slate-300">${data.method} - $${data.amount}</p>
                    <p class="text-[10px] text-slate-500 font-mono">${data.address}</p>
                </div>
                <span class="text-xs font-bold ${colors[data.status] || 'text-slate-400'} uppercase">${data.status}</span>
            </div>`;
        }).join('');
    }

    async function startLiveWithdrawalFeed() {
        const container = document.getElementById('withdrawal_stream_container');
        if (!container) return;

        let activities = [];

        try {
            const fakeQ = query(collection(fbDb, "fake_deposits"), limit(20));
            const fakeSnap = await getDocs(fakeQ);
            fakeSnap.forEach(doc => {
                activities.push({ ...doc.data(), isFake: true });
            });

            const realQ = query(collection(fbDb, "withdrawals"), where("status", "==", "approved"), orderBy("requestedAt", "desc"), limit(10));
            const realSnap = await getDocs(realQ);
            realSnap.forEach(doc => {
                const data = doc.data();
                activities.push({ name: data.userName, amount: data.amount, isFake: false });
            });

            activities.sort(() => 0.5 - Math.random());

            if (activities.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-600 text-sm p-4">No recent activity.</p>';
                 return;
            }
            
            let index = 0;
            function displayNextActivity() {
                if (activities.length === 0) return;
                const activity = activities[index];
                const name = activity.name.substring(0, 3) + '***';
                const time = Math.floor(Math.random() * 59) + 1;

                const item = document.createElement('div');
                item.className = 'card_ui p-3 rounded-xl flex items-center gap-3 animate_fade';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-cyan-500/10 flex items-center justify-center">
                        <i data-lucide="arrow-up-right" class="w-5 h-5 text-cyan-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-200">
                            ${name} just withdrew <span class="text-cyan-400">$${activity.amount}</span>
                        </p>
                        <p class="text-xs text-slate-500">${time} seconds ago</p>
                    </div>`;
                
                container.prepend(item);
                lucide.createIcons();

                if (container.children.length > 10) {
                    container.lastChild.remove();
                }

                index = (index + 1) % activities.length;
            }

            displayNextActivity();
            const intervalId = setInterval(displayNextActivity, Math.random() * (8000 - 4000) + 4000);
            activeIntervals.push(intervalId);

        } catch (e) {
            console.error("Failed to load activity feed:", e);
            container.innerHTML = '<p class="text-center text-red-500 text-sm">Could not load feed.</p>';
        }
    }
    
    async function renderReferralView() {
        const linkElem = document.getElementById('ref_link_field');
        const countElem = document.getElementById('ref_count_stat');
        const earningsElem = document.getElementById('ref_earnings_stat');
        
        document.getElementById('ref_bonus_amount_text').textContent = `$${configRefBonus.toFixed(2)}`;
        document.getElementById('ref_claim_bonus_text').textContent = `$${configRefBonus.toFixed(2)}`;
        
        const referralURL = `https://t.me/Reward_Claimlbot/eaen?start=${userState.tgChatId}`;
        linkElem.value = referralURL;
        
        const inputContainer = document.getElementById('referral_code_section');
        if (userState.referredBy) {
            const referrerDocRef = doc(fbDb, "users", userState.referredBy);
            const referrerSnap = await getDoc(referrerDocRef);
            let referrer = `UID: ${userState.referredBy}`;
            if(referrerSnap.exists()){
                referrer = referrerSnap.data().name || `UID: ${userState.referredBy}`;
            }

            inputContainer.innerHTML = `
                <h3 class="font-semibold text-slate-200 text-lg flex items-center justify-center gap-2"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>Referral Claimed</h3>
                <p class="text-sm text-slate-400">You were referred by: <span class="font-semibold text-white">${referrer}</span></p>
            `;
            lucide.createIcons();
        }
        
        startLiveReferralFeed();

        async function fetchReferralStats() {
            try {
                const q = query(collection(fbDb, "users"), where("referredBy", "==", userState.tgChatId));
                const snap = await getDocs(q);
                
                countElem.textContent = snap.docs.length;
                const earnings = snap.docs.length * configRefBonus; 
                earningsElem.textContent = `$${earnings.toFixed(2)}`;
                
            } catch (error) {
                console.error("Error loading referral data:", error);
            }
        }
        
        fetchReferralStats();
    }

    async function processReferralCode() {
        const btn = document.getElementById('verify_ref_btn');
        const input = document.getElementById('ref_code_input');
        const code = input.value.trim();
        const reward = configRefBonus;

        if (!code) return showMessage("Please enter a referral code.", "warning");
        if (userState.referredBy) return showMessage("You have already used a referral code.", "error");
        if (code === userState.tgChatId) return showMessage("You cannot refer yourself.", "error");

        btn.disabled = true;
        btn.innerHTML = 'VERIFYING...';

        try {
            await runTransaction(fbDb, async (transaction) => {
                const currentUserDocRef = doc(fbDb, "users", userState.tgChatId);
                const referrerDocRef = doc(fbDb, "users", code);

                const [currentUserDoc, referrerDoc] = await Promise.all([
                    transaction.get(currentUserDocRef),
                    transaction.get(referrerDocRef)
                ]);

                if (!currentUserDoc.exists()) throw new Error("Your user data could not be found.");
                if (!referrerDoc.exists()) throw new Error("The referral code is invalid or the user does not exist.");

                const currentUserData = currentUserDoc.data();
                if (currentUserData.referredBy) throw new Error("You have already claimed a referral bonus.");

                transaction.update(currentUserDocRef, {
                    balance: currentUserData.balance + reward,
                    referredBy: code
                });

                transaction.update(referrerDocRef, {
                    balance: referrerDoc.data().balance + reward
                });

                const logDocRef = doc(collection(fbDb, "referral_logs"));
                transaction.set(logDocRef, {
                    referrerId: code,
                    referrerName: referrerDoc.data().name || 'A user',
                    refereeId: userState.tgChatId,
                    refereeName: userState.name,
                    reward: reward,
                    timestamp: serverTimestamp()
                });
            });

            showMessage(`Success! You and your friend both earned $${reward.toFixed(2)}.`, 'success');
            userState.balance += reward;
            userState.referredBy = code;
            updateUI();
            renderReferralView(); 

        } catch (e) {
            showMessage("Error: " + e.message, "error");
            btn.disabled = false;
            btn.innerHTML = `VERIFY & CLAIM <span id="ref_claim_bonus_text">$${configRefBonus.toFixed(2)}</span>`;
        }
    }
    
    async function startLiveReferralFeed() {
        const container = document.getElementById('referral_stream_container');
        if (!container) return;

        try {
            const q = query(collection(fbDb, "referral_logs"), orderBy("timestamp", "desc"), limit(20));
            const snap = await getDocs(q);

            let activities = [];
            snap.forEach(doc => activities.push(doc.data()));

            if (activities.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-600 text-sm p-4">Be the first to refer a friend!</p>';
                 return;
            }

            let index = 0;
            const displayNext = () => {
                if (activities.length === 0) return;
                const activity = activities[index];
                const referee = (activity.refereeName || 'Someone').substring(0, 3) + '***';
                const referrer = (activity.referrerName || 'A user').substring(0, 3) + '***';
                const time = Math.floor(Math.random() * 59) + 1;

                const item = document.createElement('div');
                item.className = 'card_ui p-3 rounded-xl flex items-center gap-3 animate_fade';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center">
                        <i data-lucide="award" class="w-5 h-5 text-emerald-400"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-slate-200">
                           ${referee} was invited by ${referrer}!
                        </p>
                        <p class="text-xs text-slate-500">Both earned $${activity.reward.toFixed(2)} - ${time}s ago</p>
                    </div>`;

                container.prepend(item);
                lucide.createIcons();

                if (container.children.length > 10) {
                    container.lastChild.remove();
                }
                index = (index + 1) % activities.length;
            };

            displayNext();
            const intervalId = setInterval(displayNext, Math.random() * (9000 - 5000) + 5000);
            activeIntervals.push(intervalId);

        } catch (e) {
            console.error("Failed to load referral feed:", e);
            container.innerHTML = '<p class="text-center text-red-500 text-sm">Could not load feed.</p>';
        }
    }

    window.shareViaTelegram = function() {
        const url = document.getElementById('ref_link_field').value;
        const msg = "Join me on REWARD CLAIM and earn money! Use my link to sign up:";
        const tgURL = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(msg)}`;
        window.open(tgURL, '_blank');
    }

    window.shareNatively = async function() {
        const url = document.getElementById('ref_link_field').value;
        const data = {
            title: 'Join REWARD CLAIM',
            text: 'Join me on REWARD CLAIM and earn money! Use my link to sign up:',
            url: url,
        };
        try {
            if (navigator.share) {
                await navigator.share(data);
            } else {
                throw new Error('Web Share API not supported');
            }
        } catch (err) {
            copyToClipboard(url);
            showMessage('Share not supported, link copied instead!', 'info');
        }
    }

    async function checkForNotifications() {
        const lastCheckTime = userState.lastNotificationCheck || Timestamp.fromDate(new Date(0));
        const q = query(
            collection(fbDb, "notifications"), 
            where("userId", "==", userState.tgChatId),
            where("createdAt", ">", lastCheckTime), 
            limit(1)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
            document.getElementById('notification_badge').classList.remove('hidden');
        }
    }

    async function renderNotifications() {
        const q = query(
            collection(fbDb, "notifications"), 
            where("userId", "==", userState.tgChatId),
            orderBy("createdAt", "desc"), 
            limit(10)
        );
        const snap = await getDocs(q);

        let content = `<h3 class="text-lg font-bold text-white mb-4">Notifications</h3><div class="space-y-3 max-h-80 overflow-y-auto">`;
        if (snap.empty) {
            content += `<p class="text-slate-500 text-center">No new notifications.</p>`;
        } else {
            content += snap.docs.map(doc => {
                const n = doc.data();
                const date = n.createdAt.toDate().toLocaleString();
                return `<div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                            <p class="font-semibold text-slate-200">${n.title}</p>
                            <p class="text-sm text-slate-400">${n.message}</p>
                            <p class="text-xs text-slate-600 text-right mt-2">${date}</p>
                       </div>`;
            }).join('');
        }
        content += `</div>`;
        displayModal(content);
        lucide.createIcons();

        document.getElementById('notification_badge').classList.add('hidden');
        await updateDoc(doc(fbDb, "users", userState.tgChatId), {
            lastNotificationCheck: serverTimestamp()
        });
    }
    
    async function logActivity(text) {
        try {
            await addDoc(collection(fbDb, "public_activity"), {
                userId: userState.tgChatId,
                userName: userState.name,
                userPhoto: tgData.photo_url || null,
                action: text,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Failed to log public activity:", e);
        }
    }

    window.launchPremiumPage = () => { closeSideMenu(); switchPanel('panel_premium'); };
    window.launchSupport = () => { 
        const url = globalConfig.supportLink || "https://t.me/sarahmartinBTC";
        window.open(url, '_blank'); 
    };
    window.launchWebsite = () => {
        const url = globalConfig.websiteUrl || "#";
        window.open(url, '_blank');
    };
    window.closeSideMenu = () => {
        document.getElementById('main_side_menu').classList.remove('active');
        document.getElementById('panel_overlay_elem').classList.remove('active');
    };
    
    window.displayModal = (content, showClose = true) => {
        const modal = document.getElementById('generic_modal');
        document.getElementById('modal_body_content').innerHTML = content;
        document.getElementById('modal_close_btn').style.display = showClose ? 'block' : 'none';
        modal.style.pointerEvents = 'auto'; modal.style.opacity = '1';
        document.getElementById('modal_container').classList.remove('scale-95');
        document.getElementById('modal_container').classList.add('scale-100');
        lucide.createIcons();
    };

    window.hideModal = () => {
         const modal = document.getElementById('generic_modal');
         modal.style.opacity = '0'; modal.style.pointerEvents = 'none';
         document.getElementById('modal_container').classList.add('scale-95');
         document.getElementById('modal_container').classList.remove('scale-100');
    };
    window.showMessage = (msg, type='info') => {
         if(window.Telegram?.WebApp?.showPopup) { window.Telegram.WebApp.showAlert(msg); }
         else { alert(msg); }
    };
    window.copyToClipboard = (text) => { navigator.clipboard.writeText(text); showMessage("Copied to clipboard!"); };
    window.copyAddress = (addr, name) => { copyToClipboard(addr); showMessage(`${name} address copied!`); };
    
    function displayMethodSelector(inputId, textId, title, choices) {
        let choicesHTML = choices.map(opt =>
            `<button data-value="${opt.value}" class="option-button card_ui w-full p-3 rounded-lg text-left hover:bg-slate-700 transition">${opt.text}</button>`
        ).join('');

        const modalContent = `
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-center mb-4">${title}</h3>
                ${choicesHTML}
            </div>
        `;
        displayModal(modalContent);

        document.querySelectorAll('.option-button').forEach(btn => {
            btn.onclick = () => {
                const val = btn.dataset.value;
                const text = btn.textContent;
                document.getElementById(inputId).value = val;
                const textElem = document.getElementById(textId);
                textElem.textContent = text;
                textElem.parentElement.classList.remove('text-slate-400');
                textElem.parentElement.classList.add('text-white');
                hideModal();
            };
        });
    }

    async function processP2PTransfer() {
        const recipient = document.getElementById('p2p_recipient_uid').value.trim();
        const amount = parseFloat(document.getElementById('p2p_transfer_amount').value);
        const btn = document.getElementById('p2p_confirm_btn');

        if (!recipient || !amount) return showMessage("Please enter UID and amount.", "warning");
        if (recipient === userState.tgChatId) return showMessage("You cannot transfer to yourself.", "error");
        if (amount < configMinP2P) return showMessage(`Minimum transfer amount is $${configMinP2P.toFixed(2)}.`, "warning");
        
        let feeRate = configP2PFee;
        const isExpired = userState.premiumExpiry && userState.premiumExpiry.toDate() < new Date();
        if (userState.isPremium && !isExpired && premiumPlans[userState.premiumTier]?.benefits.feeReduction > 0) {
            feeRate -= premiumPlans[userState.premiumTier].benefits.feeReduction;
        }
        const fee = amount * feeRate;
        const total = amount + fee;

        if (userState.balance < total) return showMessage(`Insufficient balance. You need $${total.toFixed(2)}.`, "error");

        btn.disabled = true; btn.textContent = 'PROCESSING...';
        try {
            await runTransaction(fbDb, async (transaction) => {
                const senderDocRef = doc(fbDb, "users", userState.tgChatId);
                const recipientDocRef = doc(fbDb, "users", recipient);

                const [senderDoc, recipientDoc] = await Promise.all([
                    transaction.get(senderDocRef),
                    transaction.get(recipientDocRef)
                ]);

                if (!senderDoc.exists()) throw new Error("Your user data could not be found.");
                if (!recipientDoc.exists()) throw new Error("Recipient User ID not found.");
                
                const senderData = senderDoc.data();
                if (senderData.balance < total) throw new Error("Insufficient balance for this transaction.");

                transaction.update(senderDocRef, { balance: senderData.balance - total });
                transaction.update(recipientDocRef, { balance: recipientDoc.data().balance + amount });

                const logDocRef = doc(collection(fbDb, "p2p_logs"));
                transaction.set(logDocRef, {
                    fromId: userState.tgChatId, fromName: userState.name,
                    toId: recipient, toName: recipientDoc.data().name || 'N/A',
                    amount: amount, fee: fee, status: "completed", createdAt: serverTimestamp()
                });
            });

            displayModal(`<div class="text-center space-y-3"><i data-lucide="check-circle" class="w-12 h-12 text-emerald-500 mx-auto"></i><h3 class="text-lg font-bold text-white">Transfer Successful!</h3><p class="text-slate-400">Successfully sent $${amount} to UID ${recipient}.</p><button onclick="hideModal(); switchPanel('panel_features');" class="primary_btn w-full py-2 rounded-xl">OK</button></div>`);
            document.getElementById('p2p_recipient_uid').value = '';
            document.getElementById('p2p_transfer_amount').value = '';
        } catch (e) {
            showMessage("Transfer failed: " + e.message, "error");
        } finally {
            btn.disabled = false; btn.textContent = 'CONFIRM TRANSFER';
            lucide.createIcons();
        }
    }

    function initializeUIHandlers() {
        document.querySelectorAll('.nav_item').forEach(item => {
            item.addEventListener('click', () => switchPanel(item.dataset.target));
        });
        document.getElementById('menu_btn').addEventListener('click', () => {
            document.getElementById('main_side_menu').classList.add('active');
            document.getElementById('panel_overlay_elem').classList.add('active');
        });
        document.getElementById('panel_overlay_elem').addEventListener('click', closeSideMenu);
        document.getElementById('notification_btn').addEventListener('click', renderNotifications);
        document.getElementById('modal_close_btn').addEventListener('click', hideModal);
        document.getElementById('modal_overlay').addEventListener('click', hideModal);
        document.getElementById('copy_uid_btn').addEventListener('click', () => copyToClipboard(userState.tgChatId));
        document.getElementById('p2p_confirm_btn').addEventListener('click', processP2PTransfer);
        
        const verifyRefBtn = document.getElementById('verify_ref_btn');
        if (verifyRefBtn) {
            verifyRefBtn.addEventListener('click', processReferralCode);
        }

        document.getElementById('deposit_method_btn').addEventListener('click', () => {
            const choices = [
                { value: 'USDT', text: 'USDT (TRC20)' },
                { value: 'BTC', text: 'BTC' },
                { value: 'Binance', text: 'Binance Pay' }
            ];
            displayMethodSelector('deposit_method_input', 'deposit_method_label', 'Select Payment Method', choices);
        });

        document.getElementById('withdrawal_method_btn').addEventListener('click', () => {
            const choices = [
                { value: 'USDT', text: 'USDT (TRC20)' },
                { value: 'BTC', text: 'BTC' },
                { value: 'Binance', text: 'Binance Pay ID' }
            ];
            displayMethodSelector('withdrawal_method_input', 'withdrawal_method_label', 'Select Withdrawal Method', choices);
        });

        document.getElementById('p2p_transfer_amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            let feeRate = configP2PFee;
            const isExpired = userState.premiumExpiry && userState.premiumExpiry.toDate() < new Date();
             if (userState.isPremium && !isExpired && premiumPlans[userState.premiumTier]?.benefits.feeReduction > 0) {
                feeRate -= premiumPlans[userState.premiumTier].benefits.feeReduction;
            }
            const fee = amount * feeRate;
            document.getElementById('p2p_fee_info').textContent = amount > 0 ? `Fee (${(feeRate*100).toFixed(0)}%): $${fee.toFixed(2)}` : '';
        });
    }

    function startRealtimeUpdates() {
         onSnapshot(doc(fbDb, "users", userState.tgChatId), (doc) => {
            if(doc.exists()) {
                const oldState = {...userState};
                const newState = doc.data();
                userState = {...userState, ...newState};
                
                if (oldState.balance !== newState.balance || oldState.isPremium !== newState.isPremium || oldState.premiumTier !== newState.premiumTier) {
                     updateUI();
                }
                if (document.getElementById('panel_tasks').classList.contains('visible')) {
                    renderTaskView();
                }
            }
        });
    }

    async function renderProfileStats() {
        const tasksElem = document.getElementById('task_stat');
        const incomeElem = document.getElementById('income_stat');
        const refsElem = document.getElementById('referral_stat');
    
        tasksElem.textContent = '...';
        incomeElem.textContent = '...';
        refsElem.textContent = '...';
    
        const uid = userState.tgChatId;
    
        try {
            const taskCount = (userState.dailyCompletedTasks && Array.isArray(userState.dailyCompletedTasks)) ? userState.dailyCompletedTasks.length : 0;
            tasksElem.textContent = taskCount;
    
            const taskReward = configTaskReward; 
            const taskEarnings = taskCount * taskReward;
            incomeElem.textContent = `$${taskEarnings.toFixed(2)}`;
    
            const refsQuery = query(collection(fbDb, "users"), where("referredBy", "==", uid));
            const refsSnap = await getDocs(refsQuery);
            refsElem.textContent = refsSnap.size;
    
        } catch (error) {
            console.error("Error loading profile stats:", error);
            tasksElem.textContent = 'Error';
            incomeElem.textContent = 'Error';
            refsElem.textContent = 'Error';
        }
    }

    async function renderActivityFeed() {
        const elem = document.getElementById('activity_feed');
        elem.innerHTML = '<div class="spinner w-6 h-6 border-2 mx-auto"></div>';
        
        let logs = [];

        try {
            const p2pQ = query(collection(fbDb, "p2p_logs"), where("fromId", "==", userState.tgChatId), orderBy("createdAt", "desc"), limit(5));
            const p2pSnap = await getDocs(p2pQ);
            p2pSnap.forEach(d => { if(d.data().createdAt) logs.push({ ...d.data(), type: 'p2p' }); });
        } catch (error) { console.error("Error loading P2P logs:", error); }
        
        logs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        const recent = logs.slice(0, 10);

        if (recent.length === 0) {
            elem.innerHTML = 'No recent activities found.';
            return;
        }

        elem.innerHTML = recent.map(log => {
            const date = log.createdAt.toDate().toLocaleDateString();
            if (log.type === 'p2p') {
                return `<div class="text-left p-2 rounded-lg bg-slate-900/50">
                            <p class="text-slate-300">Sent $${log.amount} to <span class="font-mono">${log.toId}</span></p>
                            <p class="text-slate-500 text-xs">${date}</p>
                        </div>`;
            }
            return '';
        }).join('');
    }

    async function renderNewsFeed() {
        const elem = document.getElementById('news_stream');
        elem.innerHTML = '<div class="flex justify-center p-8"><div class="spinner w-8 h-8 border-2"></div></div>';
        try {
            const q = query(collection(fbDb, "news"), orderBy("createdAt", "desc"), limit(5));
            const snap = await getDocs(q);
            if (snap.empty) {
                elem.innerHTML = '<p class="text-slate-500 text-center">No news available right now.</p>';
                return;
            }
            elem.innerHTML = snap.docs.map(doc => {
                const news = doc.data();
                const date = news.createdAt.toDate().toLocaleString();
                return `
                <div class="card_ui p-4 rounded-2xl">
                    ${news.imageUrl ? `<img src="${news.imageUrl}" class="w-full h-40 object-cover rounded-xl mb-3" alt="news">` : ''}
                    <h3 class="font-bold text-lg text-slate-200">${news.title}</h3>
                    <p class="text-slate-400 text-sm mt-2">${news.content}</p>
                    <p class="text-xs text-slate-600 mt-3">${date}</p>
                </div>`;
            }).join('');
        } catch (error) {
            console.error("Error loading news:", error);
            elem.innerHTML = '<p class="text-red-500 text-center">Could not load news feed.</p>';
        }
    }
</script>

</body>
</html>
